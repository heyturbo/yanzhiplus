<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èµ›åšå°–å«ä»ª - é‡Šæ”¾ä½ çš„å‹åŠ›</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        body {
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f0f0;
            color: #333;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s;
            touch-action: manipulation;
        }
        
        .container {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
            position: absolute;
            top: 10%;
            transition: transform 0.3s, color 0.3s, text-shadow 0.3s;
        }
        
        .scream-button {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            box-shadow: 8px 8px 16px #d1d1d1, -8px -8px 16px #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
            position: relative;
            overflow: hidden;
            will-change: transform, box-shadow;
        }
        
        .scream-button:active {
            transform: scale(0.95);
            box-shadow: 4px 4px 8px #d1d1d1, -4px -4px 8px #ffffff;
        }
        
        .scream-button-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
        }
        
        .scream-icon {
            width: 70%;
            height: 70%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23333' d='M12,3C17.5,3 22,6.58 22,11C22,15.42 17.5,19 12,19C10.76,19 9.57,18.82 8.47,18.5C5.55,21 2,21 2,21C4.33,18.67 4.7,17.1 4.75,16.5C3.05,15.07 2,13.13 2,11C2,6.58 6.5,3 12,3M11,14V16H13V14H11M11,12H13V6H11V12Z'/%3E%3C/svg%3E");
            background-position: center;
            background-repeat: no-repeat;
            transition: opacity 0.3s, transform 0.3s;
            will-change: transform;
        }
        
        .intensity-meter {
            width: 80%;
            height: 20px;
            background-color: #ddd;
            border-radius: 10px;
            margin-top: 40px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .intensity-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #4CAF50, #FFEB3B, #FF5722);
            border-radius: 10px;
            transition: width 0.2s;
            will-change: width;
            position: relative;
            overflow: hidden;
        }
        
        .intensity-fill:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg, 
                rgba(255,255,255,0.1) 0%, 
                rgba(255,255,255,0.3) 50%, 
                rgba(255,255,255,0.1) 100%
            );
            transform: translateX(-100%);
            animation: shineEffect 2s infinite;
        }
        
        @keyframes shineEffect {
            to {
                transform: translateX(100%);
            }
        }
        
        .stats {
            margin-top: 20px;
            text-align: center;
            font-size: 16px;
            display: flex;
            justify-content: space-around;
            width: 80%;
        }
        
        .stat-box {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            will-change: transform;
        }
        
        .stat-box:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .particles-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }
        
        .particle {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            pointer-events: none;
            will-change: transform, opacity;
        }
        
        .instructions {
            position: absolute;
            bottom: 5%;
            text-align: center;
            font-size: 14px;
            color: #666;
            max-width: 300px;
            line-height: 1.4;
            transition: opacity 0.5s;
        }
        
        .emotion-indicator {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            top: 65%;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
        }
        
        .emotion-emoji {
            position: absolute;
            font-size: 24px;
            opacity: 0;
            transform: scale(0.5);
            transition: opacity 0.5s, transform 0.5s;
            pointer-events: none;
        }
        
        .wave-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: -2;
            opacity: 0;
            transition: opacity 0.5s;
            overflow: hidden;
        }
        
        .wave {
            position: absolute;
            border: 2px solid rgba(255, 165, 0, 0.5);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            opacity: 1;
            will-change: transform, opacity;
        }
        
        .achievement-container {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            padding: 10px;
            max-width: 300px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transform: translateX(110%);
            transition: transform 0.3s;
            z-index: 10;
            -webkit-overflow-scrolling: touch;
        }
        
        .achievement-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            z-index: 11;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .achievement-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .achievement-icon {
            width: 24px;
            height: 24px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23333' d='M20,2H4V4L9.81,8.36C6.14,9.57 4.14,13.53 5.35,17.2C6.56,20.87 10.5,22.87 14.19,21.66C17.86,20.45 19.86,16.5 18.65,12.82C17.95,10.71 16.3,9.05 14.19,8.36L20,4V2M14.94,19.5L12,17.78L9.06,19.5L9.84,16.17L7.25,13.93L10.66,13.64L12,10.5L13.34,13.64L16.75,13.93L14.16,16.17L14.94,19.5Z'/%3E%3C/svg%3E");
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .achievement-list {
            list-style-type: none;
        }
        
        .achievement-item {
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            background-color: #f0f0f0;
            opacity: 0.5;
            transition: opacity 0.3s, transform 0.3s, background-color 0.3s;
        }
        
        .achievement-item.unlocked {
            background-color: #e8f5e9;
            opacity: 1;
        }
        
        .achievement-item.unlocked:hover {
            transform: translateX(5px);
            background-color: #c8e6c9;
        }
        
        .achievement-name {
            font-weight: bold;
        }
        
        .achievement-description {
            font-size: 12px;
            color: #666;
        }
        
        /* éŸ³æ³¢æ•ˆæœ */
        .sound-waves {
            position: absolute;
            width: 100%;
            height: 50px;
            bottom: 30%;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .sound-wave {
            width: 4px;
            height: 20px;
            background-color: rgba(255, 255, 255, 0.7);
            margin: 0 2px;
            border-radius: 2px;
            transition: height 0.1s;
            will-change: height;
        }
        
        /* åŠ ç‰¹æ•ˆæ¨¡å¼ */
        .fx-mode-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            padding: 8px 12px;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            z-index: 10;
            transition: transform 0.3s, box-shadow 0.3s, background-color 0.3s;
        }
        
        .fx-mode-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .fx-mode-toggle.active {
            background-color: rgba(255, 193, 7, 0.8);
        }
        
        /* æç¤ºæµ®å±‚ */
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            z-index: 20;
            transform: translateY(10px);
        }
        
        .tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* æ¨¡å¼å¼€å…³ */
        .mode-indicator {
            position: absolute;
            top: 70px;
            left: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            opacity: 0;
            transform: translateX(-100%);
            transition: transform 0.3s, opacity 0.3s;
            z-index: 10;
        }
        
        .mode-indicator.active {
            opacity: 1;
            transform: translateX(0);
        }
        
        .mode-indicator:before {
            content: '';
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .mode-indicator.calm:before {
            background-color: #4CAF50;
        }
        
        .mode-indicator.release:before {
            background-color: #FF9800;
        }
        
        .mode-indicator.fury:before {
            background-color: #F44336;
        }
        
        /* æ–°å¢ï¼šæƒ…ç»ªè®°å½•åŠŸèƒ½ */
        .emotion-history-toggle {
            position: absolute;
            top: 20px;
            left: 80px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            padding: 8px 12px;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            z-index: 10;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .emotion-history-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .emotion-history-container {
            position: absolute;
            top: 70px;
            left: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 5px;
            padding: 15px;
            max-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transform: translateX(-110%);
            transition: transform 0.3s;
            z-index: 10;
            -webkit-overflow-scrolling: touch;
        }
        
        .emotion-history-container.active {
            transform: translateX(0);
        }
        
        .emotion-chart {
            width: 100%;
            height: 150px;
            margin-top: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            position: relative;
        }
        
        .emotion-chart-bar {
            position: absolute;
            bottom: 0;
            width: 8px;
            background: linear-gradient(to top, #4CAF50, #FFEB3B, #FF5722);
            border-radius: 2px 2px 0 0;
            transition: height 0.5s;
        }
        
        .emotion-chart-date {
            position: absolute;
            bottom: -20px;
            font-size: 10px;
            color: #666;
            transform: rotate(-45deg);
            transform-origin: top left;
            white-space: nowrap;
        }
        
        .emotion-history-entry {
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            background-color: #f0f0f0;
            font-size: 12px;
        }
        
        .emotion-history-date {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .emotion-history-intensity {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            color: white;
            font-size: 10px;
            margin-left: 5px;
        }
        
        /* æ–°å¢ï¼šå‹åŠ›å®¹å™¨æ•ˆæœ */
        .pressure-container {
            position: absolute;
            width: 220px;
            height: 220px;
            border-radius: 50%;
            background: radial-gradient(circle, transparent 90%, rgba(255,0,0,0.2) 100%);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            pointer-events: none;
            z-index: -1;
        }
        
        /* æ–°å¢ï¼šæƒ…ç»ªçˆ†å‘åŠ¨ç”» */
        .emotion-burst {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 100;
            opacity: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s;
        }
        
        .emotion-burst-text {
            font-size: 5rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 20px rgba(0,0,0,0.5);
            transform: scale(0.5);
            opacity: 0;
            transition: transform 0.5s, opacity 0.5s;
        }
        
        /* æ–°å¢ï¼šéŸ³é¢‘å¯è§†åŒ– */
        .audio-visualizer {
            position: absolute;
            width: 100%;
            height: 80px;
            bottom: 20%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .audio-bar {
            width: 6px;
            height: 5px;
            margin: 0 2px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 2px 2px 0 0;
            transition: height 0.1s;
        }
        
        /* æ–°å¢ï¼šå¤©æ°”æƒ…ç»ªåˆ‡æ¢ */
        .weather-toggle {
            position: absolute;
            top: 70px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            padding: 8px 12px;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            z-index: 10;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: center;
        }
        
        .weather-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .weather-icon {
            width: 20px;
            height: 20px;
            margin-right: 5px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .weather-rain {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: -3;
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        .rain-drop {
            position: absolute;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0.7));
            width: 2px;
            border-radius: 0 0 5px 5px;
            pointer-events: none;
        }
        
        .confetti-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: -3;
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            pointer-events: none;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 480px) {
            .scream-button {
                width: 160px;
                height: 160px;
            }
            
            .pressure-container {
                width: 180px;
                height: 180px;
            }
            
            .title {
                font-size: 20px;
                top: 5%;
            }
            
            .stats {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
            
            .stat-box {
                width: 100%;
                max-width: 200px;
            }
            
            .intensity-meter {
                margin-top: 30px;
                width: 90%;
            }
            
            .achievement-toggle, .emotion-history-toggle {
                top: 10px;
                width: 30px;
                height: 30px;
                padding: 0;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            
            .achievement-toggle {
                right: 10px;
            }
            
            .emotion-history-toggle {
                left: 10px;
                top: 50px;
                padding: 10px;
                width: 20%;
                position: absolute;
            }
            
            .achievement-icon {
                width: 18px;
                height: 18px;
            }
            
            .fx-mode-toggle {
                top: 10px;
                left: 10px;
                font-size: 12px;
                padding: 6px 10px;
            }
            
            .weather-toggle {
                top: 50px;
                right: 10px;
                font-size: 12px;
                padding: 6px 10px;
            }
            
            .mode-indicator {
                top: 50px;
                left: 10px;
                font-size: 12px;
                padding: 6px 12px;
            }
            
            .sound-waves {
                bottom: 25%;
            }
            
            .audio-visualizer {
                bottom: 18%;
                height: 60px;
            }
            
            .instructions {
                font-size: 12px;
                max-width: 280px;
                bottom: 3%;
            }
            
            .emotion-burst-text {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">èµ›åšå°–å«ä»ª</h1>
        
        <div class="pressure-container" id="pressureContainer"></div>
        
        <div class="scream-button" id="screamButton">
            <div class="scream-icon"></div>
            <div class="scream-button-pulse" id="screamButtonPulse"></div>
        </div>
        
        <div class="intensity-meter">
            <div class="intensity-fill" id="intensityFill"></div>
        </div>
        
        <div class="emotion-indicator" id="emotionIndicator"></div>
        
        <div class="sound-waves" id="soundWaves">
            <!-- å°†åœ¨JSä¸­åŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div class="audio-visualizer" id="audioVisualizer">
            <!-- å°†åœ¨JSä¸­åŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div class="stats">
            <div class="stat-box">
                å°–å«å¼ºåº¦: <span id="intensityValue">0</span>%
            </div>
            <div class="stat-box">
                æ€»é‡Šæ”¾å€¼: <span id="totalRelease">0</span>
            </div>
        </div>
        
        <div class="instructions" id="instructions">
            <p>é•¿æŒ‰æˆ–å¿«é€Ÿç‚¹å‡»å°–å«æŒ‰é’®æ¥é‡Šæ”¾ä½ çš„å‹åŠ›ã€‚å°–å«å¼ºåº¦è¶Šé«˜ï¼Œæ•ˆæœè¶Šæ˜æ˜¾ï¼</p>
            <p>æ¡ä»¶å…è®¸å¯ä»¥å¯»æ‰¾ä¸€ä¸ªèƒ½æ”¾å¿ƒå°–å«çš„åœºæ‰€ï¼Œä¸€è¾¹å°–å«ä¸€è¾¹ä½¿ç”¨æ­¤ä»ªå™¨æµ‹é‡ä½ çš„æƒ…ç»ªé‡Šæ”¾ï¼</p>
        </div>
        
        <div class="particles-container" id="particlesContainer"></div>
        <div class="wave-container" id="waveContainer"></div>
        <div class="weather-rain" id="weatherRain"></div>
        <div class="confetti-container" id="confettiContainer"></div>
        
        <div class="achievement-toggle" id="achievementToggle">
            <div class="achievement-icon"></div>
        </div>
        
        <div class="achievement-container" id="achievementContainer">
            <h3 style="margin-bottom: 10px;">è§£é”æˆå°±</h3>
            <ul class="achievement-list" id="achievementList">
                <!-- å°†åœ¨JSä¸­åŠ¨æ€ç”Ÿæˆ -->
            </ul>
        </div>
        
        <div class="fx-mode-toggle" id="fxModeToggle">ç‰¹æ•ˆæ¨¡å¼</div>
        
        <div class="emotion-history-toggle" id="emotionHistoryToggle">æƒ…ç»ªè®°å½•</div>
        
        <div class="emotion-history-container" id="emotionHistoryContainer">
            <h3 style="margin-bottom: 10px;">æƒ…ç»ªå†å²</h3>
            <div class="emotion-chart" id="emotionChart">
                <!-- å°†åœ¨JSä¸­åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div style="margin-top: 25px;">
                <h4 style="margin-bottom: 5px;">è¿‘æœŸè®°å½•</h4>
                <div id="emotionHistoryList">
                    <!-- å°†åœ¨JSä¸­åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <div class="weather-toggle" id="weatherToggle">
            <div class="weather-icon" id="weatherIcon"></div>
            <span>æƒ…ç»ªå¤©æ°”</span>
        </div>
        
        <div class="mode-indicator calm" id="modeIndicator">å¹³é™æ¨¡å¼</div>
        
        <div class="tooltip" id="tooltip"></div>
        
        <div class="emotion-burst" id="emotionBurst">
            <div class="emotion-burst-text" id="emotionBurstText"></div>
        </div>
    </div>

    <script>
        // æ¸¸æˆä¸»è¦å˜é‡
        let isPressed = false;
        let intensity = 0;
        let totalRelease = 0;
        let particleInterval;
        let shakingTimeout;
        let fxMode = false;
        let currentMode = 'calm'; // calm, release, fury
        let lastFrameTime = 0;
        let activeParticles = []; // è·Ÿè¸ªæ´»åŠ¨ç²’å­
        let visibleParticlesCount = 0; // å¯è§ç²’å­è®¡æ•°
        const MAX_PARTICLES = 100; // æœ€å¤§ç²’å­æ•°é‡é™åˆ¶
        let emotionHistory = []; // æƒ…ç»ªå†å²è®°å½•
        let currentWeather = 'none'; // å½“å‰æƒ…ç»ªå¤©æ°”
        let lastEmotionSave = 0; // ä¸Šæ¬¡æƒ…ç»ªä¿å­˜æ—¶é—´
        let userPersonality = {}; // ç”¨æˆ·æƒ…ç»ªä¸ªæ€§è®¾ç½®
        let emotionReleasePatterns = []; // æƒ…ç»ªé‡Šæ”¾æ¨¡å¼
        let comboCount = 0; // è¿å‡»æ¬¡æ•°
        let lastClickTime = 0; // ä¸Šæ¬¡ç‚¹å‡»æ—¶é—´
        
        // è¡¨æƒ…ç¬¦å·åº“
        const emojis = {
            calm: ['ğŸ˜Œ', 'ğŸ˜Š', 'ğŸ™‚'],
            slight: ['ğŸ˜', 'ğŸ™„', 'ğŸ˜‘'],
            medium: ['ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜£'],
            high: ['ğŸ˜¡', 'ğŸ˜¤', 'ğŸ˜«'],
            extreme: ['ğŸ¤¬', 'ğŸ˜±', 'ğŸ˜µ'],
            release: ['ğŸ˜®â€ğŸ’¨', 'ğŸ˜Œ', 'ğŸ˜'],
            joy: ['ğŸ˜„', 'ğŸ˜', 'ğŸ¥³']
        };
        
        // æƒ…ç»ªçˆ†å‘çŸ­è¯­
        const burstPhrases = [
            "é‡Šæ”¾!",
            "ç—›å¿«!",
            "èˆ’ç•…!",
            "è‡ªç”±äº†!",
            "çˆ†å‘!",
            "è§£è„±äº†!",
            "ç•…å¿«!"
        ];
        
        // DOMå…ƒç´ 
        const screamButton = document.getElementById('screamButton');
        const screamButtonPulse = document.getElementById('screamButtonPulse');
        const intensityFill = document.getElementById('intensityFill');
        const intensityValue = document.getElementById('intensityValue');
        const totalReleaseElement = document.getElementById('totalRelease');
        const particlesContainer = document.getElementById('particlesContainer');
        const waveContainer = document.getElementById('waveContainer');
        const emotionIndicator = document.getElementById('emotionIndicator');
        const title = document.querySelector('.title');
        const body = document.body;
        const achievementToggle = document.getElementById('achievementToggle');
        const achievementContainer = document.getElementById('achievementContainer');
        const achievementList = document.getElementById('achievementList');
        const soundWaves = document.getElementById('soundWaves');
        const fxModeToggle = document.getElementById('fxModeToggle');
        const modeIndicator = document.getElementById('modeIndicator');
        const tooltip = document.getElementById('tooltip');
        const emotionHistoryToggle = document.getElementById('emotionHistoryToggle');
        const emotionHistoryContainer = document.getElementById('emotionHistoryContainer');
        const emotionChart = document.getElementById('emotionChart');
        const emotionHistoryList = document.getElementById('emotionHistoryList');
        const weatherToggle = document.getElementById('weatherToggle');
        const weatherIcon = document.getElementById('weatherIcon');
        const weatherRain = document.getElementById('weatherRain');
        const confettiContainer = document.getElementById('confettiContainer');
        const audioVisualizer = document.getElementById('audioVisualizer');
        const pressureContainer = document.getElementById('pressureContainer');
        const instructions = document.getElementById('instructions');
        const emotionBurst = document.getElementById('emotionBurst');
        const emotionBurstText = document.getElementById('emotionBurstText');
        
        // æ£€æµ‹è®¾å¤‡æ€§èƒ½
        const isLowPerformanceDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) && 
            (navigator.hardwareConcurrency < 4 || !navigator.deviceMemory || navigator.deviceMemory < 4);
        
        // æ ¹æ®è®¾å¤‡æ€§èƒ½è°ƒæ•´å‚æ•°
        const PARTICLE_LIMIT = isLowPerformanceDevice ? 30 : MAX_PARTICLES;
        const USE_COMPLEX_EFFECTS = !isLowPerformanceDevice;
        
        // åˆå§‹åŒ–å£°æ³¢å…ƒç´  - ä½æ€§èƒ½è®¾å¤‡å‡å°‘æ•°é‡
        const waveCount = isLowPerformanceDevice ? 9 : 15;
        for (let i = 0; i < waveCount; i++) {
            const wave = document.createElement('div');
            wave.classList.add('sound-wave');
            soundWaves.appendChild(wave);
        }
        const soundWaveElements = document.querySelectorAll('.sound-wave');
        
        // åˆå§‹åŒ–éŸ³é¢‘å¯è§†åŒ–å…ƒç´ 
        const visualizerCount = isLowPerformanceDevice ? 15 : 30;
        for (let i = 0; i < visualizerCount; i++) {
            const bar = document.createElement('div');
            bar.classList.add('audio-bar');
            audioVisualizer.appendChild(bar);
        }
        const audioBarElements = document.querySelectorAll('.audio-bar');
        
        // æƒ…ç»ªæ ‡ç­¾
        const emotions = [
            { threshold: 0, text: "å¹³é™", color: "#4CAF50", emoji: emojis.calm },
            { threshold: 20, text: "äº›è®¸çƒ¦èº", color: "#8BC34A", emoji: emojis.slight },
            { threshold: 40, text: "å‹åŠ›ç¼“è§£ä¸­", color: "#CDDC39", emoji: emojis.medium },
            { threshold: 60, text: "ç”¨åŠ›å®£æ³„!", color: "#FFC107", emoji: emojis.high },
            { threshold: 80, text: "å°½æƒ…é‡Šæ”¾!!", color: "#FF9800", emoji: emojis.extreme },
            { threshold: 95, text: "çˆ†å‘!!!!", color: "#FF5722", emoji: emojis.extreme },
            { threshold: 100, text: "å®Œå…¨é‡Šæ”¾!", color: "#E91E63", emoji: emojis.release }
        ];
        
        // æˆå°±ç³»ç»Ÿ
        const achievements = [
            { id: 'first-scream', threshold: 1, name: 'åˆæ¬¡å°–å«', description: 'å®Œæˆä½ çš„ç¬¬ä¸€æ¬¡å°–å«' },
            { id: 'stress-relief', threshold: 100, name: 'å‹åŠ›ç¼“è§£', description: 'ç´¯è®¡é‡Šæ”¾å€¼è¾¾åˆ°100' },
            { id: 'scream-master', threshold: 500, name: 'å°–å«å¤§å¸ˆ', description: 'ç´¯è®¡é‡Šæ”¾å€¼è¾¾åˆ°500' },
            { id: 'therapy-session', threshold: 1000, name: 'å¿ƒç†æ²»ç–—', description: 'ç´¯è®¡é‡Šæ”¾å€¼è¾¾åˆ°1000' },
            { id: 'zen-mode', threshold: 2000, name: 'ç¦…æ„äººç”Ÿ', description: 'ç´¯è®¡é‡Šæ”¾å€¼è¾¾åˆ°2000' },
            { id: 'rapid-fire', type: 'click', count: 10, name: 'æ€¥é€Ÿç‚¹å‡»', description: 'å¿«é€Ÿè¿ç»­ç‚¹å‡»10æ¬¡' },
            { id: 'endurance', type: 'duration', seconds: 5, name: 'æŒä¹…å°–å«', description: 'æŒç»­å°–å«5ç§’é’Ÿ' },
            { id: 'max-intensity', type: 'intensity', level: 100, name: 'å¼ºåŠ›å®£æ³„', description: 'è¾¾åˆ°100%å°–å«å¼ºåº¦' },
            { id: 'mode-master', type: 'special', condition: 'allModes', name: 'æ¨¡å¼æŒæ§è€…', description: 'ä½“éªŒæ‰€æœ‰å°–å«æ¨¡å¼' },
            // æ–°å¢æˆå°±
            { id: 'combo-master', type: 'combo', count: 15, name: 'è¿å‡»å¤§å¸ˆ', description: 'è¾¾æˆ15æ¬¡è¿ç»­ç‚¹å‡»' },
            { id: 'emotion-analyst', type: 'history', count: 5, name: 'æƒ…ç»ªåˆ†æå¸ˆ', description: 'è®°å½•5æ¬¡æƒ…ç»ªå†å²' },
            { id: 'weather-explorer', type: 'weather', count: 3, name: 'æƒ…ç»ªæ°”è±¡å‘˜', description: 'ä½“éªŒæ‰€æœ‰æƒ…ç»ªå¤©æ°”' },
            { id: 'total-explosion', type: 'burst', count: 3, name: 'å½»åº•çˆ†å‘', description: 'è§¦å‘3æ¬¡æƒ…ç»ªçˆ†å‘' },
            { id: 'catharsis', type: 'special', condition: 'perfectRelease', name: 'å¿ƒçµå‡€åŒ–', description: 'åœ¨ä¸€æ¬¡å°–å«ä¸­å®Œç¾é‡Šæ”¾å‹åŠ›' }
        ];
        
        // å¤©æ°”ç±»å‹
        const weatherTypes = [
            { id: 'none', name: 'æ™´æœ—', icon: 'â˜€ï¸', description: 'å¹³é™çš„æƒ…ç»ªçŠ¶æ€' },
            { id: 'rain', name: 'å°é›¨', icon: 'ğŸŒ§ï¸', description: 'è½»å¾®çš„æƒ…ç»ªèµ·ä¼' },
            { id: 'thunder', name: 'é›·æš´', icon: 'â›ˆï¸', description: 'å¼ºçƒˆçš„æƒ…ç»ªæ³¢åŠ¨' },
            { id: 'rainbow', name: 'å½©è™¹', icon: 'ğŸŒˆ', description: 'é‡Šæ”¾åçš„æ„‰æ‚¦æ„Ÿ' }
        ];
        
        // åˆå§‹åŒ–æˆå°±åˆ—è¡¨
        initAchievements();
        
        // åˆå§‹åŒ–æƒ…ç»ªå†å²
        loadEmotionHistory();
        updateEmotionChart();
        
        // ä¸»æ¸¸æˆå¾ªç¯
        function gameLoop(timestamp) {
            if (!lastFrameTime) lastFrameTime = timestamp;
            const deltaTime = timestamp - lastFrameTime;
            lastFrameTime = timestamp;
            
            // æ›´æ–°æ‰€æœ‰ç²’å­
            updateParticles(deltaTime);
            
            // å¦‚æœæœ‰å£°æ³¢æ˜¾ç¤ºï¼Œæ›´æ–°å£°æ³¢
            if (intensity > 0 && soundWaves.style.opacity > 0) {
                animateSoundWaves();
            }
            
            // å¦‚æœæœ‰éŸ³é¢‘å¯è§†åŒ–ï¼Œæ›´æ–°éŸ³é¢‘æ¡
            if (intensity > 0 && audioVisualizer.style.opacity > 0) {
                animateAudioVisualizer();
            }
            
            // æ›´æ–°å‹åŠ›å®¹å™¨æ•ˆæœ
            updatePressureContainer();
            
            // æ›´æ–°å¤©æ°”æ•ˆæœ
            updateWeatherEffects();
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦è®°å½•æƒ…ç»ª
            checkEmotionRecording();
            
            requestAnimationFrame(gameLoop);
        }
        
        // å¼€å§‹æ¸¸æˆå¾ªç¯
        requestAnimationFrame(gameLoop);
        
        // æŒ‰ä¸‹æŒ‰é’®
        screamButton.addEventListener('mousedown', startScream);
        screamButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startScream();
        });
        
        // æ¾å¼€æŒ‰é’®
        window.addEventListener('mouseup', stopScream);
        window.addEventListener('touchend', stopScream);
        
        // å¿«é€Ÿç‚¹å‡»
        let clickCount = 0;
        let clickTimer;
        screamButton.addEventListener('click', () => {
            const now = Date.now();
            clickCount++;
            clearTimeout(clickTimer);
            
            // æ£€æŸ¥è¿å‡»
            if (now - lastClickTime < 500) {
                comboCount++;
                if (comboCount >= 3) {
                    showComboText(comboCount);
                }
                
                // æ£€æŸ¥è¿å‡»æˆå°±
                const comboAchievement = achievements.find(a => a.type === 'combo');
                if (comboAchievement && comboCount >= comboAchievement.count) {
                    unlockAchievement(comboAchievement);
                }
            } else {
                comboCount = 1;
            }
            lastClickTime = now;
            
            // æ£€æŸ¥å¿«é€Ÿç‚¹å‡»æˆå°±
            checkClickAchievement(clickCount);
            
            clickTimer = setTimeout(() => {
                if (clickCount >= 3) {
                    // å¿«é€Ÿç‚¹å‡»å¢åŠ çˆ†å‘æ€§å°–å«
                    burstScream(clickCount * 10);
                }
                clickCount = 0;
            }, 500);
            
            // æŒ‰é’®è„‰å†²åŠ¨ç”»
            animateButtonPulse();
        });
        
        // æŒ‰é’®è„‰å†²åŠ¨ç”»
        function animateButtonPulse() {
            screamButtonPulse.style.opacity = '0.8';
            screamButtonPulse.style.transform = 'scale(0.8)';
            
            // ä½¿ç”¨CSSåŠ¨ç”»è¿›è¡Œè¿‡æ¸¡
            screamButtonPulse.animate([
                { opacity: 0.8, transform: 'scale(0.8)' },
                { opacity: 0, transform: 'scale(2.0)' }
            ], {
                duration: 700,
                easing: 'ease-out'
            }).onfinish = () => {
                screamButtonPulse.style.opacity = '0';
                screamButtonPulse.style.transform = 'scale(0.8)';
            };
        }
        
        // æ˜¾ç¤ºè¿å‡»æ–‡æœ¬
        function showComboText(count) {
            const comboText = document.createElement('div');
            comboText.style.position = 'absolute';
            comboText.style.top = '50%';
            comboText.style.left = '50%';
            comboText.style.transform = 'translate(-50%, -50%)';
            comboText.style.color = count >= 10 ? '#FF5722' : (count >= 5 ? '#FF9800' : '#4CAF50');
            comboText.style.fontWeight = 'bold';
            comboText.style.fontSize = count >= 10 ? '24px' : '20px';
            comboText.style.textShadow = '0 0 5px rgba(255,255,255,0.7)';
            comboText.style.pointerEvents = 'none';
            comboText.style.zIndex = '50';
            comboText.textContent = `${count}è¿å‡»!`;
            
            document.body.appendChild(comboText);
            
            // åŠ¨ç”»
            comboText.animate([
                { transform: 'translate(-50%, -50%) scale(0.5)', opacity: 0 },
                { transform: 'translate(-50%, -50%) scale(1.2)', opacity: 1, offset: 0.6 },
                { transform: 'translate(-50%, -50%) scale(1)', opacity: 0 }
            ], {
                duration: 1000,
                easing: 'ease-out'
            }).onfinish = () => {
                document.body.removeChild(comboText);
            };
        }
        
        // æˆå°±æŒ‰é’®ç‚¹å‡»
        achievementToggle.addEventListener('click', toggleAchievements);
        
        // æƒ…ç»ªå†å²æŒ‰é’®ç‚¹å‡»
        emotionHistoryToggle.addEventListener('click', toggleEmotionHistory);
        
        // ç‰¹æ•ˆæ¨¡å¼åˆ‡æ¢
        fxModeToggle.addEventListener('click', toggleFxMode);
        
        // å¤©æ°”æ¨¡å¼åˆ‡æ¢
        weatherToggle.addEventListener('click', toggleWeather);
        
        // ç§»åŠ¨è®¾å¤‡ä¼˜åŒ– - å¤„ç†è§¦æ‘¸äº‹ä»¶
        if ('ontouchstart' in window) {
            document.addEventListener('touchmove', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault(); // é˜²æ­¢åŒæŒ‡ç¼©æ”¾
                }
            }, { passive: false });
            
            // å¯ç”¨è§¦æ‘¸åé¦ˆ - åœ¨æ”¯æŒçš„æµè§ˆå™¨ä¸­
            try {
                if (navigator.vibrate) {
                    screamButton.addEventListener('touchstart', () => {
                        navigator.vibrate(20);
                    });
                }
            } catch (e) {
                console.log('Vibration API not supported');
            }
        }
        
        // å·¥å…·æç¤º
        function showTooltip(element, text) {
            // ç§»åŠ¨è®¾å¤‡ä¸Šä¸æ˜¾ç¤ºå·¥å…·æç¤º
            if ('ontouchstart' in window) return;
            
            const rect = element.getBoundingClientRect();
            tooltip.textContent = text;
            tooltip.style.top = `${rect.bottom + 10}px`;
            tooltip.style.left = `${rect.left + rect.width/2 - 60}px`;
            tooltip.classList.add('visible');
            
            setTimeout(() => {
                tooltip.classList.remove('visible');
            }, 2000);
        }
        
        // ä¸ºæŒ‰é’®æ·»åŠ æç¤º
        if (!('ontouchstart' in window)) {
            fxModeToggle.addEventListener('mouseenter', () => {
                showTooltip(fxModeToggle, 'åˆ‡æ¢ä¸åŒçš„å°–å«ç‰¹æ•ˆæ¨¡å¼');
            });
            
            achievementToggle.addEventListener('mouseenter', () => {
                showTooltip(achievementToggle, 'æŸ¥çœ‹ä½ çš„æˆå°±');
            });
            
            emotionHistoryToggle.addEventListener('mouseenter', () => {
                showTooltip(emotionHistoryToggle, 'æŸ¥çœ‹ä½ çš„æƒ…ç»ªå†å²è®°å½•');
            });
            
            weatherToggle.addEventListener('mouseenter', () => {
                showTooltip(weatherToggle, 'åˆ‡æ¢æƒ…ç»ªå¤©æ°”æ•ˆæœ');
            });
        }
        
        function toggleFxMode() {
            fxMode = !fxMode;
            fxModeToggle.textContent = fxMode ? "è¿”å›æ™®é€šæ¨¡å¼" : "ç‰¹æ•ˆæ¨¡å¼";
            fxModeToggle.classList.toggle('active', fxMode);
            
            if (fxMode) {
                showTooltip(fxModeToggle, 'ç‰¹æ•ˆæ¨¡å¼å¯ç”¨ï¼Œå°è¯•ä¸åŒçš„å°–å«æ–¹å¼ï¼');
                // éšæœºé€‰æ‹©ä¸€ç§ç‰¹æ•ˆæ¨¡å¼
                const modes = ['release', 'fury'];
                switchMode(modes[Math.floor(Math.random() * modes.length)]);
                
                // æ˜¾ç¤ºéŸ³é¢‘å¯è§†åŒ–
                audioVisualizer.style.opacity = '1';
            } else {
                switchMode('calm');
                
                // éšè—éŸ³é¢‘å¯è§†åŒ–
                audioVisualizer.style.opacity = '0';
            }
            
            // åé¦ˆéœ‡åŠ¨
            try {
                if (navigator.vibrate) {
                    navigator.vibrate(30);
                }
            } catch (e) {}
            
            // æ·»åŠ åˆ‡æ¢ç‰¹æ•ˆ
            const ripple = document.createElement('div');
            ripple.style.position = 'absolute';
            ripple.style.width = '30px';
            ripple.style.height = '30px';
            ripple.style.borderRadius = '50%';
            ripple.style.backgroundColor = fxMode ? 'rgba(255, 193, 7, 0.5)' : 'rgba(76, 175, 80, 0.5)';
            ripple.style.top = '50%';
            ripple.style.left = '50%';
            ripple.style.transform = 'translate(-50%, -50%)';
            ripple.style.pointerEvents = 'none';
            
            fxModeToggle.appendChild(ripple);
            
            // åŠ¨ç”»
            ripple.animate([
                { transform: 'translate(-50%, -50%) scale(0.3)', opacity: 1 },
                { transform: 'translate(-50%, -50%) scale(3)', opacity: 0 }
            ], {
                duration: 800,
                easing: 'ease-out'
            }).onfinish = () => {
                fxModeToggle.removeChild(ripple);
            };
        }
        
        function toggleEmotionHistory() {
            // åˆ‡æ¢æƒ…ç»ªå†å²å®¹å™¨æ˜¾ç¤ºçŠ¶æ€
            const isVisible = emotionHistoryContainer.classList.contains('active');
            emotionHistoryContainer.classList.toggle('active', !isVisible);
            
            if (!isVisible) {
                // æ›´æ–°æƒ…ç»ªå›¾è¡¨
                updateEmotionChart();
            }
            
            // åé¦ˆéœ‡åŠ¨
            try {
                if (navigator.vibrate) {
                    navigator.vibrate(20);
                }
            } catch (e) {}
        }
        
        function toggleWeather() {
            // å¾ªç¯åˆ‡æ¢å¤©æ°”
            const currentIndex = weatherTypes.findIndex(w => w.id === currentWeather);
            const nextIndex = (currentIndex + 1) % weatherTypes.length;
            setWeather(weatherTypes[nextIndex].id);
            
            // æ£€æŸ¥å¤©æ°”æˆå°±
            const weatherAchievement = achievements.find(a => a.type === 'weather');
            if (weatherAchievement) {
                const usedWeathers = new Set(JSON.parse(localStorage.getItem('usedWeathers') || '[]'));
                usedWeathers.add(weatherTypes[nextIndex].id);
                localStorage.setItem('usedWeathers', JSON.stringify([...usedWeathers]));
                
                if (usedWeathers.size >= weatherAchievement.count) {
                    unlockAchievement(weatherAchievement);
                }
            }
            
            // åé¦ˆéœ‡åŠ¨
            try {
                if (navigator.vibrate) {
                    navigator.vibrate(20);
                }
            } catch (e) {}
        }
        
        function setWeather(weatherId) {
            // è®¾ç½®å½“å‰å¤©æ°”
            currentWeather = weatherId;
            const weather = weatherTypes.find(w => w.id === weatherId);
            
            // æ›´æ–°å›¾æ ‡
            weatherIcon.textContent = weather.icon;
            
            // æ˜¾ç¤ºæç¤º
            showTooltip(weatherToggle, `${weather.name}: ${weather.description}`);
            
            // æ¸…é™¤ä»»ä½•ç°æœ‰çš„å¤©æ°”æ•ˆæœ
            weatherRain.innerHTML = '';
            weatherRain.style.opacity = '0';
            confettiContainer.innerHTML = '';
            confettiContainer.style.opacity = '0';
            
            // æ ¹æ®å¤©æ°”ç±»å‹åˆ›å»ºç‰¹æ•ˆ
            switch (weatherId) {
                case 'rain':
                    createRaindrops();
                    break;
                case 'thunder':
                    createRaindrops(true);
                    break;
                case 'rainbow':
                    createConfetti();
                    break;
            }
        }
        
        function createRaindrops(isThunder = false) {
            weatherRain.style.opacity = '1';
            const dropCount = isLowPerformanceDevice ? 30 : 100;
            
            for (let i = 0; i < dropCount; i++) {
                createRaindrop(isThunder);
            }
        }
        
        function createRaindrop(isThunder = false) {
            const drop = document.createElement('div');
            drop.classList.add('rain-drop');
            
            // éšæœºä½ç½®å’Œé€Ÿåº¦
            const x = Math.random() * 100;
            const delay = Math.random() * 5;
            const duration = 0.5 + Math.random() * 1.5;
            const height = 10 + Math.random() * 20;
            
            drop.style.left = `${x}%`;
            drop.style.top = `-${height}px`;
            drop.style.height = `${height}px`;
            drop.style.opacity = isThunder ? '0.9' : '0.6';
            drop.style.animationDelay = `${delay}s`;
            
            weatherRain.appendChild(drop);
            
            // é›¨æ»´åŠ¨ç”»
            drop.animate([
                { transform: 'translateY(0)', opacity: isThunder ? 0.9 : 0.6 },
                { transform: `translateY(${window.innerHeight + height}px)`, opacity: 0 }
            ], {
                duration: duration * 1000,
                iterations: Infinity
            });
            
            // é›·æš´æ•ˆæœ
            if (isThunder && Math.random() < 0.01) {
                createLightning();
            }
        }
        
        function createLightning() {
            // é—ªç”µæ•ˆæœ
            const lightning = document.createElement('div');
            lightning.style.position = 'absolute';
            lightning.style.width = '100%';
            lightning.style.height = '100%';
            lightning.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
            lightning.style.top = '0';
            lightning.style.left = '0';
            lightning.style.pointerEvents = 'none';
            lightning.style.zIndex = '5';
            lightning.style.opacity = '0';
            
            document.body.appendChild(lightning);
            
            // é—ªç”µåŠ¨ç”»
            lightning.animate([
                { opacity: 0 },
                { opacity: 0.7, offset: 0.1 },
                { opacity: 0.1, offset: 0.2 },
                { opacity: 0.7, offset: 0.3 },
                { opacity: 0 }
            ], {
                duration: 700,
                easing: 'ease-out'
            }).onfinish = () => {
                document.body.removeChild(lightning);
            };
            
            // é›·å£°
            try {
                if (navigator.vibrate) {
                    navigator.vibrate([30, 50, 80]);
                }
            } catch (e) {}
        }
        
        function createConfetti() {
            confettiContainer.style.opacity = '1';
            const confettiCount = isLowPerformanceDevice ? 30 : 100;
            
            for (let i = 0; i < confettiCount; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.classList.add('confetti');
                    
                    // éšæœºé¢œè‰²
                    const hue = Math.random() * 360;
                    confetti.style.backgroundColor = `hsl(${hue}, 80%, 60%)`;
                    
                    // éšæœºä½ç½®å’Œé€Ÿåº¦
                    const size = 5 + Math.random() * 10;
                    const x = Math.random() * 100;
                    const delay = Math.random() * 5;
                    const duration = 3 + Math.random() * 3;
                    
                    confetti.style.width = `${size}px`;
                    confetti.style.height = `${size}px`;
                    confetti.style.left = `${x}%`;
                    confetti.style.top = `-${size}px`;
                    
                    confettiContainer.appendChild(confetti);
                    
                    // å½©çº¸åŠ¨ç”»
                    confetti.animate([
                        { 
                            transform: 'translateY(0) rotate(0deg)', 
                            opacity: 0.9 
                        },
                        { 
                            transform: `translateY(${window.innerHeight + size}px) rotate(${720 + Math.random() * 360}deg)`, 
                            opacity: 0 
                        }
                    ], {
                        duration: duration * 1000,
                        easing: 'ease-in',
                        delay: delay * 1000,
                        iterations: Infinity
                    });
                }, Math.random() * 1000);
            }
        }
        
        function updateWeatherEffects() {
            // æ ¹æ®å¼ºåº¦è°ƒæ•´å¤©æ°”æ•ˆæœ
            if (currentWeather === 'thunder' && Math.random() < intensity / 1000) {
                createLightning();
            }
        }
        
        function switchMode(mode) {
            currentMode = mode;
            modeIndicator.className = 'mode-indicator ' + mode;
            
            switch(mode) {
                case 'calm':
                    modeIndicator.textContent = 'å¹³é™æ¨¡å¼';
                    break;
                case 'release':
                    modeIndicator.textContent = 'é‡Šæ”¾æ¨¡å¼';
                    break;
                case 'fury':
                    modeIndicator.textContent = 'ç‹‚æ€’æ¨¡å¼';
                    break;
            }
            
            modeIndicator.classList.add('active');
            setTimeout(() => {
                modeIndicator.classList.remove('active');
            }, 2000);
            
            // æ£€æŸ¥æ˜¯å¦è§£é”äº†æ‰€æœ‰æ¨¡å¼æˆå°±
            const modeAchievement = achievements.find(a => a.type === 'special' && a.condition === 'allModes');
            const allModes = ['calm', 'release', 'fury'];
            const usedModes = new Set(JSON.parse(localStorage.getItem('usedModes') || '[]'));
            usedModes.add(mode);
            localStorage.setItem('usedModes', JSON.stringify([...usedModes]));
            
            if (usedModes.size === allModes.length) {
                unlockAchievement(modeAchievement);
            }
        }
        
        function toggleAchievements() {
            const isVisible = achievementContainer.style.transform === 'translateX(0%)';
            achievementContainer.style.transform = isVisible ? 'translateX(110%)' : 'translateX(0%)';
            
            // åé¦ˆéœ‡åŠ¨
            try {
                if (navigator.vibrate) {
                    navigator.vibrate(20);
                }
            } catch (e) {}
        }
        
        function initAchievements() {
            achievementList.innerHTML = '';
            const unlockedAchievements = JSON.parse(localStorage.getItem('unlockedAchievements') || '[]');
            
            achievements.forEach(achievement => {
                const item = document.createElement('li');
                item.classList.add('achievement-item');
                if (unlockedAchievements.includes(achievement.id)) {
                    item.classList.add('unlocked');
                }
                
                const name = document.createElement('div');
                name.classList.add('achievement-name');
                name.textContent = achievement.name;
                
                const description = document.createElement('div');
                description.classList.add('achievement-description');
                description.textContent = achievement.description;
                
                item.appendChild(name);
                item.appendChild(description);
                achievementList.appendChild(item);
            });
        }
        
        function checkClickAchievement(count) {
            const clickAchievement = achievements.find(a => a.type === 'click');
            if (clickAchievement && count >= clickAchievement.count) {
                unlockAchievement(clickAchievement);
            }
        }
        
        // æŒç»­å°–å«è®¡æ—¶
        let screamStartTime = 0;
        let screamDurationInterval;
        
        function checkDurationAchievement() {
            const durationAchievement = achievements.find(a => a.type === 'duration');
            const duration = (Date.now() - screamStartTime) / 1000;
            
            if (durationAchievement && duration >= durationAchievement.seconds) {
                unlockAchievement(durationAchievement);
                clearInterval(screamDurationInterval);
            }
        }
        
        function startScream() {
            if (isPressed) return;
            isPressed = true;
            
            // æ˜¾ç¤ºå‹åŠ›å®¹å™¨
            pressureContainer.style.opacity = '1';
            
            // è®°å½•å¼€å§‹æ—¶é—´ï¼Œå¹¶è®¾ç½®æŒç»­æ£€æŸ¥
            screamStartTime = Date.now();
            screamDurationInterval = setInterval(checkDurationAchievement, 100);
            
            // æŒç»­å¢åŠ å°–å«å¼ºåº¦
            const intensityInterval = setInterval(() => {
                if (!isPressed) {
                    clearInterval(intensityInterval);
                    return;
                }
                
                // ä¸åŒæ¨¡å¼ä¸‹å¼ºåº¦å¢åŠ é€Ÿåº¦ä¸åŒ
                let intensityIncrease = 1;
                if (currentMode === 'release') intensityIncrease = 1.5;
                if (currentMode === 'fury') intensityIncrease = 2;
                
                increaseIntensity(intensityIncrease);
            }, 50);
            
            // ç”Ÿæˆç²’å­æ•ˆæœ
            particleInterval = setInterval(createParticles, 100);
            
            // æ˜¾ç¤ºå£°æ³¢
            soundWaves.style.opacity = '1';
            
            // ç‰¹æ•ˆæ¨¡å¼ä¸‹æ˜¾ç¤ºéŸ³é¢‘å¯è§†åŒ–
            if (fxMode) {
                audioVisualizer.style.opacity = '1';
            }
            
            // åˆ›å»ºéŸ³æ³¢çº¹æ•ˆæœ
            if (fxMode && USE_COMPLEX_EFFECTS) {
                createWaveEffect();
            }
            
            // æ˜¾ç¤ºæƒ…ç»ªemoji
            if (intensity > 20) {
                showEmotionEmoji();
            }
            
            // è§¦å‘éœ‡åŠ¨åé¦ˆ
            try {
                if (navigator.vibrate) {
                    navigator.vibrate([20, 30, 20]);
                }
            } catch (e) {}
            
            // éšè—è¯´æ˜
            instructions.style.opacity = '0.3';
            
            // æŒ‰é’®çŠ¶æ€æ”¹å˜
            screamButton.style.background = 'linear-gradient(145deg, #f5f5f5, #e0e0e0)';
        }
        
        function stopScream() {
            if (!isPressed) return;
            isPressed = false;
            
            // éšè—å‹åŠ›å®¹å™¨
            pressureContainer.style.opacity = '0';
            
            // æ¸…é™¤æŒç»­æ£€æŸ¥
            clearInterval(screamDurationInterval);
            
            // æ£€æŸ¥å®Œç¾é‡Šæ”¾æˆå°±
            if (intensity >= 95) {
                const perfectReleaseAchievement = achievements.find(a => a.type === 'special' && a.condition === 'perfectRelease');
                if (perfectReleaseAchievement) {
                    unlockAchievement(perfectReleaseAchievement);
                }
                
                // å®Œç¾é‡Šæ”¾æ•ˆæœ
                showPerfectReleaseEffect();
            }
            
            // å¿«é€Ÿé™ä½å°–å«å¼ºåº¦
            const cooldownInterval = setInterval(() => {
                let cooldownRate = 2;
                if (currentMode === 'fury') cooldownRate = 1; // ç‹‚æ€’æ¨¡å¼å†·å´æ…¢
                
                decreaseIntensity(cooldownRate);
                if (intensity <= 0) {
                    clearInterval(cooldownInterval);
                    soundWaves.style.opacity = '0';
                    audioVisualizer.style.opacity = '0';
                    
                    // é‡æ–°æ˜¾ç¤ºè¯´æ˜
                    instructions.style.opacity = '1';
                }
            }, 50);
            
            clearInterval(particleInterval);
            
            // è§¦å‘éœ‡åŠ¨åé¦ˆ
            try {
                if (navigator.vibrate) {
                    navigator.vibrate(10);
                }
            } catch (e) {}
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            screamButton.style.background = 'linear-gradient(145deg, #ffffff, #e6e6e6)';
        }
        
        function showEmotionEmoji() {
            if (visibleParticlesCount >= PARTICLE_LIMIT) return;
            
            // æ ¹æ®å½“å‰å¼ºåº¦é€‰æ‹©æƒ…ç»ª
            let emojiSet = emojis.calm;
            for (let i = emotions.length - 1; i >= 0; i--) {
                if (intensity >= emotions[i].threshold) {
                    emojiSet = emotions[i].emoji;
                    break;
                }
            }
            
            // éšæœºé€‰æ‹©ä¸€ä¸ªè¡¨æƒ…
            const emoji = emojiSet[Math.floor(Math.random() * emojiSet.length)];
            
            // åˆ›å»ºè¡¨æƒ…å…ƒç´ 
            const emojiElem = document.createElement('div');
            emojiElem.classList.add('emotion-emoji');
            emojiElem.textContent = emoji;
            emojiElem.style.fontSize = `${Math.floor(24 + Math.random() * 12)}px`;
            emojiElem.style.position = 'absolute';
            
            // ä»æŒ‰é’®ä½ç½®å‘å°„
            const buttonRect = screamButton.getBoundingClientRect();
            const startX = buttonRect.left + buttonRect.width / 2;
            const startY = buttonRect.top + buttonRect.height / 2;
            
            // éšæœºè§’åº¦
            const angle = Math.random() * Math.PI * 2;
            const distance = 30 + Math.random() * 100;
            const endX = startX + Math.cos(angle) * distance;
            const endY = startY + Math.sin(angle) * distance;
            
            emojiElem.style.left = `${startX}px`;
            emojiElem.style.top = `${startY}px`;
            
            document.body.appendChild(emojiElem);
            
            // åŠ¨ç”»
            emojiElem.style.opacity = '1';
            emojiElem.style.transform = 'scale(1)';
            
            emojiElem.animate([
                { left: `${startX}px`, top: `${startY}px`, transform: 'scale(0.5)', opacity: 0 },
                { left: `${endX}px`, top: `${endY}px`, transform: 'scale(1.2)', opacity: 1, offset: 0.6 },
                { left: `${endX}px`, top: `${endY - 50}px`, transform: 'scale(1)', opacity: 0 }
            ], {
                duration: 1500,
                easing: 'ease-out'
            }).onfinish = () => {
                document.body.removeChild(emojiElem);
            };
        }
        
        function showPerfectReleaseEffect() {
            // ç‰¹æ•ˆï¼šå®Œç¾é‡Šæ”¾
            
            // è®¾ç½®å½©è™¹å¤©æ°”
            setWeather('rainbow');
            
            // å¤§é‡ç²’å­çˆ†å‘
            const burstCount = isLowPerformanceDevice ? 30 : 100;
            for (let i = 0; i < burstCount; i++) {
                setTimeout(() => {
                    const buttonRect = screamButton.getBoundingClientRect();
                    const centerX = buttonRect.left + buttonRect.width / 2;
                    const centerY = buttonRect.top + buttonRect.height / 2;
                    
                    createParticle(centerX, centerY, {
                        backgroundColor: `hsl(${Math.random() * 360}, 80%, 60%)`,
                        size: 8 + Math.random() * 8,
                        speed: 3 + Math.random() * 5,
                        duration: 2000 + Math.random() * 3000
                    });
                }, i * (isLowPerformanceDevice ? 30 : 10));
            }
            
            // æ˜¾ç¤ºå®Œç¾é‡Šæ”¾æ–‡å­—
            showEmotionBurst("å®Œç¾é‡Šæ”¾!", "#E91E63");
            
            // è§¦å‘éœ‡åŠ¨åé¦ˆ
            try {
                if (navigator.vibrate) {
                    const pattern = [];
                    for (let i = 0; i < 5; i++) {
                        pattern.push(30 + i * 10);
                        pattern.push(20);
                    }
                    navigator.vibrate(pattern);
                }
            } catch (e) {}
        }
        
        function showEmotionBurst(text, color) {
            // æ˜¾ç¤ºæƒ…ç»ªçˆ†å‘åŠ¨ç”»
            emotionBurst.style.opacity = '1';
            emotionBurst.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
            emotionBurstText.textContent = text;
            emotionBurstText.style.color = color;
            
            // åŠ¨ç”»
            emotionBurstText.style.transform = 'scale(0.5)';
            emotionBurstText.style.opacity = '0';
            
            setTimeout(() => {
                // æ”¾å¤§åŠ¨ç”»
                emotionBurstText.style.transform = 'scale(1.2)';
                emotionBurstText.style.opacity = '1';
                
                setTimeout(() => {
                    // ç¼©å°æ¶ˆå¤±
                    emotionBurstText.style.transform = 'scale(0.8)';
                    emotionBurstText.style.opacity = '0';
                    
                    setTimeout(() => {
                        emotionBurst.style.opacity = '0';
                        emotionBurst.style.backgroundColor = 'transparent';
                    }, 500);
                }, 1500);
            }, 100);
            
            // æ£€æŸ¥çˆ†å‘æˆå°±
            const burstAchievement = achievements.find(a => a.type === 'burst');
            if (burstAchievement) {
                let burstCount = parseInt(localStorage.getItem('emotionBurstCount') || '0');
                burstCount++;
                localStorage.setItem('emotionBurstCount', burstCount);
                
                if (burstCount >= burstAchievement.count) {
                    unlockAchievement(burstAchievement);
                }
            }
        }
        
        function increaseIntensity(amount) {
            intensity = Math.min(100, intensity + amount);
            updateIntensityDisplay();
            applyIntensityEffects();
            
            // æ£€æŸ¥æœ€å¤§å¼ºåº¦æˆå°±
            if (intensity >= 100) {
                const maxIntensityAchievement = achievements.find(a => a.type === 'intensity');
                if (maxIntensityAchievement) {
                    unlockAchievement(maxIntensityAchievement);
                }
            }
        }
        
        function decreaseIntensity(amount) {
            intensity = Math.max(0, intensity - amount);
            updateIntensityDisplay();
            applyIntensityEffects();
        }
        
        function burstScream(amount) {
            // çˆ†å‘å¼å¢åŠ å¼ºåº¦ï¼ŒåŒæ—¶ç´¯è®¡é‡Šæ”¾å€¼
            increaseIntensity(amount);
            totalRelease += amount * 2;
            totalReleaseElement.textContent = Math.floor(totalRelease);
            
            // åˆ›å»ºå¤§é‡ç²’å­ - ä½æ€§èƒ½è®¾å¤‡é™ä½æ•°é‡
            const particleCount = isLowPerformanceDevice ? Math.min(amount, 15) : amount;
            for (let i = 0; i < particleCount; i++) {
                setTimeout(() => {
                    createParticles(amount / (isLowPerformanceDevice ? 4 : 2));
                }, i * (isLowPerformanceDevice ? 100 : 50));
            }
            
            // å±å¹•éœ‡åŠ¨æ•ˆæœ
            shakeScreen(amount / 10);
            
            // æ˜¾ç¤ºçˆ†å‘æ–‡å­—
            const randomPhrase = burstPhrases[Math.floor(Math.random() * burstPhrases.length)];
            showEmotionBurst(randomPhrase, "#FF5722");
            
            // ç‰¹æ•ˆæ¨¡å¼ä¸‹åˆ›å»ºæ³¢çº¹
            if (fxMode && USE_COMPLEX_EFFECTS) {
                createBurstEffect(amount);
            }
            
            // å¼ºçƒˆéœ‡åŠ¨åé¦ˆ
            try {
                if (navigator.vibrate) {
                    const pattern = [];
                    for (let i = 0; i < 3; i++) {
                        pattern.push(30 + i * 10);
                        pattern.push(20);
                    }
                    navigator.vibrate(pattern);
                }
            } catch (e) {}
        }
        
        function updateIntensityDisplay() {
            intensityFill.style.width = `${intensity}%`;
            intensityValue.textContent = Math.floor(intensity);
            
            // ç´¯è®¡é‡Šæ”¾å€¼
            if (intensity > 0) {
                const releaseIncrement = intensity / 100 * (currentMode === 'fury' ? 2 : 1);
                totalRelease += releaseIncrement;
                totalReleaseElement.textContent = Math.floor(totalRelease);
                
                // ä¿å­˜æ€»é‡Šæ”¾å€¼
                localStorage.setItem('totalRelease', totalRelease.toString());
            }
        }
        
        function updatePressureContainer() {
            if (isPressed) {
                // æ›´æ–°å‹åŠ›å®¹å™¨æ•ˆæœ
                const scale = 1 + (intensity / 300);
                pressureContainer.style.transform = `translate(-50%, -50%) scale(${scale})`;
                
                // æ›´æ–°å‹åŠ›å®¹å™¨é¢œè‰²
                const hue = 360 - (intensity * 3.6); // ä»çº¢è‰²é€æ¸å˜ä¸ºé»„è‰²å†å˜ä¸ºç»¿è‰²
                const saturation = 70 + (intensity / 5);
                const lightness = 50;
                const alpha = 0.1 + (intensity / 200);
                
                pressureContainer.style.background = `radial-gradient(circle, transparent 80%, hsla(${hue}, ${saturation}%, ${lightness}%, ${alpha}) 100%)`;
                
                // æ·»åŠ è„‰å†²æ•ˆæœ
                if (intensity > 70 && Math.random() > 0.9) {
                    const pulse = document.createElement('div');
                    pulse.style.position = 'absolute';
                    pulse.style.width = '100%';
                    pulse.style.height = '100%';
                    pulse.style.borderRadius = '50%';
                    pulse.style.background = `radial-gradient(circle, transparent 80%, hsla(${hue}, ${saturation}%, ${lightness}%, 0.7) 100%)`;
                    pulse.style.top = '0';
                    pulse.style.left = '0';
                    
                    pressureContainer.appendChild(pulse);
                    
                    // åŠ¨ç”»
                    pulse.animate([
                        { transform: 'scale(0.9)', opacity: 0.7 },
                        { transform: 'scale(1.1)', opacity: 0 }
                    ], {
                        duration: 500,
                        easing: 'ease-out'
                    }).onfinish = () => {
                        pressureContainer.removeChild(pulse);
                    };
                }
            }
        }
        
        function applyIntensityEffects() {
            // æ ¹æ®å¼ºåº¦æ”¹å˜èƒŒæ™¯é¢œè‰²
            let hue = 120 - (intensity * 1.2);
            
            // ä¸åŒæ¨¡å¼çš„é¢œè‰²å·®å¼‚
            if (currentMode === 'release') {
                hue = 40 - (intensity * 0.3);
            } else if (currentMode === 'fury') {
                hue = 360 - (intensity * 0.6);
            }
            
            body.style.backgroundColor = `hsl(${hue}, ${50 + intensity/4}%, ${90 - intensity/4}%)`;
            
            // æŒ‰é’®æ•ˆæœ
            const scale = 1 + (intensity / 500);
            screamButton.style.transform = `scale(${scale})`;
            
            // æ ‡é¢˜æ•ˆæœ
            const titleRotation = (intensity / 50) * (Math.random() > 0.5 ? 1 : -1);
            const titleOffset = intensity / 10;
            title.style.transform = `translateY(${titleOffset}px) rotate(${titleRotation}deg)`;
            title.style.color = `hsl(${hue}, 70%, 40%)`;
            
            // æ·»åŠ æ–‡å­—é˜´å½±æ•ˆæœï¼Œå¼ºåº¦è¶Šé«˜è¶Šæ˜æ˜¾
            const textShadowBlur = intensity / 10;
            const textShadowColor = `hsla(${hue}, 70%, 50%, 0.7)`;
            title.style.textShadow = `0 0 ${textShadowBlur}px ${textShadowColor}`;
            
            // æ˜¾ç¤ºæƒ…ç»ªæ–‡å­—
            for (let i = emotions.length - 1; i >= 0; i--) {
                if (intensity >= emotions[i].threshold) {
                    const randomEmoji = emotions[i].emoji[Math.floor(Math.random() * emotions[i].emoji.length)];
                    showEmotionText(`${emotions[i].text} ${randomEmoji}`, emotions[i].color);
                    break;
                }
            }
            
            // å½“å¼ºåº¦è¶…è¿‡é˜ˆå€¼æ—¶è§¦å‘éœ‡åŠ¨
            if (intensity > 70 && !shakingTimeout) {
                const shakeIntensity = intensity / 50;
                shakeScreen(shakeIntensity);
            }
            
            // ç‰¹æ•ˆæ¨¡å¼ä¸‹çš„é™„åŠ æ•ˆæœ
            if (fxMode && USE_COMPLEX_EFFECTS) {
                applyFxModeEffects();
            }
            
            // ç»Ÿè®¡æ¡†ç¼©æ”¾æ•ˆæœ
            const statBoxes = document.querySelectorAll('.stat-box');
            statBoxes.forEach(box => {
                box.style.transform = `scale(${1 + intensity/500})`;
                
                // å¢åŠ é˜´å½±æ•ˆæœ
                const shadowBlur = 5 + (intensity / 10);
                box.style.boxShadow = `0 ${2 + (intensity/50)}px ${shadowBlur}px rgba(0,0,0,${0.1 + (intensity/500)})`;
            });
            
            // å›¾æ ‡æ—‹è½¬
            const screamIcon = document.querySelector('.scream-icon');
            screamIcon.style.transform = `rotate(${intensity/2}deg) scale(${1 + intensity/300})`;
            
            // æƒ…ç»ªæŒ‡ç¤ºå™¨åŠ¨ç”»
            if (intensity > 40) {
                emotionIndicator.style.transform = `scale(${1 + intensity/200}) translateY(${(Math.random() - 0.5) * (intensity / 50)}px)`;
            } else {
                emotionIndicator.style.transform = 'scale(1) translateY(0)';
            }
        }
        
        function applyFxModeEffects() {
            // æ ¹æ®ä¸åŒæ¨¡å¼åº”ç”¨ä¸åŒçš„ç‰¹æ•ˆ
            // ä½æ€§èƒ½è®¾å¤‡é™ä½æ¦‚ç‡
            const effectChance = isLowPerformanceDevice ? 0.3 : 0.7;
            
            switch (currentMode) {
                case 'release':
                    // é‡Šæ”¾æ¨¡å¼ - æ›´å¤šç²’å­ï¼Œå½©è‰²ç²’å­
                    if (intensity > 30 && Math.random() > 1 - effectChance) {
                        const particleCount = isLowPerformanceDevice ? 3 : (5 + Math.random() * 10);
                        createColorfulParticles(particleCount);
                    }
                    
                    // è„‰å†²æ•ˆæœ
                    if (intensity > 50 && Math.random() > 0.95) {
                        animateButtonPulse();
                    }
                    break;
                    
                case 'fury':
                    // ç‹‚æ€’æ¨¡å¼ - ç«ç„°æ•ˆæœï¼Œå±å¹•éœ‡åŠ¨æ›´å¼ºçƒˆ
                    if (intensity > 50 && Math.random() > 1 - effectChance) {
                        const particleCount = isLowPerformanceDevice ? 2 : (3 + Math.random() * 5);
                        createFireParticles(particleCount);
                        
                        if (intensity > 80 && !shakingTimeout && Math.random() > 0.7) {
                            shakeScreen(intensity / 30);
                        }
                    }
                    
                    // å¼ºåº¦è¶…è¿‡80ï¼Œéšæœºæ˜¾ç¤ºæƒ…ç»ªçˆ†å‘æ–‡å­—
                    if (intensity > 80 && Math.random() > 0.98) {
                        showEmotionEmoji();
                    }
                    break;
            }
        }
        
        function createWaveEffect() {
            if (visibleParticlesCount > PARTICLE_LIMIT * 0.8) return;
            
            waveContainer.style.opacity = 1;
            
            const wave = document.createElement('div');
            wave.classList.add('wave');
            wave.style.width = '10px';
            wave.style.height = '10px';
            
            waveContainer.appendChild(wave);
            
            // è®¾ç½®æ³¢çº¹çš„é¢œè‰²ï¼Œæ ¹æ®å½“å‰æ¨¡å¼
            let waveColor;
            switch (currentMode) {
                case 'calm':
                    waveColor = 'rgba(76, 175, 80, 0.5)';
                    break;
                case 'release':
                    waveColor = 'rgba(255, 152, 0, 0.5)';
                    break;
                case 'fury':
                    waveColor = 'rgba(244, 67, 54, 0.5)';
                    break;
            }
            wave.style.borderColor = waveColor;
            
            // æ³¢çº¹åŠ¨ç”»
            let scale = 0;
            const waveInterval = setInterval(() => {
                scale += 0.05;
                wave.style.transform = `translate(-50%, -50%) scale(${scale})`;
                wave.style.opacity = 1 - scale/10;
                
                if (scale >= 10) {
                    clearInterval(waveInterval);
                    if (waveContainer.contains(wave)) {
                        waveContainer.removeChild(wave);
                    }
                    
                    if (waveContainer.children.length === 0) {
                        waveContainer.style.opacity = 0;
                    }
                }
            }, 16);
        }
        
        function createBurstEffect(amount) {
            if (visibleParticlesCount > PARTICLE_LIMIT * 0.7) return;
            
            // ä½æ€§èƒ½è®¾å¤‡é™ä½æ³¢çº¹æ•°é‡
            const waveCount = isLowPerformanceDevice ? 1 : 3;
            
            for (let i = 0; i < waveCount; i++) {
                setTimeout(() => {
                    const wave = document.createElement('div');
                    wave.classList.add('wave');
                    wave.style.width = '10px';
                    wave.style.height = '10px';
                    
                    // è®¾ç½®æ³¢çº¹çš„é¢œè‰²ï¼Œæ ¹æ®å½“å‰æ¨¡å¼
                    let waveColor;
                    switch (currentMode) {
                        case 'calm':
                            waveColor = 'rgba(76, 175, 80, 0.7)';
                            break;
                        case 'release':
                            waveColor = 'rgba(255, 152, 0, 0.7)';
                            break;
                        case 'fury':
                            waveColor = 'rgba(244, 67, 54, 0.7)';
                            break;
                    }
                    wave.style.borderColor = waveColor;
                    wave.style.borderWidth = '3px';
                    
                    waveContainer.appendChild(wave);
                    waveContainer.style.opacity = 1;
                    
                    // æ³¢çº¹åŠ¨ç”»
                    let scale = 0;
                    const maxScale = 15 + amount/5;
                    const waveInterval = setInterval(() => {
                        scale += 0.2;
                        wave.style.transform = `translate(-50%, -50%) scale(${scale})`;
                        wave.style.opacity = 1 - scale/maxScale;
                        
                        if (scale >= maxScale) {
                            clearInterval(waveInterval);
                            if (waveContainer.contains(wave)) {
                                waveContainer.removeChild(wave);
                            }
                            
                            if (waveContainer.children.length === 0) {
                                waveContainer.style.opacity = 0;
                            }
                        }
                    }, 16);
                }, i * (isLowPerformanceDevice ? 400 : 200));
            }
        }
        
        function animateSoundWaves() {
            soundWaveElements.forEach((wave, index) => {
                // è®¡ç®—æ¯ä¸ªå£°æ³¢å…ƒç´ çš„é«˜åº¦ - åŸºäºå¼ºåº¦å’Œéšæœºå€¼
                let height;
                
                if (intensity === 0) {
                    height = 5;
                } else {
                    const baseHeight = 5 + (intensity / 5);
                    const randomFactor = Math.sin(Date.now() / 200 + index * 0.5) * (intensity / 10);
                    height = baseHeight + randomFactor;
                }
                
                wave.style.height = `${Math.max(2, height)}px`;
            });
        }
        
        function animateAudioVisualizer() {
            audioBarElements.forEach((bar, index) => {
                // è®¡ç®—æ¯ä¸ªéŸ³é¢‘æ¡çš„é«˜åº¦ - åŸºäºå¼ºåº¦å’Œéšæœºå€¼
                let height;
                
                if (intensity === 0) {
                    height = 5;
                } else {
                    // ä½¿ç”¨ä¸åŒçš„é¢‘ç‡åˆ›å»ºæ›´è‡ªç„¶çš„æ³¢å½¢
                    const time = Date.now() / 100;
                    const frequency = 0.1 + (index / audioBarElements.length) * 2;
                    const amplitude = intensity / 5;
                    
                    const value = Math.sin(time * frequency) * amplitude;
                    height = 5 + (intensity / 10) + value;
                    
                    // ä¸­é—´çš„æ¡æ›´é«˜
                    const centerBoost = 1 - Math.abs((index - audioBarElements.length/2) / (audioBarElements.length/2));
                    height *= (1 + centerBoost * 0.5);
                }
                
                bar.style.height = `${Math.max(2, height)}px`;
            });
        }
        
        function showEmotionText(text, color, duration = 2000) {
            emotionIndicator.textContent = text;
            emotionIndicator.style.color = color;
            emotionIndicator.style.opacity = 1;
            
            // æ–‡å­—é˜´å½±æ•ˆæœ
            emotionIndicator.style.textShadow = `0 0 10px ${color.replace(')', ', 0.5)')}, 0 0 20px ${color.replace(')', ', 0.3)')}`;
            
            clearTimeout(emotionIndicator.fadeTimeout);
            emotionIndicator.fadeTimeout = setTimeout(() => {
                emotionIndicator.style.opacity = 0;
            }, duration);
        }
        
        function createParticles(count = 3) {
            if (visibleParticlesCount >= PARTICLE_LIMIT) return;
            
            const particleCount = Math.floor(Math.min(count * (intensity / 30), PARTICLE_LIMIT - visibleParticlesCount));
            if (particleCount <= 0) return;
            
            const buttonRect = screamButton.getBoundingClientRect();
            const centerX = buttonRect.left + buttonRect.width / 2;
            const centerY = buttonRect.top + buttonRect.height / 2;
            
            for (let i = 0; i < particleCount; i++) {
                createParticle(centerX, centerY);
            }
        }
        
        function createColorfulParticles(count) {
            if (visibleParticlesCount >= PARTICLE_LIMIT) return;
            
            const particleCount = Math.min(count, PARTICLE_LIMIT - visibleParticlesCount);
            if (particleCount <= 0) return;
            
            const buttonRect = screamButton.getBoundingClientRect();
            const centerX = buttonRect.left + buttonRect.width / 2;
            const centerY = buttonRect.top + buttonRect.height / 2;
            
            for (let i = 0; i < particleCount; i++) {
                // å½©è™¹è‰²ç²’å­
                const hue = Math.random() * 360;
                const saturation = 80 + Math.random() * 20;
                const lightness = 50 + Math.random() * 30;
                
                createParticle(centerX, centerY, {
                    backgroundColor: `hsl(${hue}, ${saturation}%, ${lightness}%)`,
                    size: 8 + Math.random() * 8,
                    speed: 3 + Math.random() * 5,
                    duration: 1500 + Math.random() * 1500
                });
            }
        }
        
        function createFireParticles(count) {
            if (visibleParticlesCount >= PARTICLE_LIMIT) return;
            
            const particleCount = Math.min(count, PARTICLE_LIMIT - visibleParticlesCount);
            if (particleCount <= 0) return;
            
            const buttonRect = screamButton.getBoundingClientRect();
const centerX = buttonRect.left + buttonRect.width / 2;
                const centerY = buttonRect.top + buttonRect.height / 2;
            
            for (let i = 0; i < particleCount; i++) {
                // ç«ç„°è‰²ç²’å­
                const hue = 20 + Math.random() * 40;
                const saturation = 80 + Math.random() * 20;
                const lightness = 50 + Math.random() * 30;
                
                // ç²’å­ä»ä¸‹å¾€ä¸Šé£˜
                const angle = Math.PI * (1.3 + Math.random() * 0.4); // å¤§çº¦å‘ä¸Šçš„æ–¹å‘
                createParticle(centerX, centerY + 50, {
                    backgroundColor: `hsl(${hue}, ${saturation}%, ${lightness}%)`,
                    size: 8 + Math.random() * 12,
                    speed: 2 + Math.random() * 4,
                    duration: 1200 + Math.random() * 1500,
                    angle: angle
                });
            }
        }
        
        function createParticle(x, y, options = {}) {
            visibleParticlesCount++;
            
            const particle = document.createElement('div');
            particle.classList.add('particle');
            
            // é»˜è®¤å€¼ä¸é€‰é¡¹åˆå¹¶
            const settings = Object.assign({
                size: 5 + Math.random() * (intensity / 10),
                speed: 2 + Math.random() * (intensity / 10),
                duration: 1000 + Math.random() * 2000,
                angle: Math.random() * Math.PI * 2
            }, options);
            
            // åº”ç”¨è®¾ç½®
            particle.style.width = `${settings.size}px`;
            particle.style.height = `${settings.size}px`;
            
            // åº”ç”¨é¢œè‰² - å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œåˆ™ä½¿ç”¨åŸºäºå¼ºåº¦çš„é¢œè‰²
            if (!options.backgroundColor) {
                const hue = 40 + (intensity * 2);
                const saturation = 80 + Math.random() * 20;
                const lightness = 50 + Math.random() * 20;
                particle.style.backgroundColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
            } else {
                particle.style.backgroundColor = options.backgroundColor;
            }
            
            // åˆå§‹ä½ç½®
            particle.style.left = `${x}px`;
            particle.style.top = `${y}px`;
            
            // æ·»åŠ åˆ°å®¹å™¨
            particlesContainer.appendChild(particle);
            
            // éšæœºæ–¹å‘å’Œé€Ÿåº¦
            const vx = Math.cos(settings.angle) * settings.speed;
            const vy = Math.sin(settings.angle) * settings.speed;
            
            // å°†ç²’å­æ·»åŠ åˆ°æ´»åŠ¨ç²’å­æ•°ç»„
            const particleData = {
                element: particle,
                x: x,
                y: y,
                vx: vx,
                vy: vy,
                opacity: 1,
                gravity: 0.05,
                startTime: Date.now(),
                duration: settings.duration,
                finished: false
            };
            
            activeParticles.push(particleData);
            
            return particleData;
        }
        
        function updateParticles(deltaTime) {
            const now = Date.now();
            const particlesToRemove = [];
            
            activeParticles.forEach(particle => {
                if (particle.finished) return;
                
                const elapsed = now - particle.startTime;
                const progress = elapsed / particle.duration;
                
                if (progress >= 1) {
                    particle.finished = true;
                    particlesToRemove.push(particle);
                    return;
                }
                
                // æ›´æ–°ä½ç½®
                particle.x += particle.vx;
                particle.y += particle.vy + (particle.gravity * Math.pow(progress, 2));
                
                // æ›´æ–°opacity
                particle.opacity = 1 - progress;
                
                // æ›´æ–°DOM
                const elem = particle.element;
                elem.style.left = `${particle.x}px`;
                elem.style.top = `${particle.y}px`;
                elem.style.opacity = particle.opacity;
                
                // ç‰¹æ•ˆæ¨¡å¼ä¸‹çš„ç²’å­å¯èƒ½æœ‰ç¼©æ”¾æ•ˆæœ
                if (fxMode && currentMode === 'release') {
                    const scale = 1 - progress * 0.5;
                    elem.style.transform = `scale(${scale})`;
                }
                
                // æ·»åŠ æ—‹è½¬æ•ˆæœ
                if (fxMode && Math.random() > 0.8) {
                    const rotationSpeed = (Math.random() - 0.5) * 10;
                    const rotation = progress * 360 * rotationSpeed;
                    elem.style.transform = `${elem.style.transform || ''} rotate(${rotation}deg)`;
                }
            });
            
            // æ¸…ç†å®Œæˆçš„ç²’å­
            if (particlesToRemove.length > 0) {
                particlesToRemove.forEach(particle => {
                    if (particlesContainer.contains(particle.element)) {
                        particlesContainer.removeChild(particle.element);
                    }
                    visibleParticlesCount--;
                    
                    const index = activeParticles.indexOf(particle);
                    if (index !== -1) {
                        activeParticles.splice(index, 1);
                    }
                });
            }
        }
        
        function shakeScreen(intensity) {
            if (shakingTimeout) return;
            
            const container = document.querySelector('.container');
            const duration = intensity * 100;
            const startTime = Date.now();
            
            // ä½æ€§èƒ½è®¾å¤‡é™ä½éœ‡åŠ¨å¼ºåº¦
            let shakeMultiplier = isLowPerformanceDevice ? 0.7 : 1;
            
            function shake() {
                const elapsed = Date.now() - startTime;
                const progress = elapsed / duration;
                
                if (progress >= 1) {
                    container.style.transform = 'translate(0, 0)';
                    shakingTimeout = null;
                    return;
                }
                
                const xOffset = (Math.random() - 0.5) * intensity * 2 * shakeMultiplier;
                const yOffset = (Math.random() - 0.5) * intensity * 2 * shakeMultiplier;
                container.style.transform = `translate(${xOffset}px, ${yOffset}px)`;
                
                shakingTimeout = setTimeout(shake, 50);
            }
            
            shake();
        }
        
        function unlockAchievement(achievement) {
            // ä»æœ¬åœ°å­˜å‚¨ä¸­è¯»å–å·²è§£é”çš„æˆå°±
            const unlockedAchievements = JSON.parse(localStorage.getItem('unlockedAchievements') || '[]');
            
            // å¦‚æœå·²ç»è§£é”è¿‡ï¼Œå°±ä¸å†æ˜¾ç¤ºé€šçŸ¥
            if (unlockedAchievements.includes(achievement.id)) {
                return;
            }
            
            // æ›´æ–°å·²è§£é”çš„æˆå°±
            unlockedAchievements.push(achievement.id);
            localStorage.setItem('unlockedAchievements', JSON.stringify(unlockedAchievements));
            
            // æ›´æ–°æˆå°±åˆ—è¡¨UI
            const achievementItems = document.querySelectorAll('.achievement-item');
            achievementItems.forEach((item, index) => {
                if (index === achievements.findIndex(a => a.id === achievement.id)) {
                    item.classList.add('unlocked');
                }
            });
            
            // åˆ›å»ºæˆå°±é€šçŸ¥
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.backgroundColor = '#4CAF50';
            notification.style.color = 'white';
            notification.style.padding = '10px 20px';
            notification.style.borderRadius = '5px';
            notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
            notification.style.zIndex = '1000';
            notification.style.opacity = '0';
            notification.style.transition = 'opacity 0.3s, transform 0.3s';
            notification.innerHTML = `<strong>æˆå°±è§£é”: ${achievement.name}</strong><br>${achievement.description}`;
            
            document.body.appendChild(notification);
            
            // åŠ¨ç”»æ˜¾ç¤ºå’Œæ¶ˆå¤±
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(-50%) scale(1.05)';
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(-50%) scale(0.95)';
                    
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }, 10);
            
            // è§¦å‘éœ‡åŠ¨åé¦ˆ
            try {
                if (navigator.vibrate) {
                    navigator.vibrate([30, 50, 30]);
                }
            } catch (e) {}
            
            // æˆå°±è§£é”ç‰¹æ•ˆ
            const achievementEffect = document.createElement('div');
            achievementEffect.style.position = 'fixed';
            achievementEffect.style.top = '0';
            achievementEffect.style.left = '0';
            achievementEffect.style.width = '100%';
            achievementEffect.style.height = '100%';
            achievementEffect.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
            achievementEffect.style.zIndex = '500';
            achievementEffect.style.pointerEvents = 'none';
            
            document.body.appendChild(achievementEffect);
            
            // åŠ¨ç”»
            achievementEffect.animate([
                { opacity: 0.2 },
                { opacity: 0 }
            ], {
                duration: 1000,
                easing: 'ease-out'
            }).onfinish = () => {
                document.body.removeChild(achievementEffect);
            };
        }
        
        function checkAchievements() {
            // æ£€æŸ¥åŸºäºæ€»é‡Šæ”¾å€¼çš„æˆå°±
            achievements.forEach(achievement => {
                if (achievement.threshold && totalRelease >= achievement.threshold) {
                    unlockAchievement(achievement);
                }
            });
        }
        
        function loadEmotionHistory() {
            // åŠ è½½æƒ…ç»ªå†å²è®°å½•
            emotionHistory = JSON.parse(localStorage.getItem('emotionHistory') || '[]');
            
            // åŠ è½½æ€»é‡Šæ”¾å€¼
            const savedTotalRelease = localStorage.getItem('totalRelease');
            if (savedTotalRelease) {
                totalRelease = parseFloat(savedTotalRelease);
                totalReleaseElement.textContent = Math.floor(totalRelease);
            }
        }
        
        function saveEmotionRecord() {
            // ä¿å­˜å½“å‰æƒ…ç»ªçŠ¶æ€
            const now = new Date();
            const emotionRecord = {
                date: now.toISOString(),
                intensity: intensity,
                mode: currentMode,
                totalRelease: totalRelease,
                weather: currentWeather
            };
            
            // æ·»åŠ åˆ°å†å²è®°å½•
            emotionHistory.unshift(emotionRecord);
            
            // é™åˆ¶å†å²è®°å½•é•¿åº¦
            if (emotionHistory.length > 30) {
                emotionHistory = emotionHistory.slice(0, 30);
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('emotionHistory', JSON.stringify(emotionHistory));
            
            // æ£€æŸ¥æƒ…ç»ªè®°å½•æˆå°±
            const historyAchievement = achievements.find(a => a.type === 'history');
            if (historyAchievement && emotionHistory.length >= historyAchievement.count) {
                unlockAchievement(historyAchievement);
            }
            
            // æ›´æ–°æœ€åä¿å­˜æ—¶é—´
            lastEmotionSave = Date.now();
        }
        
        function checkEmotionRecording() {
            // å½“å¼ºåº¦è¶…è¿‡50å¹¶ä¸”è‡ªä¸Šæ¬¡ä¿å­˜å·²è¿‡å»è‡³å°‘5åˆ†é’Ÿï¼Œæˆ–è€…å¼ºåº¦è¾¾åˆ°æœ€å¤§ï¼Œè®°å½•æƒ…ç»ª
            const timePassedMinutes = (Date.now() - lastEmotionSave) / (1000 * 60);
            
            if ((intensity >= 50 && timePassedMinutes >= 5) || intensity >= 95) {
                saveEmotionRecord();
            }
        }
        
        function updateEmotionChart() {
            // æ›´æ–°æƒ…ç»ªå›¾è¡¨
            emotionChart.innerHTML = '';
            
            // è·å–æœ€è¿‘çš„10æ¡è®°å½•
            const recentHistory = emotionHistory.slice(0, 10).reverse();
            
            // å¦‚æœæ²¡æœ‰è®°å½•ï¼Œæ˜¾ç¤ºæç¤º
            if (recentHistory.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.style.position = 'absolute';
                emptyMessage.style.top = '50%';
                emptyMessage.style.left = '50%';
                emptyMessage.style.transform = 'translate(-50%, -50%)';
                emptyMessage.style.color = '#999';
                emptyMessage.style.fontSize = '14px';
                emptyMessage.textContent = 'æš‚æ— æƒ…ç»ªè®°å½•';
                emotionChart.appendChild(emptyMessage);
                
                emotionHistoryList.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">æš‚æ— æƒ…ç»ªè®°å½•</div>';
                return;
            }
            
            // è®¡ç®—å›¾è¡¨å®½åº¦
            const chartWidth = emotionChart.offsetWidth;
            const barWidth = Math.min(20, (chartWidth - 40) / recentHistory.length);
            const barSpacing = (chartWidth - 40 - barWidth * recentHistory.length) / (recentHistory.length - 1);
            
            // åˆ›å»ºå›¾è¡¨æ¡å’Œæ—¥æœŸæ ‡ç­¾
            recentHistory.forEach((record, index) => {
                // åˆ›å»ºå›¾è¡¨æ¡
                const bar = document.createElement('div');
                bar.classList.add('emotion-chart-bar');
                bar.style.left = `${20 + index * (barWidth + barSpacing)}px`;
                bar.style.width = `${barWidth}px`;
                bar.style.height = `0px`; // åˆå§‹åŒ–ä¸º0ï¼Œç„¶ååŠ¨ç”»å¢åŠ é«˜åº¦
                
                // è®¾ç½®é¢œè‰² - æ ¹æ®æƒ…ç»ªå¼ºåº¦
                let barColor;
                for (let i = emotions.length - 1; i >= 0; i--) {
                    if (record.intensity >= emotions[i].threshold) {
                        barColor = emotions[i].color;
                        break;
                    }
                }
                
                bar.style.background = barColor || '#4CAF50';
                emotionChart.appendChild(bar);
                
                // æ·»åŠ æ—¥æœŸæ ‡ç­¾
                const dateLabel = document.createElement('div');
                dateLabel.classList.add('emotion-chart-date');
                dateLabel.style.left = `${20 + index * (barWidth + barSpacing) + barWidth/2}px`;
                
                const date = new Date(record.date);
                dateLabel.textContent = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                emotionChart.appendChild(dateLabel);
                
                // æ·»åŠ æç¤º
                bar.addEventListener('mouseenter', () => {
                    const tooltip = document.createElement('div');
                    tooltip.style.position = 'absolute';
                    tooltip.style.bottom = '100%';
                    tooltip.style.left = '50%';
                    tooltip.style.transform = 'translateX(-50%)';
                    tooltip.style.backgroundColor = 'rgba(0,0,0,0.7)';
                    tooltip.style.color = 'white';
                    tooltip.style.padding = '5px 8px';
                    tooltip.style.borderRadius = '4px';
                    tooltip.style.fontSize = '12px';
                    tooltip.style.whiteSpace = 'nowrap';
                    tooltip.style.zIndex = '100';
                    tooltip.textContent = `å¼ºåº¦: ${Math.round(record.intensity)}%, æ¨¡å¼: ${record.mode}`;
                    
                    bar.appendChild(tooltip);
                });
                
                bar.addEventListener('mouseleave', () => {
                    const tooltip = bar.querySelector('div');
                    if (tooltip) {
                        bar.removeChild(tooltip);
                    }
                });
                
                // åŠ¨ç”»æ˜¾ç¤ºå›¾è¡¨æ¡
                setTimeout(() => {
                    bar.style.height = `${(record.intensity / 100) * 150}px`;
                }, index * 100);
            });
            
            // æ›´æ–°æƒ…ç»ªå†å²åˆ—è¡¨
            updateEmotionHistoryList();
        }
        
        function updateEmotionHistoryList() {
            // æ›´æ–°æƒ…ç»ªå†å²åˆ—è¡¨
            emotionHistoryList.innerHTML = '';
            
            // å¦‚æœæ²¡æœ‰è®°å½•ï¼Œå·²åœ¨å›¾è¡¨å‡½æ•°ä¸­å¤„ç†
            if (emotionHistory.length === 0) return;
            
            // è·å–æœ€è¿‘çš„5æ¡è®°å½•
            const recentHistory = emotionHistory.slice(0, 5);
            
            recentHistory.forEach(record => {
                const entry = document.createElement('div');
                entry.classList.add('emotion-history-entry');
                
                const date = new Date(record.date);
                
                const dateElem = document.createElement('div');
                dateElem.classList.add('emotion-history-date');
                dateElem.textContent = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                // è®¡ç®—èƒŒæ™¯é¢œè‰² - æ ¹æ®æ¨¡å¼å’Œå¼ºåº¦
                let bgColor;
                switch (record.mode) {
                    case 'calm':
                        bgColor = '#E8F5E9';
                        break;
                    case 'release':
                        bgColor = '#FFF3E0';
                        break;
                    case 'fury':
                        bgColor = '#FFEBEE';
                        break;
                }
                
                entry.style.backgroundColor = bgColor;
                
                // æ·»åŠ æƒ…ç»ªå¼ºåº¦æ ‡ç­¾
                const intensityElem = document.createElement('span');
                intensityElem.classList.add('emotion-history-intensity');
                intensityElem.textContent = `${Math.round(record.intensity)}%`;
                
                // è®¾ç½®æ ‡ç­¾é¢œè‰²
                let intensityColor;
                for (let i = emotions.length - 1; i >= 0; i--) {
                    if (record.intensity >= emotions[i].threshold) {
                        intensityColor = emotions[i].color;
                        break;
                    }
                }
                intensityElem.style.backgroundColor = intensityColor || '#4CAF50';
                
                dateElem.appendChild(intensityElem);
                entry.appendChild(dateElem);
                
                // æ·»åŠ è¯¦æƒ…
                const detailsElem = document.createElement('div');
                detailsElem.style.fontSize = '12px';
                detailsElem.style.marginTop = '3px';
                detailsElem.style.color = '#666';
                
                // è·å–æƒ…ç»ªæ–‡æœ¬
                let emotionText = 'å¹³é™';
                for (let i = emotions.length - 1; i >= 0; i--) {
                    if (record.intensity >= emotions[i].threshold) {
                        emotionText = emotions[i].text;
                        break;
                    }
                }
                
                // è·å–å¤©æ°”æ–‡æœ¬
                const weather = weatherTypes.find(w => w.id === record.weather) || weatherTypes[0];
                
                detailsElem.textContent = `æƒ…ç»ª: ${emotionText} | æ¨¡å¼: ${
                    record.mode === 'calm' ? 'å¹³é™' : 
                    record.mode === 'release' ? 'é‡Šæ”¾' : 'ç‹‚æ€’'
                } | å¤©æ°”: ${weather.name} ${weather.icon}`;
                
                entry.appendChild(detailsElem);
                emotionHistoryList.appendChild(entry);
            });
        }
        
        // å®šæœŸæ£€æŸ¥æˆå°± - é™ä½æ£€æŸ¥é¢‘ç‡ä»¥æé«˜æ€§èƒ½
        setInterval(checkAchievements, 2000);


        
        
        // æ·»åŠ ä¸€äº›äº’åŠ¨æç¤º
        setTimeout(() => {
            showEmotionText("é•¿æŒ‰æˆ–å¿«é€Ÿç‚¹å‡»è¿™é‡Œ!", "#4CAF50", 3000);
        }, 1000);
        
        // åˆå§‹åŒ–å¤©æ°”
        setWeather('none');
        
        // æ¨¡æ‹Ÿä¸€äº›åˆå§‹çš„ç²’å­æ•ˆæœ - ä½æ€§èƒ½è®¾å¤‡å‡å°‘æ•°é‡
        setTimeout(() => {
            const particleCount = isLowPerformanceDevice ? 3 : 5;
            const buttonRect = screamButton.getBoundingClientRect();
            const centerX = buttonRect.left + buttonRect.width / 2;
            const centerY = buttonRect.top + buttonRect.height / 2;
            
            for (let i = 0; i < particleCount; i++) {
                setTimeout(() => {
                    createParticle(centerX, centerY, {
                        size: 5 + Math.random() * 5,
                        speed: 1 + Math.random() * 2,
                        backgroundColor: `rgba(200, 200, 200, ${0.5 + Math.random() * 0.3})`
                    });
                }, i * 200);
            }
        }, 1500);
        
        // å‘ç”¨æˆ·ä»‹ç»æ–°åŠŸèƒ½
        setTimeout(() => {
            if (!localStorage.getItem('hasSeenIntro')) {
                showTooltip(emotionHistoryToggle, 'æ–°åŠŸèƒ½: æƒ…ç»ªè®°å½•ï¼Œè®°å½•ä½ çš„å‹åŠ›é‡Šæ”¾å†å²');
                
                setTimeout(() => {
                    showTooltip(weatherToggle, 'æ–°åŠŸèƒ½: æƒ…ç»ªå¤©æ°”ï¼Œä½“éªŒä¸åŒçš„è§†è§‰æ•ˆæœ');
                    
                    setTimeout(() => {
                        localStorage.setItem('hasSeenIntro', 'true');
                    }, 2500);
                }, 2500);
            }
        }, 3000);


/**
 * 1. æ‰“å¡ç³»ç»Ÿ - ä»¥æœˆä¸ºç»´åº¦çš„æ‰“å¡ç•Œé¢
 */

// æ‰“å¡ç³»ç»Ÿæ•°æ®ç®¡ç†
const CheckInSystem = {
    // è·å–æ‰“å¡è®°å½•
    getCheckInData() {
        const data = localStorage.getItem('screamCheckInData');
        return data ? JSON.parse(data) : {};
    },
    
    // ä¿å­˜æ‰“å¡è®°å½•
    saveCheckInData(data) {
        localStorage.setItem('screamCheckInData', JSON.stringify(data));
    },
    
    // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²æ‰“å¡
    isTodayCheckedIn() {
        const today = new Date();
        const dateStr = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
        const data = this.getCheckInData();
        return data[dateStr] ? true : false;
    },
    
    // è·å–å½“æœˆæ‰“å¡å¤©æ•°
    getCurrentMonthCheckIns() {
        const today = new Date();
        const currentMonth = today.getMonth() + 1;
        const currentYear = today.getFullYear();
        const data = this.getCheckInData();
        
        let count = 0;
        for (const dateStr in data) {
            const [year, month] = dateStr.split('-').map(Number);
            if (year === currentYear && month === currentMonth) {
                count++;
            }
        }
        
        return count;
    },
    
    // æ‰“å¡
    checkIn(intensity) {
        const today = new Date();
        const dateStr = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
        const data = this.getCheckInData();
        
        if (!data[dateStr]) {
            data[dateStr] = {
                timestamp: Date.now(),
                intensity: intensity || 0,
                mode: currentMode,
                weather: currentWeather
            };
            
            this.saveCheckInData(data);
            return true;
        }
        
        return false;
    },
    
    // è·å–æŒ‡å®šæœˆä»½çš„æ‰“å¡æ•°æ®
    getMonthData(year, month) {
        const data = this.getCheckInData();
        const monthData = {};
        
        for (const dateStr in data) {
            const [dataYear, dataMonth] = dateStr.split('-').map(Number);
            if (dataYear === year && dataMonth === month) {
                monthData[dateStr] = data[dateStr];
            }
        }
        
        return monthData;
    }
};

// åˆ›å»ºå¹¶æ˜¾ç¤ºæ‰“å¡ç•Œé¢
function createCheckInUI() {
    // å¦‚æœå·²å­˜åœ¨ï¼Œåˆ™ç§»é™¤æ—§çš„
    const existingUI = document.getElementById('checkInContainer');
    if (existingUI) {
        document.body.removeChild(existingUI);
    }
    
    // åˆ›å»ºæ‰“å¡å®¹å™¨
    const checkInContainer = document.createElement('div');
    checkInContainer.id = 'checkInContainer';
    checkInContainer.style.position = 'absolute';
    checkInContainer.style.top = '70px';
    checkInContainer.style.right = '70px';
    checkInContainer.style.width = '300px';
    checkInContainer.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
    checkInContainer.style.borderRadius = '8px';
    checkInContainer.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.1)';
    checkInContainer.style.padding = '15px';
    checkInContainer.style.zIndex = '100';
    checkInContainer.style.transform = 'translateX(150%)';
    checkInContainer.style.transition = 'transform 0.3s ease-out';
    checkInContainer.style.maxHeight = '80vh';
    checkInContainer.style.overflowY = 'scroll';
    
    // æ·»åŠ æ ‡é¢˜
    const title = document.createElement('h3');
    title.textContent = 'æ¯æ—¥æ‰“å¡';
    title.style.marginBottom = '15px';
    title.style.borderBottom = '1px solid #eee';
    title.style.paddingBottom = '8px';
    checkInContainer.appendChild(title);
    
    // å½“å‰æœˆä»½çŠ¶æ€
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth() + 1;
    
    const statusContainer = document.createElement('div');
    statusContainer.style.marginBottom = '15px';
    statusContainer.style.padding = '10px';
    statusContainer.style.backgroundColor = '#f5f5f5';
    statusContainer.style.borderRadius = '5px';
    statusContainer.style.textAlign = 'center';
    
    const monthName = today.toLocaleString('default', { month: 'long' });
    const checkInCount = CheckInSystem.getCurrentMonthCheckIns();
    
    statusContainer.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px;">${currentYear}å¹´ ${monthName}</div>
        <div>æœ¬æœˆå·²æ‰“å¡: <span style="color: #4CAF50; font-weight: bold;">${checkInCount}å¤©</span></div>
        <div style="margin-top: 5px; font-size: 12px; color: #666;">
            ${CheckInSystem.isTodayCheckedIn() ? 
                'âœ… ä»Šæ—¥å·²æ‰“å¡' : 
                'â— ä»Šæ—¥å°šæœªæ‰“å¡ï¼Œå°–å«å¼ºåº¦è¾¾åˆ°50%æ—¶è‡ªåŠ¨æ‰“å¡'}
        </div>
    `;
    
    checkInContainer.appendChild(statusContainer);
    
    // åˆ›å»ºæœˆå†
    const calendarContainer = document.createElement('div');
    calendarContainer.style.marginBottom = '15px';
    checkInContainer.appendChild(calendarContainer);
    
    // æœˆä»½é€‰æ‹©å™¨
    const monthSelector = document.createElement('div');
    monthSelector.style.display = 'flex';
    monthSelector.style.justifyContent = 'space-between';
    monthSelector.style.alignItems = 'center';
    monthSelector.style.marginBottom = '10px';
    
    let displayYear = currentYear;
    let displayMonth = currentMonth;
    
    const monthLabel = document.createElement('div');
    monthLabel.style.fontWeight = 'bold';
    monthLabel.textContent = `${displayYear}å¹´ ${displayMonth}æœˆ`;
    
    const prevBtn = document.createElement('button');
    prevBtn.textContent = 'â—€';
    prevBtn.style.border = 'none';
    prevBtn.style.background = '#f0f0f0';
    prevBtn.style.borderRadius = '4px';
    prevBtn.style.padding = '5px 10px';
    prevBtn.style.cursor = 'pointer';
    
    const nextBtn = document.createElement('button');
    nextBtn.textContent = 'â–¶';
    nextBtn.style.border = 'none';
    nextBtn.style.background = '#f0f0f0';
    nextBtn.style.borderRadius = '4px';
    nextBtn.style.padding = '5px 10px';
    nextBtn.style.cursor = 'pointer';
    
    monthSelector.appendChild(prevBtn);
    monthSelector.appendChild(monthLabel);
    monthSelector.appendChild(nextBtn);
    
    calendarContainer.appendChild(monthSelector);
    
    // æ¸²æŸ“æ—¥å†å‡½æ•°
    function renderCalendar(year, month) {
        // æ›´æ–°æœˆä»½æ˜¾ç¤º
        monthLabel.textContent = `${year}å¹´ ${month}æœˆ`;
        
        // æ¸…é™¤æ—§çš„æ—¥å†
        const oldCalendar = document.getElementById('calendarGrid');
        if (oldCalendar) {
            calendarContainer.removeChild(oldCalendar);
        }
        
        // åˆ›å»ºæ—¥å†ç½‘æ ¼
        const calendarGrid = document.createElement('div');
        calendarGrid.id = 'calendarGrid';
        calendarGrid.style.display = 'grid';
        calendarGrid.style.gridTemplateColumns = 'repeat(7, 1fr)';
        calendarGrid.style.gap = '5px';
        
        // æ·»åŠ æ˜ŸæœŸæ ‡é¢˜
        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        weekdays.forEach(day => {
            const dayElem = document.createElement('div');
            dayElem.textContent = day;
            dayElem.style.textAlign = 'center';
            dayElem.style.fontWeight = 'bold';
            dayElem.style.padding = '5px 0';
            dayElem.style.color = day === 'æ—¥' || day === 'å…­' ? '#FF5722' : '#333';
            calendarGrid.appendChild(dayElem);
        });
        
        // è·å–å½“æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡ 
        const firstDay = new Date(year, month - 1, 1).getDay();
        
        // è·å–å½“æœˆå¤©æ•°
        const daysInMonth = new Date(year, month, 0).getDate();
        
        // è·å–æ‰“å¡æ•°æ®
        const monthData = CheckInSystem.getMonthData(year, month);
        
        // æ·»åŠ ç©ºç™½å¤©
        for (let i = 0; i < firstDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.style.padding = '5px';
            calendarGrid.appendChild(emptyDay);
        }
        
        // æ·»åŠ æ—¥æœŸ
        for (let i = 1; i <= daysInMonth; i++) {
            const dayElem = document.createElement('div');
            const dateStr = `${year}-${month}-${i}`;
            const isChecked = monthData[dateStr];
            const isToday = year === currentYear && month === currentMonth && i === today.getDate();
            
            dayElem.textContent = i;
            dayElem.style.textAlign = 'center';
            dayElem.style.padding = '8px 0';
            dayElem.style.border = '1px solid #eee';
            dayElem.style.borderRadius = '4px';
            dayElem.style.position = 'relative';
            
            // è®¾ç½®æ ·å¼
            if (isChecked) {
                dayElem.style.backgroundColor = '#E8F5E9';
                dayElem.style.borderColor = '#81C784';
                
                // æ·»åŠ æ‰“å¡æŒ‡ç¤ºå™¨
                const indicator = document.createElement('span');
                indicator.textContent = 'âœ“';
                indicator.style.position = 'absolute';
                indicator.style.top = '2px';
                indicator.style.right = '2px';
                indicator.style.fontSize = '8px';
                indicator.style.color = '#4CAF50';
                dayElem.appendChild(indicator);
                
                // æ˜¾ç¤ºæ‰“å¡ä¿¡æ¯çš„æ‚¬åœæ•ˆæœ
                dayElem.title = `å°–å«å¼ºåº¦: ${Math.round(monthData[dateStr].intensity)}%`;
                
                // ç‚¹å‡»æ˜¾ç¤ºè¯¦æƒ…
                dayElem.style.cursor = 'pointer';
                dayElem.addEventListener('click', () => {
                    showDayDetails(dateStr, monthData[dateStr]);
                });
            }
            
            if (isToday) {
                dayElem.style.border = '2px solid #2196F3';
                dayElem.style.fontWeight = 'bold';
            }
            
            calendarGrid.appendChild(dayElem);
        }
        
        calendarContainer.appendChild(calendarGrid);
    }
    
    // æ˜¾ç¤ºæ—¥æœŸè¯¦æƒ…
    function showDayDetails(dateStr, data) {
        const detailsContainer = document.getElementById('dayDetails');
        if (detailsContainer) {
            checkInContainer.removeChild(detailsContainer);
        }
        
        const details = document.createElement('div');
        details.id = 'dayDetails';
        details.style.marginTop = '15px';
        details.style.padding = '10px';
        details.style.backgroundColor = '#f9f9f9';
        details.style.borderRadius = '5px';
        details.style.fontSize = '14px';
        
        const date = new Date(data.timestamp);
        const dateFormatted = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
        
        // è·å–æƒ…ç»ªæ–‡æœ¬
        let emotionText = 'å¹³é™';
        for (let i = emotions.length - 1; i >= 0; i--) {
            if (data.intensity >= emotions[i].threshold) {
                emotionText = emotions[i].text;
                break;
            }
        }
        
        // è·å–å¤©æ°”æ–‡æœ¬
        const weather = weatherTypes.find(w => w.id === data.weather) || weatherTypes[0];
        
        details.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 8px;">${dateStr} æ‰“å¡è¯¦æƒ…</div>
            <div>æ‰“å¡æ—¶é—´: ${dateFormatted}</div>
            <div>å°–å«å¼ºåº¦: <span style="color: ${getIntensityColor(data.intensity)}; font-weight: bold;">${Math.round(data.intensity)}%</span></div>
            <div>æƒ…ç»ªçŠ¶æ€: ${emotionText}</div>
            <div>ä½¿ç”¨æ¨¡å¼: ${data.mode === 'calm' ? 'å¹³é™' : data.mode === 'release' ? 'é‡Šæ”¾' : 'ç‹‚æ€’'}</div>
            <div>æƒ…ç»ªå¤©æ°”: ${weather.name} ${weather.icon}</div>
        `;
        
        checkInContainer.appendChild(details);
    }
    
    // è·å–å¼ºåº¦é¢œè‰²
    function getIntensityColor(intensity) {
        if (intensity >= 80) return '#FF5722';
        if (intensity >= 60) return '#FF9800';
        if (intensity >= 40) return '#CDDC39';
        if (intensity >= 20) return '#8BC34A';
        return '#4CAF50';
    }
    
    // åˆ‡æ¢æœˆä»½äº‹ä»¶
    prevBtn.addEventListener('click', () => {
        if (displayMonth === 1) {
            displayYear--;
            displayMonth = 12;
        } else {
            displayMonth--;
        }
        renderCalendar(displayYear, displayMonth);
    });
    
    nextBtn.addEventListener('click', () => {
        if (displayMonth === 12) {
            displayYear++;
            displayMonth = 1;
        } else {
            displayMonth++;
        }
        renderCalendar(displayYear, displayMonth);
    });
    
    // æ¸²æŸ“åˆå§‹æ—¥å†
    renderCalendar(displayYear, displayMonth);
    
    // è¿ç»­æ‰“å¡ç»Ÿè®¡
    const streakContainer = document.createElement('div');
    streakContainer.style.marginTop = '15px';
    streakContainer.style.padding = '10px';
    streakContainer.style.backgroundColor = '#fff3e0';
    streakContainer.style.borderRadius = '5px';
    streakContainer.style.textAlign = 'center';
    
    const streakCount = calculateStreak();
    streakContainer.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px;">è¿ç»­æ‰“å¡</div>
        <div style="font-size: 24px; color: #FF9800; font-weight: bold;">${streakCount}å¤©</div>
        ${streakCount >= 7 ? '<div style="margin-top: 5px; font-size: 12px;">ğŸ”¥ å¤ªæ£’äº†ï¼ç»§ç»­ä¿æŒï¼</div>' : ''}
    `;
    
    checkInContainer.appendChild(streakContainer);
    
    // æ·»åŠ å…³é—­æŒ‰é’®
    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'å…³é—­';
    closeBtn.style.display = 'block';
    closeBtn.style.width = '100%';
    closeBtn.style.padding = '8px';
    closeBtn.style.marginTop = '15px';
    closeBtn.style.border = 'none';
    closeBtn.style.backgroundColor = '#f0f0f0';
    closeBtn.style.borderRadius = '4px';
    closeBtn.style.cursor = 'pointer';
    closeBtn.style.transition = 'background-color 0.2s';
    
    closeBtn.addEventListener('mouseenter', () => {
        closeBtn.style.backgroundColor = '#e0e0e0';
    });
    
    closeBtn.addEventListener('mouseleave', () => {
        closeBtn.style.backgroundColor = '#f0f0f0';
    });
    
    closeBtn.addEventListener('click', () => {
        checkInContainer.style.transform = 'translateX(150%)';
        setTimeout(() => {
            if (document.body.contains(checkInContainer)) {
                document.body.removeChild(checkInContainer);
            }
        }, 300);
    });
    
    checkInContainer.appendChild(closeBtn);
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(checkInContainer);
    
    // åŠ¨ç”»æ˜¾ç¤º
    setTimeout(() => {
        checkInContainer.style.transform = 'translateX(0)';
    }, 10);
    
    // è®¡ç®—è¿ç»­æ‰“å¡å¤©æ•°
    function calculateStreak() {
        const data = CheckInSystem.getCheckInData();
        let streak = 0;
        let currentDate = new Date();
        
        // å¦‚æœä»Šå¤©æ²¡æ‰“å¡ï¼Œä»æ˜¨å¤©å¼€å§‹è®¡ç®—
        if (!CheckInSystem.isTodayCheckedIn()) {
            currentDate.setDate(currentDate.getDate() - 1);
        }
        
        while (true) {
            const dateStr = `${currentDate.getFullYear()}-${currentDate.getMonth() + 1}-${currentDate.getDate()}`;
            if (data[dateStr]) {
                streak++;
                currentDate.setDate(currentDate.getDate() - 1);
            } else {
                break;
            }
        }
        
        return streak;
    }
    
    return checkInContainer;
}

// æ‰“å¡æŒ‰é’®
function createCheckInButton() {
    const checkInBtn = document.createElement('div');
    checkInBtn.id = 'checkInButton';
    checkInBtn.style.position = 'absolute';
    checkInBtn.style.top = '100px';
    checkInBtn.style.right = '20px';
    checkInBtn.style.background = 'rgba(255, 255, 255, 0.8)';
    checkInBtn.style.borderRadius = '5px';
    checkInBtn.style.padding = '8px 12px';
    checkInBtn.style.fontSize = '14px';
    checkInBtn.style.cursor = 'pointer';
    checkInBtn.style.display = 'flex';
    checkInBtn.style.alignItems = 'center';
    checkInBtn.style.boxShadow = '0 2px 5px rgba(0, 0, 0, 0.1)';
    checkInBtn.style.zIndex = '10';
    checkInBtn.style.transition = 'transform 0.3s, box-shadow 0.3s';
    
    // å›¾æ ‡
    const icon = document.createElement('span');
    icon.textContent = 'ğŸ“…';
    icon.style.marginRight = '5px';
    
    const text = document.createElement('span');
    text.textContent = 'æ‰“å¡æ—¥å†';
    
    checkInBtn.appendChild(icon);
    checkInBtn.appendChild(text);
    
    // å¦‚æœä»Šå¤©å·²æ‰“å¡ï¼Œæ˜¾ç¤ºæ ‡è®°
    if (CheckInSystem.isTodayCheckedIn()) {
        const mark = document.createElement('span');
        mark.textContent = 'âœ“';
        mark.style.marginLeft = '5px';
        mark.style.color = '#4CAF50';
        mark.style.fontWeight = 'bold';
        checkInBtn.appendChild(mark);
    }
    
    // æ‚¬åœæ•ˆæœ
    checkInBtn.addEventListener('mouseenter', () => {
        checkInBtn.style.transform = 'scale(1.05)';
        checkInBtn.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.15)';
    });
    
    checkInBtn.addEventListener('mouseleave', () => {
        checkInBtn.style.transform = 'scale(1)';
        checkInBtn.style.boxShadow = '0 2px 5px rgba(0, 0, 0, 0.1)';
    });
    
    // ç‚¹å‡»äº‹ä»¶
    checkInBtn.addEventListener('click', () => {
        createCheckInUI();
        
        // è§¦å‘éœ‡åŠ¨åé¦ˆ
        try {
            if (navigator.vibrate) {
                navigator.vibrate(20);
            }
        } catch (e) {}
    });
    
    document.body.appendChild(checkInBtn);
    return checkInBtn;
}

// è‡ªåŠ¨æ‰“å¡å‡½æ•° - å½“å¼ºåº¦è¾¾åˆ°é˜ˆå€¼æ—¶è§¦å‘
function autoCheckIn(currentIntensity) {
    if (currentIntensity >= 50 && !CheckInSystem.isTodayCheckedIn()) {
        if (CheckInSystem.checkIn(currentIntensity)) {
            // æ‰“å¡æˆåŠŸï¼Œæ˜¾ç¤ºé€šçŸ¥
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.backgroundColor = '#4CAF50';
            notification.style.color = 'white';
            notification.style.padding = '10px 20px';
            notification.style.borderRadius = '5px';
            notification.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.2)';
            notification.style.zIndex = '1000';
            notification.style.display = 'flex';
            notification.style.alignItems = 'center';
            notification.style.opacity = '0';
            notification.style.transition = 'opacity 0.3s, transform 0.3s';
            
            const checkIcon = document.createElement('span');
            checkIcon.textContent = 'âœ“';
            checkIcon.style.marginRight = '10px';
            checkIcon.style.fontSize = '18px';
            
            const message = document.createElement('div');
            message.innerHTML = `<strong>ä»Šæ—¥æ‰“å¡æˆåŠŸ!</strong><br>å°–å«å¼ºåº¦: ${Math.round(currentIntensity)}%`;
            
            notification.appendChild(checkIcon);
            notification.appendChild(message);
            
            document.body.appendChild(notification);
            
            // åŠ¨ç”»æ˜¾ç¤º
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(-50%) scale(1.05)';
                
                // æ›´æ–°æ‰“å¡æŒ‰é’®
                const checkInBtn = document.getElementById('checkInButton');
                if (checkInBtn) {
                    const mark = document.createElement('span');
                    mark.textContent = 'âœ“';
                    mark.style.marginLeft = '5px';
                    mark.style.color = '#4CAF50';
                    mark.style.fontWeight = 'bold';
                    checkInBtn.appendChild(mark);
                }
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(-50%) scale(0.95)';
                    
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }, 10);
            
            // æ£€æŸ¥æ˜¯å¦è·å¾—è¿ç»­æ‰“å¡æˆå°±
            const streak = calculateStreak();
            if (streak >= 7) {
                // 7å¤©è¿ç»­æ‰“å¡æˆå°±
                const streakAchievement = {
                    id: 'seven-day-streak',
                    name: 'åšæŒä¸€å‘¨',
                    description: 'è¿ç»­7å¤©è¿›è¡Œå°–å«æ‰“å¡'
                };
                
                // æ£€æŸ¥æ˜¯å¦å·²è§£é”
                const unlockedAchievements = JSON.parse(localStorage.getItem('unlockedAchievements') || '[]');
                if (!unlockedAchievements.includes(streakAchievement.id)) {
                    // è§£é”æˆå°±
                    unlockAchievement(streakAchievement);
                }
            }
        }
    }
}

// è®¡ç®—è¿ç»­æ‰“å¡å¤©æ•°
function calculateStreak() {
    const data = CheckInSystem.getCheckInData();
    let streak = 0;
    let currentDate = new Date();
    
    // å¦‚æœä»Šå¤©æ‰“å¡äº†ï¼Œä»ä»Šå¤©å¼€å§‹è®¡ç®—
    const todayStr = `${currentDate.getFullYear()}-${currentDate.getMonth() + 1}-${currentDate.getDate()}`;
    const hasTodayCheckedIn = data[todayStr];
    
    if (!hasTodayCheckedIn) {
        currentDate.setDate(currentDate.getDate() - 1);
    }
    
    while (true) {
        const dateStr = `${currentDate.getFullYear()}-${currentDate.getMonth() + 1}-${currentDate.getDate()}`;
        if (data[dateStr]) {
            streak++;
            currentDate.setDate(currentDate.getDate() - 1);
        } else {
            break;
        }
    }
    
    return streak;
}

/**
 * 2. å…¨å±æ–‡å­—/è¡¨æƒ…åŠ¨ç”»æ•ˆæœ - å¢å¼ºè§†è§‰é‡Šæ”¾æ•ˆæœ
 */

// åˆ›å»ºå…¨å±æƒ…ç»ªæ–‡å­—åŠ¨ç”»
function createFullscreenTextAnimation(intensity) {
    if (intensity < 70) return; // åªåœ¨å¼ºåº¦è¾ƒé«˜æ—¶è§¦å‘
    
    // ä½æ€§èƒ½è®¾å¤‡é™ä½ç²’å­æ•°
    const textCount = isLowPerformanceDevice ? 10 : 30;
    
    // ç¡®å®šè¦å±•ç¤ºçš„æ–‡å­—ç±»å‹
    const textTypes = ['å•Š', 'a', 'ã‚', 'å“‡', 'Ahhh', 'å‘€', 'ã‚ã‚'];
    const emojis = ['ğŸ˜±', 'ğŸ˜«', 'ğŸ˜¤', 'ğŸ˜¡', 'ğŸ¤¬', 'ğŸ˜µ', 'ğŸ˜­'];
    
    // æ ¹æ®å¼ºåº¦å†³å®šæ˜¾ç¤ºé¢‘ç‡
    const showEmoji = Math.random() > 0.7;
    const showBigText = intensity > 90 && Math.random() > 0.8;
    
    // å¦‚æœéœ€è¦æ˜¾ç¤ºå¤§æ–‡å­—
    if (showBigText) {
        showBigScreenText();
        return;
    }
    
    // åˆ›å»ºå¤šä¸ªæ–‡å­—/è¡¨æƒ…å…ƒç´ 
    for (let i = 0; i < textCount; i++) {
        setTimeout(() => {
            // å†³å®šæ˜¯æ–‡å­—è¿˜æ˜¯è¡¨æƒ…
            const isEmoji = showEmoji || Math.random() > 0.7;
            
            // éšæœºé€‰æ‹©
            const textContent = isEmoji 
                ? emojis[Math.floor(Math.random() * emojis.length)]
                : textTypes[Math.floor(Math.random() * textTypes.length)];
            
            // åˆ›å»ºå…ƒç´ 
            const textElem = document.createElement('div');
            textElem.textContent = textContent;
            textElem.style.position = 'absolute';
            textElem.style.zIndex = '50';
            textElem.style.userSelect = 'none';
            textElem.style.pointerEvents = 'none';
            textElem.style.color = getRandomEmotionColor(intensity);
            textElem.style.opacity = '0';
            textElem.style.fontSize = `${isEmoji ? 24 : 18 + Math.random() * 16}px`;
            textElem.style.fontWeight = 'bold';
            textElem.style.whiteSpace = 'nowrap';
            
            // éšæœºä½ç½®
            const x = Math.random() * window.innerWidth;
            const y = Math.random() * window.innerHeight;
            textElem.style.left = `${x}px`;
            textElem.style.top = `${y}px`;
            
            document.body.appendChild(textElem);
            
            // åŠ¨ç”»
            const direction = Math.random() * Math.PI * 2;
            const distance = 50 + Math.random() * 100;
            const xEnd = x + Math.cos(direction) * distance;
            const yEnd = y + Math.sin(direction) * distance;
            
            textElem.animate([
                { 
                    transform: 'scale(0.5) rotate(-10deg)', 
                    opacity: 0,
                    left: `${x}px`,
                    top: `${y}px`
                },
                { 
                    transform: 'scale(1.1) rotate(5deg)', 
                    opacity: 1,
                    left: `${xEnd}px`,
                    top: `${yEnd}px`,
                    offset: 0.6 
                },
                { 
                    transform: 'scale(0.8) rotate(10deg)', 
                    opacity: 0,
                    left: `${xEnd}px`,
                    top: `${yEnd - 30}px`
                }
            ], {
                duration: 1000 + Math.random() * 1000,
                easing: 'ease-out'
            }).onfinish = () => {
                if (document.body.contains(textElem)) {
                    document.body.removeChild(textElem);
                }
            };
        }, i * (isLowPerformanceDevice ? 100 : 50));
    }
}

// å…¨å±å¤§å­—æ•ˆæœ
function showBigScreenText() {
    const container = document.createElement('div');
    container.style.position = 'fixed';
    container.style.top = '0';
    container.style.left = '0';
    container.style.width = '100%';
    container.style.height = '100%';
    container.style.display = 'flex';
    container.style.justifyContent = 'center';
    container.style.alignItems = 'center';
    container.style.backgroundColor = 'rgba(0, 0, 0, 0.7)'; // åˆå§‹é€æ˜åº¦ä¸º0.7
    container.style.zIndex = '200';
    container.style.opacity = '0';
    container.style.transition = 'opacity 0.3s';
    container.style.pointerEvents = 'none';
    
    // éšæœºé€‰æ‹©æ–‡å­—
    const bigTexts = ['å•Šå•Šå•Š!', 'AHHHHH!', 'ã‚ã‚ã‚!', 'å‘€å•Šå•Šå•Š!'];
    const selectedText = bigTexts[Math.floor(Math.random() * bigTexts.length)];
    
    const textElem = document.createElement('div');
    textElem.textContent = selectedText;
    textElem.style.fontSize = isLowPerformanceDevice ? '60px' : '100px';
    textElem.style.fontWeight = 'bold';
    textElem.style.color = 'white';
    textElem.style.textShadow = '0 0 20px rgba(255, 0, 0, 0.7)';
    textElem.style.transform = 'scale(0.5) rotate(-5deg)';
    textElem.style.transition = 'transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
    
    container.appendChild(textElem);
    document.body.appendChild(container);
    
    // åŠ¨ç”»æ˜¾ç¤ºï¼Œä½¿ç”¨å¯è§åº¦æ§åˆ¶
    setTimeout(() => {
        // åº”ç”¨å¯è§åº¦æ§åˆ¶ç¡®ä¿ç•Œé¢å¯è§
        VisibilityController.applyVisibilityControl(container, 1);
        textElem.style.transform = 'scale(1.2) rotate(5deg)';
        
        // éœ‡åŠ¨å±å¹•
        shakeScreen(5);
        
        // åˆ›å»ºéœ‡æ’¼æ³¢çº¹æ•ˆæœ
        if (!isLowPerformanceDevice) {
            createShockwave();
        }
        
        // è§¦å‘éœ‡åŠ¨åé¦ˆ
        try {
            if (navigator.vibrate) {
                navigator.vibrate([30, 50, 100, 50, 30]);
            }
        } catch (e) {}
        
        setTimeout(() => {
            // æ·¡å‡º
            textElem.style.transform = 'scale(0.8) rotate(0deg)';
            container.style.opacity = '0';
            
            setTimeout(() => {
                if (document.body.contains(container)) {
                    document.body.removeChild(container);
                }
            }, 500);
        }, 1500);
    }, 10);
}

// åˆ›å»ºå†²å‡»æ³¢æ•ˆæœ
function createShockwave() {
    const shockwave = document.createElement('div');
    shockwave.style.position = 'fixed';
    shockwave.style.top = '50%';
    shockwave.style.left = '50%';
    shockwave.style.transform = 'translate(-50%, -50%) scale(0)';
    shockwave.style.width = '10px';
    shockwave.style.height = '10px';
    shockwave.style.borderRadius = '50%';
    shockwave.style.boxShadow = '0 0 0 2px rgba(255, 255, 255, 0.8)';
    shockwave.style.zIndex = '190';
    shockwave.style.pointerEvents = 'none';
    
    document.body.appendChild(shockwave);
    
    // åŠ¨ç”»
    shockwave.animate([
        { transform: 'translate(-50%, -50%) scale(0)', opacity: 0.8 },
        { transform: 'translate(-50%, -50%) scale(20)', opacity: 0 }
    ], {
        duration: 1000,
        easing: 'cubic-bezier(0.215, 0.610, 0.355, 1.000)'
    }).onfinish = () => {
        if (document.body.contains(shockwave)) {
            document.body.removeChild(shockwave);
        }
    };
}

// è·å–éšæœºæƒ…ç»ªé¢œè‰²
function getRandomEmotionColor(intensity) {
    // æ ¹æ®å¼ºåº¦é€‰æ‹©ä¸åŒçš„é¢œè‰²èŒƒå›´
    let hue;
    if (intensity > 80) {
        // é«˜å¼ºåº¦ - çº¢è‰²åˆ°æ©™è‰²
        hue = Math.floor(Math.random() * 30);
    } else if (intensity > 50) {
        // ä¸­å¼ºåº¦ - æ©™è‰²åˆ°é»„è‰²
        hue = Math.floor(30 + Math.random() * 30);
    } else {
        // ä½å¼ºåº¦ - æ›´å¹¿æ³›çš„é¢œè‰²
        hue = Math.floor(Math.random() * 60);
    }
    
    const saturation = 70 + Math.random() * 30;
    const lightness = 50 + Math.random() * 20;
    
    return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
}

// å¼¹è·³æ–‡å­—æ•ˆæœ - åœ¨ä½å¼ºåº¦æ—¶ä½¿ç”¨
function createBouncingText(intensity) {
    if (intensity > 70 || intensity < 20) return; // åªåœ¨ä¸­ä½å¼ºåº¦æ—¶ä½¿ç”¨
    
    // æ–‡å­—å†…å®¹
    const texts = ['å“ˆ', 'å˜¿', 'å˜»', 'Ha', 'Hey', 'Yo', 'Hi'];
    const selectedText = texts[Math.floor(Math.random() * texts.length)];
    
    // åˆ›å»ºå…ƒç´ 
    const textElem = document.createElement('div');
    textElem.textContent = selectedText;
    textElem.style.position = 'absolute';
    textElem.style.zIndex = '40';
    textElem.style.color = getRandomEmotionColor(intensity);
    textElem.style.fontSize = `${18 + Math.random() * 10}px`;
    textElem.style.fontWeight = 'bold';
    textElem.style.userSelect = 'none';
    textElem.style.pointerEvents = 'none';
    
    // éšæœºä½ç½® - ä»å±å¹•åº•éƒ¨å¼¹å‡º
    const x = Math.random() * window.innerWidth;
    textElem.style.left = `${x}px`;
    textElem.style.top = `${window.innerHeight}px`;
    
    document.body.appendChild(textElem);
    
    // åŠ¨ç”»
    const jumpHeight = 100 + Math.random() * 150;
    const endX = x + (Math.random() - 0.5) * 100; // éšæœºæ¨ªå‘åç§»
    
    textElem.animate([
        { 
            transform: 'scale(0.5) rotate(-5deg)', 
            top: `${window.innerHeight}px`,
            left: `${x}px`
        },
        { 
            transform: 'scale(1.2) rotate(5deg)', 
            top: `${window.innerHeight - jumpHeight}px`,
            left: `${(x + endX) / 2}px`,
            offset: 0.5 
        },
        { 
            transform: 'scale(0.8) rotate(-2deg)', 
            top: `${window.innerHeight}px`,
            left: `${endX}px`
        }
    ], {
        duration: 800 + Math.random() * 500,
        easing: 'cubic-bezier(0.175, 0.885, 0.32, 1.275)'
    }).onfinish = () => {
        if (document.body.contains(textElem)) {
            document.body.removeChild(textElem);
        }
    };
}

/**
 * 3. é™„åŠ åŠŸèƒ½ä¸å½©è›‹
 */

// æƒ…ç»ªç“¶ - ä¿å­˜å½“å‰æƒ…ç»ªçŠ¶æ€
function createEmotionBottle(intensity, mode) {
    // åˆ›å»ºæƒ…ç»ªç“¶ç•Œé¢
    const bottleContainer = document.createElement('div');
    bottleContainer.style.position = 'fixed';
    bottleContainer.style.top = '50%';
    bottleContainer.style.left = '50%';
    bottleContainer.style.transform = 'translate(-50%, -50%)';
    bottleContainer.style.width = '300px';
    bottleContainer.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
    bottleContainer.style.borderRadius = '10px';
    bottleContainer.style.boxShadow = '0 5px 20px rgba(0, 0, 0, 0.2)';
    bottleContainer.style.padding = '20px';
    bottleContainer.style.zIndex = '1000';
    bottleContainer.style.display = 'flex';
    bottleContainer.style.flexDirection = 'column';
    bottleContainer.style.alignItems = 'center';
    bottleContainer.style.opacity = '0';
    bottleContainer.style.transition = 'opacity 0.3s, transform 0.3s';
    
    // æ ‡é¢˜
    const title = document.createElement('h3');
    title.textContent = 'ä¿å­˜æƒ…ç»ªç“¶';
    title.style.marginBottom = '15px';
    bottleContainer.appendChild(title);
    
    // ç“¶å­å¯è§†åŒ–
    const bottleVisual = document.createElement('div');
    bottleVisual.style.width = '80px';
    bottleVisual.style.height = '120px';
    bottleVisual.style.position = 'relative';
    bottleVisual.style.margin = '10px 0 20px';
    
    // ç“¶å­è½®å»“
    const bottleOutline = document.createElement('div');
    bottleOutline.style.width = '80px';
    bottleOutline.style.height = '120px';
    bottleOutline.style.borderRadius = '5px 5px 40px 40px';
    bottleOutline.style.border = '3px solid #ccc';
    bottleOutline.style.position = 'absolute';
    bottleOutline.style.overflow = 'hidden';
    
    // ç“¶å­ç›–å­
    const bottleCap = document.createElement('div');
    bottleCap.style.width = '40px';
    bottleCap.style.height = '15px';
    bottleCap.style.backgroundColor = '#aaa';
    bottleCap.style.borderRadius = '5px';
    bottleCap.style.position = 'absolute';
    bottleCap.style.top = '-15px';
    bottleCap.style.left = '20px';
    
    // ç“¶å†…æ¶²ä½“
    const bottleLiquid = document.createElement('div');
    bottleLiquid.style.width = '100%';
    bottleLiquid.style.height = `${intensity}%`;
    bottleLiquid.style.backgroundColor = getBottleColor(intensity, mode);
    bottleLiquid.style.position = 'absolute';
    bottleLiquid.style.bottom = '0';
    bottleLiquid.style.borderRadius = '0 0 37px 37px';
    bottleLiquid.style.transition = 'height 1s';
    
    bottleOutline.appendChild(bottleLiquid);
    bottleVisual.appendChild(bottleOutline);
    bottleVisual.appendChild(bottleCap);
    bottleContainer.appendChild(bottleVisual);
    
    // æƒ…ç»ªæè¿°è¾“å…¥
    const emotionDesc = document.createElement('textarea');
    emotionDesc.placeholder = 'æè¿°ä½ ç°åœ¨çš„å¿ƒæƒ…...';
    emotionDesc.style.width = '100%';
    emotionDesc.style.height = '80px';
    emotionDesc.style.padding = '10px';
    emotionDesc.style.borderRadius = '5px';
    emotionDesc.style.border = '1px solid #ddd';
    emotionDesc.style.resize = 'none';
    emotionDesc.style.marginBottom = '15px';
    emotionDesc.style.fontFamily = 'inherit';
    bottleContainer.appendChild(emotionDesc);
    
    // æŒ‰é’®å®¹å™¨
    const btnContainer = document.createElement('div');
    btnContainer.style.display = 'flex';
    btnContainer.style.width = '100%';
    btnContainer.style.justifyContent = 'space-between';
    
    // å–æ¶ˆæŒ‰é’®
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'å–æ¶ˆ';
    cancelBtn.style.padding = '8px 15px';
    cancelBtn.style.border = 'none';
    cancelBtn.style.borderRadius = '5px';
    cancelBtn.style.backgroundColor = '#f0f0f0';
    cancelBtn.style.cursor = 'pointer';
    cancelBtn.style.flex = '1';
    cancelBtn.style.marginRight = '10px';
    
    // ä¿å­˜æŒ‰é’®
    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'ä¿å­˜ç“¶å­';
    saveBtn.style.padding = '8px 15px';
    saveBtn.style.border = 'none';
    saveBtn.style.borderRadius = '5px';
    saveBtn.style.backgroundColor = '#4CAF50';
    saveBtn.style.color = 'white';
    saveBtn.style.cursor = 'pointer';
    saveBtn.style.flex = '1';
    
    btnContainer.appendChild(cancelBtn);
    btnContainer.appendChild(saveBtn);
    bottleContainer.appendChild(btnContainer);
    
    // æŒ‰é’®äº‹ä»¶
    cancelBtn.addEventListener('click', () => {
        closeEmotionBottle();
    });
    
    saveBtn.addEventListener('click', () => {
        saveEmotionToBottle(intensity, mode, emotionDesc.value);
        closeEmotionBottle();
        showSavedNotification();
    });
    
    // å…³é—­å‡½æ•°
    function closeEmotionBottle() {
        bottleContainer.style.opacity = '0';
        bottleContainer.style.transform = 'translate(-50%, -50%) scale(0.9)';
        
        setTimeout(() => {
            if (document.body.contains(bottleContainer)) {
                document.body.removeChild(bottleContainer);
            }
        }, 300);
    }
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(bottleContainer);
    
    // åŠ¨ç”»æ˜¾ç¤º
    setTimeout(() => {
        bottleContainer.style.opacity = '1';
        bottleContainer.style.transform = 'translate(-50%, -50%) scale(1)';
    }, 10);
}

// æ ¹æ®å¼ºåº¦å’Œæ¨¡å¼è·å–ç“¶å­é¢œè‰²
function getBottleColor(intensity, mode) {
    let hue;
    
    switch (mode) {
        case 'calm':
            hue = 120 - (intensity * 0.6); // ç»¿è‰²åˆ°é»„è‰²
            break;
        case 'release':
            hue = 40 - (intensity * 0.3); // é»„è‰²åˆ°æ©™è‰²
            break;
        case 'fury':
            hue = 360 - (intensity * 0.6); // çº¢è‰²èŒƒå›´
            break;
        default:
            hue = 120 - intensity; // é»˜è®¤ç»¿è‰²åˆ°çº¢è‰²
    }
    
    return `hsl(${hue}, ${70 + intensity/4}%, ${50 + (100-intensity)/8}%)`;
}

// ä¿å­˜æƒ…ç»ªåˆ°ç“¶å­
function saveEmotionToBottle(intensity, mode, description) {
    const bottleData = JSON.parse(localStorage.getItem('emotionBottles') || '[]');
    
    bottleData.push({
        timestamp: Date.now(),
        intensity: intensity,
        mode: mode,
        description: description,
        weather: currentWeather
    });
    
    // é™åˆ¶ç“¶å­æ•°é‡
    if (bottleData.length > 20) {
        bottleData.shift();
    }
    
    localStorage.setItem('emotionBottles', JSON.stringify(bottleData));
}

// æ˜¾ç¤ºä¿å­˜æˆåŠŸé€šçŸ¥
function showSavedNotification() {
    const notification = document.createElement('div');
    notification.style.position = 'fixed';
    notification.style.bottom = '20px';
    notification.style.left = '50%';
    notification.style.transform = 'translateX(-50%)';
    notification.style.backgroundColor = '#4CAF50';
    notification.style.color = 'white';
    notification.style.padding = '10px 20px';
    notification.style.borderRadius = '5px';
    notification.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.2)';
    notification.style.zIndex = '1000';
    notification.style.opacity = '0';
    notification.style.transition = 'opacity 0.3s, transform 0.3s';
    notification.innerHTML = `<strong>æƒ…ç»ªç“¶ä¿å­˜æˆåŠŸ!</strong><br>ä½ å¯ä»¥åœ¨"æƒ…ç»ªç“¶æ”¶è—"ä¸­æŸ¥çœ‹`;
    
    document.body.appendChild(notification);
    
    // åŠ¨ç”»æ˜¾ç¤º
    setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(-50%) scale(1.05)';
        
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(-50%) scale(0.95)';
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }, 10);
}

// åˆ›å»ºæƒ…ç»ªç“¶æŒ‰é’®
function createEmotionBottleButton() {
    // å¦‚æœå·²å­˜åœ¨ï¼Œåˆ™ä¸é‡å¤åˆ›å»º
    if (document.getElementById('emotionBottleButton')) return;
    
    const bottleBtn = document.createElement('div');
    bottleBtn.id = 'emotionBottleButton';
    bottleBtn.style.position = 'absolute';
    bottleBtn.style.bottom = '20px';
    bottleBtn.style.left = '20px';
    bottleBtn.style.background = 'rgba(255, 255, 255, 0.8)';
    bottleBtn.style.borderRadius = '5px';
    bottleBtn.style.padding = '8px 12px';
    bottleBtn.style.fontSize = '14px';
    bottleBtn.style.cursor = 'pointer';
    bottleBtn.style.display = 'flex';
    bottleBtn.style.alignItems = 'center';
    bottleBtn.style.boxShadow = '0 2px 5px rgba(0, 0, 0, 0.1)';
    bottleBtn.style.zIndex = '10';
    bottleBtn.style.transition = 'transform 0.3s, box-shadow 0.3s';
    
    // å›¾æ ‡
    const icon = document.createElement('span');
    icon.textContent = 'ğŸ§ª';
    icon.style.marginRight = '5px';
    
    const text = document.createElement('span');
    text.textContent = 'æƒ…ç»ªç“¶';
    
    bottleBtn.appendChild(icon);
    bottleBtn.appendChild(text);
    
    // æ‚¬åœæ•ˆæœ
    bottleBtn.addEventListener('mouseenter', () => {
        bottleBtn.style.transform = 'scale(1.05)';
        bottleBtn.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.15)';
    });
    
    bottleBtn.addEventListener('mouseleave', () => {
        bottleBtn.style.transform = 'scale(1)';
        bottleBtn.style.boxShadow = '0 2px 5px rgba(0, 0, 0, 0.1)';
    });
    
    // ç‚¹å‡»äº‹ä»¶ - æ ¹æ®å½“å‰çŠ¶æ€ä¸åŒè¡Œä¸º
    bottleBtn.addEventListener('click', () => {
        if (intensity >= 30) {
            // å½“å‰æœ‰è¶³å¤Ÿçš„æƒ…ç»ªå¼ºåº¦ï¼Œå¯ä»¥ä¿å­˜
            createEmotionBottle(intensity, currentMode);
        } else {
            // æƒ…ç»ªå¼ºåº¦ä¸è¶³ï¼Œæ˜¾ç¤ºç“¶å­æ”¶è—
            showEmotionBottleCollection();
        }
        
        // è§¦å‘éœ‡åŠ¨åé¦ˆ
        try {
            if (navigator.vibrate) {
                navigator.vibrate(20);
            }
        } catch (e) {}
    });
    
    document.body.appendChild(bottleBtn);
    return bottleBtn;
}

// æ˜¾ç¤ºæƒ…ç»ªç“¶æ”¶è—
function showEmotionBottleCollection() {
    // åˆ›å»ºæƒ…ç»ªç“¶æ”¶è—ç•Œé¢
    const collectionContainer = document.createElement('div');
    collectionContainer.style.position = 'fixed';
    collectionContainer.style.top = '50%';
    collectionContainer.style.left = '50%';
    collectionContainer.style.transform = 'translate(-50%, -50%)';
    collectionContainer.style.width = '90%';
    collectionContainer.style.maxWidth = '500px';
    collectionContainer.style.maxHeight = '80vh';
    collectionContainer.style.backgroundColor = 'rgba(255, 255, 255, 0.95)';
    collectionContainer.style.borderRadius = '10px';
    collectionContainer.style.boxShadow = '0 5px 20px rgba(0, 0, 0, 0.3)';
    collectionContainer.style.padding = '20px';
    collectionContainer.style.zIndex = '1000';
    collectionContainer.style.overflowY = 'auto';
    collectionContainer.style.opacity = '0';
    collectionContainer.style.transition = 'opacity 0.3s, transform 0.3s';
    
    // æ ‡é¢˜
    const title = document.createElement('h3');
    title.textContent = 'æƒ…ç»ªç“¶æ”¶è—';
    title.style.marginBottom = '15px';
    title.style.textAlign = 'center';
    collectionContainer.appendChild(title);
    
    // è·å–æƒ…ç»ªç“¶æ•°æ®
    const bottleData = JSON.parse(localStorage.getItem('emotionBottles') || '[]');
    
    if (bottleData.length === 0) {
        // ç©ºæ”¶è—æç¤º
        const emptyMessage = document.createElement('div');
        emptyMessage.style.textAlign = 'center';
        emptyMessage.style.padding = '30px 0';
        emptyMessage.style.color = '#666';
        emptyMessage.innerHTML = 'ä½ çš„æ”¶è—è¿˜æ˜¯ç©ºçš„<br>å°–å«å¹¶å°†æƒ…ç»ªä¿å­˜åˆ°ç“¶å­é‡Œå§!';
        collectionContainer.appendChild(emptyMessage);
    } else {
        // åˆ›å»ºç“¶å­ç½‘æ ¼
        const bottleGrid = document.createElement('div');
        bottleGrid.style.display = 'grid';
        bottleGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(100px, 1fr))';
        bottleGrid.style.gap = '15px';
        bottleGrid.style.marginBottom = '20px';
        
        // é€†åºæ˜¾ç¤ºç“¶å­ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
        bottleData.slice().reverse().forEach((bottle, index) => {
            const bottleItem = document.createElement('div');
            bottleItem.style.display = 'flex';
            bottleItem.style.flexDirection = 'column';
            bottleItem.style.alignItems = 'center';
            bottleItem.style.cursor = 'pointer';
            
            // ç“¶å­å¯è§†åŒ–
            const bottleVisual = document.createElement('div');
            bottleVisual.style.width = '40px';
            bottleVisual.style.height = '70px';
            bottleVisual.style.position = 'relative';
            bottleVisual.style.marginBottom = '5px';
            
            // ç“¶å­è½®å»“
            const bottleOutline = document.createElement('div');
            bottleOutline.style.width = '40px';
            bottleOutline.style.height = '70px';
            bottleOutline.style.borderRadius = '3px 3px 20px 20px';
            bottleOutline.style.border = '2px solid #ccc';
            bottleOutline.style.position = 'absolute';
            bottleOutline.style.overflow = 'hidden';
            
            // ç“¶å­ç›–å­
            const bottleCap = document.createElement('div');
            bottleCap.style.width = '20px';
            bottleCap.style.height = '8px';
            bottleCap.style.backgroundColor = '#aaa';
            bottleCap.style.borderRadius = '3px';
            bottleCap.style.position = 'absolute';
            bottleCap.style.top = '-8px';
            bottleCap.style.left = '10px';
            
            // ç“¶å†…æ¶²ä½“
            const bottleLiquid = document.createElement('div');
            bottleLiquid.style.width = '100%';
            bottleLiquid.style.height = `${bottle.intensity}%`;
            bottleLiquid.style.backgroundColor = getBottleColor(bottle.intensity, bottle.mode);
            bottleLiquid.style.position = 'absolute';
            bottleLiquid.style.bottom = '0';
            bottleLiquid.style.borderRadius = '0 0 18px 18px';
            
            bottleOutline.appendChild(bottleLiquid);
            bottleVisual.appendChild(bottleOutline);
            bottleVisual.appendChild(bottleCap);
            
            // æ—¥æœŸæ ‡ç­¾
            const date = new Date(bottle.timestamp);
            const dateLabel = document.createElement('div');
            dateLabel.textContent = `${date.getMonth() + 1}/${date.getDate()}`;
            dateLabel.style.fontSize = '12px';
            dateLabel.style.color = '#666';
            
            bottleItem.appendChild(bottleVisual);
            bottleItem.appendChild(dateLabel);
            
            // ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
            bottleItem.addEventListener('click', () => {
                showBottleDetails(bottle);
            });
            
            bottleGrid.appendChild(bottleItem);
        });
        
        collectionContainer.appendChild(bottleGrid);
    }
    
    // å…³é—­æŒ‰é’®
    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'å…³é—­';
    closeBtn.style.display = 'block';
    closeBtn.style.width = '100%';
    closeBtn.style.padding = '10px';
    closeBtn.style.border = 'none';
    closeBtn.style.borderRadius = '5px';
    closeBtn.style.backgroundColor = '#f0f0f0';
    closeBtn.style.cursor = 'pointer';
    closeBtn.style.marginTop = '10px';
    
    closeBtn.addEventListener('click', () => {
        collectionContainer.style.opacity = '0';
        collectionContainer.style.transform = 'translate(-50%, -50%) scale(0.9)';
        
        setTimeout(() => {
            if (document.body.contains(collectionContainer)) {
                document.body.removeChild(collectionContainer);
            }
        }, 300);
    });
    
    collectionContainer.appendChild(closeBtn);
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(collectionContainer);
    
    // åŠ¨ç”»æ˜¾ç¤º
    setTimeout(() => {
        collectionContainer.style.opacity = '1';
        collectionContainer.style.transform = 'translate(-50%, -50%) scale(1)';
    }, 10);
}

// æ˜¾ç¤ºç“¶å­è¯¦æƒ…
function showBottleDetails(bottle) {
    // åˆ›å»ºè¯¦æƒ…ç•Œé¢
    const detailsContainer = document.createElement('div');
    detailsContainer.style.position = 'fixed';
    detailsContainer.style.top = '50%';
    detailsContainer.style.left = '50%';
    detailsContainer.style.transform = 'translate(-50%, -50%)';
    detailsContainer.style.width = '300px';
    detailsContainer.style.backgroundColor = 'rgba(255, 255, 255, 0.95)';
    detailsContainer.style.borderRadius = '10px';
    detailsContainer.style.boxShadow = '0 5px 20px rgba(0, 0, 0, 0.3)';
    detailsContainer.style.padding = '20px';
    detailsContainer.style.zIndex = '1001';
    detailsContainer.style.opacity = '0';
    detailsContainer.style.transition = 'opacity 0.3s, transform 0.3s';
    
    // æ ‡é¢˜
    const title = document.createElement('h3');
    title.textContent = 'æƒ…ç»ªç“¶è¯¦æƒ…';
    title.style.marginBottom = '15px';
    title.style.textAlign = 'center';
    detailsContainer.appendChild(title);
    
    // ç“¶å­å¯è§†åŒ– - å¤§ç‰ˆæœ¬
    const bottleVisual = document.createElement('div');
    bottleVisual.style.width = '80px';
    bottleVisual.style.height = '120px';
    bottleVisual.style.position = 'relative';
    bottleVisual.style.margin = '0 auto 20px';
    
    // ç“¶å­è½®å»“
    const bottleOutline = document.createElement('div');
    bottleOutline.style.width = '80px';
    bottleOutline.style.height = '120px';
    bottleOutline.style.borderRadius = '5px 5px 40px 40px';
    bottleOutline.style.border = '3px solid #ccc';
    bottleOutline.style.position = 'absolute';
    bottleOutline.style.overflow = 'hidden';
    
    // ç“¶å­ç›–å­
    const bottleCap = document.createElement('div');
    bottleCap.style.width = '40px';
    bottleCap.style.height = '15px';
    bottleCap.style.backgroundColor = '#aaa';
    bottleCap.style.borderRadius = '5px';
    bottleCap.style.position = 'absolute';
    bottleCap.style.top = '-15px';
    bottleCap.style.left = '20px';
    
    // ç“¶å†…æ¶²ä½“
    const bottleLiquid = document.createElement('div');
    bottleLiquid.style.width = '100%';
    bottleLiquid.style.height = '0%';
    bottleLiquid.style.backgroundColor = getBottleColor(bottle.intensity, bottle.mode);
    bottleLiquid.style.position = 'absolute';
    bottleLiquid.style.bottom = '0';
    bottleLiquid.style.borderRadius = '0 0 37px 37px';
    bottleLiquid.style.transition = 'height 1s';
    
    bottleOutline.appendChild(bottleLiquid);
    bottleVisual.appendChild(bottleOutline);
    bottleVisual.appendChild(bottleCap);
    detailsContainer.appendChild(bottleVisual);
    
    // è¯¦æƒ…ä¿¡æ¯
    const detailsInfo = document.createElement('div');
    detailsInfo.style.backgroundColor = '#f9f9f9';
    detailsInfo.style.padding = '15px';
    detailsInfo.style.borderRadius = '5px';
    detailsInfo.style.marginBottom = '15px';
    
    const date = new Date(bottle.timestamp);
    const dateFormatted = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
    
    detailsInfo.innerHTML = `
        <div style="margin-bottom: 8px;"><strong>ä¿å­˜æ—¶é—´:</strong> ${dateFormatted}</div>
        <div style="margin-bottom: 8px;"><strong>æƒ…ç»ªå¼ºåº¦:</strong> <span style="color: ${getIntensityColor(bottle.intensity)};">${Math.round(bottle.intensity)}%</span></div>
        <div style="margin-bottom: 8px;"><strong>æƒ…ç»ªæ¨¡å¼:</strong> ${bottle.mode === 'calm' ? 'å¹³é™' : bottle.mode === 'release' ? 'é‡Šæ”¾' : 'ç‹‚æ€’'}</div>
        <div><strong>æƒ…ç»ªå¤©æ°”:</strong> ${(weatherTypes.find(w => w.id === bottle.weather) || weatherTypes[0]).name} ${(weatherTypes.find(w => w.id === bottle.weather) || weatherTypes[0]).icon}</div>
    `;
    
    detailsContainer.appendChild(detailsInfo);
    
    // æƒ…ç»ªæè¿°
    if (bottle.description) {
        const descriptionContainer = document.createElement('div');
        descriptionContainer.style.marginBottom = '15px';
        
        const descriptionTitle = document.createElement('div');
        descriptionTitle.textContent = 'æƒ…ç»ªæè¿°:';
        descriptionTitle.style.fontWeight = 'bold';
        descriptionTitle.style.marginBottom = '5px';
        
        const descriptionText = document.createElement('div');
        descriptionText.textContent = bottle.description;
        descriptionText.style.backgroundColor = '#f0f0f0';
        descriptionText.style.padding = '10px';
        descriptionText.style.borderRadius = '5px';
        descriptionText.style.fontSize = '14px';
        
        descriptionContainer.appendChild(descriptionTitle);
        descriptionContainer.appendChild(descriptionText);
        detailsContainer.appendChild(descriptionContainer);
    }
    
    // æŒ‰é’®å®¹å™¨
    const btnContainer = document.createElement('div');
    btnContainer.style.display = 'flex';
    btnContainer.style.justifyContent = 'space-between';
    
    // åˆ é™¤æŒ‰é’®
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'åˆ é™¤ç“¶å­';
    deleteBtn.style.padding = '8px 15px';
    deleteBtn.style.border = 'none';
    deleteBtn.style.borderRadius = '5px';
    deleteBtn.style.backgroundColor = '#f44336';
    deleteBtn.style.color = 'white';
    deleteBtn.style.cursor = 'pointer';
    deleteBtn.style.flex = '1';
    deleteBtn.style.marginRight = '10px';
    
    // å…³é—­æŒ‰é’®
    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'å…³é—­';
    closeBtn.style.padding = '8px 15px';
    closeBtn.style.border = 'none';
    closeBtn.style.borderRadius = '5px';
    closeBtn.style.backgroundColor = '#f0f0f0';
    closeBtn.style.cursor = 'pointer';
    closeBtn.style.flex = '1';
    
    btnContainer.appendChild(deleteBtn);
    btnContainer.appendChild(closeBtn);
    detailsContainer.appendChild(btnContainer);
    
    // æŒ‰é’®äº‹ä»¶
    deleteBtn.addEventListener('click', () => {
        deleteEmotionBottle(bottle.timestamp);
        closeDetails();
        
        // é‡æ–°æ˜¾ç¤ºæ”¶è—
        setTimeout(() => {
            showEmotionBottleCollection();
        }, 300);
    });
    
    closeBtn.addEventListener('click', () => {
        closeDetails();
    });
    
    // å…³é—­å‡½æ•°
    function closeDetails() {
        detailsContainer.style.opacity = '0';
        detailsContainer.style.transform = 'translate(-50%, -50%) scale(0.9)';
        
        setTimeout(() => {
            if (document.body.contains(detailsContainer)) {
                document.body.removeChild(detailsContainer);
            }
        }, 300);
    }
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(detailsContainer);
    
    // åŠ¨ç”»æ˜¾ç¤º
    setTimeout(() => {
        detailsContainer.style.opacity = '1';
        detailsContainer.style.transform = 'translate(-50%, -50%) scale(1)';
        
        // æ¶²ä½“åŠ¨ç”»
        setTimeout(() => {
            bottleLiquid.style.height = `${bottle.intensity}%`;
        }, 300);
    }, 10);
}

// åˆ é™¤æƒ…ç»ªç“¶
function deleteEmotionBottle(timestamp) {
    const bottleData = JSON.parse(localStorage.getItem('emotionBottles') || '[]');
    const updatedData = bottleData.filter(bottle => bottle.timestamp !== timestamp);
    localStorage.setItem('emotionBottles', JSON.stringify(updatedData));
    
    // æ˜¾ç¤ºåˆ é™¤æˆåŠŸæç¤º
    const notification = document.createElement('div');
    notification.style.position = 'fixed';
    notification.style.bottom = '20px';
    notification.style.left = '50%';
    notification.style.transform = 'translateX(-50%)';
    notification.style.backgroundColor = '#f44336';
    notification.style.color = 'white';
    notification.style.padding = '10px 20px';
    notification.style.borderRadius = '5px';
    notification.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.2)';
    notification.style.zIndex = '1000';
    notification.style.opacity = '0';
    notification.style.transition = 'opacity 0.3s, transform 0.3s';
    notification.textContent = 'æƒ…ç»ªç“¶å·²åˆ é™¤';
    
    document.body.appendChild(notification);
    
    // åŠ¨ç”»æ˜¾ç¤º
    setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(-50%) scale(1.05)';
        
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(-50%) scale(0.95)';
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 2000);
    }, 10);
}

// åˆ›å»ºéšæœºå½©è›‹åŠŸèƒ½ - æœ‰10%çš„æ¦‚ç‡åœ¨é«˜å¼ºåº¦å°–å«åè§¦å‘
function createRandomEasterEgg(intensity) {
    if (intensity < 80 || Math.random() > 0.1) return;
    
    // å¯ç”¨çš„å½©è›‹åˆ—è¡¨
    const easterEggs = [
        createFallingStars,
        createRainbowMode,
        createMatrixEffect,
        createHeartExplosion
    ];
    
    // éšæœºé€‰æ‹©ä¸€ä¸ªå½©è›‹
    const randomEgg = easterEggs[Math.floor(Math.random() * easterEggs.length)];
    randomEgg();
    
    // è§£é”å½©è›‹æˆå°±
    const easterEggAchievement = {
        id: 'easter-egg-finder',
        name: 'å½©è›‹å‘ç°è€…',
        description: 'è§¦å‘äº†ä¸€ä¸ªéšè—çš„ç‰¹æ®Šæ•ˆæœ'
    };
    
    // æ£€æŸ¥æ˜¯å¦å·²è§£é”
    const unlockedAchievements = JSON.parse(localStorage.getItem('unlockedAchievements') || '[]');
    if (!unlockedAchievements.includes(easterEggAchievement.id)) {
        unlockAchievement(easterEggAchievement);
    }
}

function createFallingStars() {
    const stars = isLowPerformanceDevice ? 10 : 20;
    
    for (let i = 0; i < stars; i++) {
        setTimeout(() => {
            const star = document.createElement('div');
            star.style.position = 'fixed';
            star.style.width = '3px';
            star.style.height = '3px';
            star.style.backgroundColor = 'white';
            star.style.borderRadius = '50%';
            star.style.boxShadow = '0 0 20px 2px white';
            star.style.top = '0';
            star.style.left = `${Math.random() * 100}%`;
            star.style.zIndex = '50';
            star.style.pointerEvents = 'none';
            
            document.body.appendChild(star);
            
            const duration = 1000 + Math.random() * 2000;
            const endX = parseFloat(star.style.left) + (Math.random() - 0.5) * 50;
            
            star.animate([
                { top: '0%', left: star.style.left, opacity: 1, transform: 'scale(0.3)' },
                { 
                    top: '100%', 
                    left: `${endX}%`, 
                    opacity: 0,
                    transform: 'scale(1.5)'
                }
            ], {
                duration: duration,
                easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
            }).onfinish = () => {
                if (document.body.contains(star)) {
                    document.body.removeChild(star);
                }
            };
            
            // å°¾è¿¹æ•ˆæœ
            for (let j = 0; j < 5; j++) {
                setTimeout(() => {
                    const tail = document.createElement('div');
                    tail.style.position = 'fixed';
                    tail.style.width = '2px';
                    tail.style.height = '2px';
                    tail.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
                    tail.style.borderRadius = '50%';
                    tail.style.top = `${(j + 1) * 2}%`;
                    tail.style.left = `${parseFloat(star.style.left) + ((endX - parseFloat(star.style.left)) * (j + 1) / 10)}%`;
                    tail.style.zIndex = '49';
                    tail.style.pointerEvents = 'none';
                    
                    document.body.appendChild(tail);
                    
                    tail.animate([
                        { opacity: 0.7 },
                        { opacity: 0 }
                    ], {
                        duration: duration - (j * 100),
                        easing: 'ease-out'
                    }).onfinish = () => {
                        if (document.body.contains(tail)) {
                            document.body.removeChild(tail);
                        }
                    };
                }, j * 50);
            }
        }, i * (isLowPerformanceDevice ? 200 : 100));
    }
    
    // ä¸å†æ˜¾ç¤ºå½©è›‹æ ‡é¢˜
    // showEasterEggTitle('æµæ˜Ÿé›¨', 'âœ¨'); - å·²ç§»é™¤
}

/**
 * ä¿®æ”¹ç‰ˆæœ¬çš„å½©è™¹æ¨¡å¼ - ä¸æ˜¾ç¤ºå½©è›‹æ ‡é¢˜
 */
// ä¿®æ”¹å½©è™¹æ¨¡å¼æ•ˆæœ
function createRainbowMode() {
    // åˆ›å»ºå½©è™¹èƒŒæ™¯
    const rainbow = document.createElement('div');
    rainbow.style.position = 'fixed';
    rainbow.style.top = '0';
    rainbow.style.left = '0';
    rainbow.style.width = '100%';
    rainbow.style.height = '100%';
    rainbow.style.background = 'linear-gradient(to bottom, violet, indigo, blue, green, yellow, orange, red)';
    rainbow.style.opacity = '0';
    rainbow.style.transition = 'opacity 1s';
    rainbow.style.zIndex = '-10';
    rainbow.style.pointerEvents = 'none';
    
    document.body.appendChild(rainbow);
    
    // æ˜¾ç¤ºèƒŒæ™¯ï¼Œä½¿ç”¨å¯è§åº¦æ§åˆ¶
    setTimeout(() => {
        // ç¡®ä¿å½©è™¹æ•ˆæœä¸ä¼šå®Œå…¨é®æŒ¡ç•Œé¢
        VisibilityController.applyVisibilityControl(rainbow, 0.2);
        
        // åˆ›å»ºå½©è™¹ç²’å­
        if (!isLowPerformanceDevice) {
            createRainbowParticles();
        }
        
        // 5ç§’åæ·¡å‡º
        setTimeout(() => {
            rainbow.style.opacity = '0';
            
            setTimeout(() => {
                if (document.body.contains(rainbow)) {
                    document.body.removeChild(rainbow);
                }
            }, 1000);
        }, 5000);
    }, 10);
}


// å½©è™¹ç²’å­
function createRainbowParticles() {
    for (let i = 0; i < 30; i++) {
        setTimeout(() => {
            const particle = document.createElement('div');
            particle.style.position = 'fixed';
            particle.style.width = `${5 + Math.random() * 10}px`;
            particle.style.height = particle.style.width;
            particle.style.borderRadius = '50%';
            
            // å½©è™¹è‰²
            const hue = Math.random() * 360;
            particle.style.backgroundColor = `hsl(${hue}, 80%, 60%)`;
            particle.style.boxShadow = `0 0 10px hsl(${hue}, 80%, 60%)`;
            
            // éšæœºä½ç½®
            particle.style.top = `${Math.random() * 100}%`;
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.zIndex = '5';
            particle.style.opacity = '0';
            particle.style.pointerEvents = 'none';
            
            document.body.appendChild(particle);
            
            // åŠ¨ç”»
            const duration = 2000 + Math.random() * 3000;
            const finalY = parseFloat(particle.style.top) + (Math.random() - 0.5) * 50;
            const finalX = parseFloat(particle.style.left) + (Math.random() - 0.5) * 50;
            
            particle.animate([
                { 
                    transform: 'scale(0) rotate(0deg)', 
                    opacity: 0,
                    top: particle.style.top,
                    left: particle.style.left 
                },
                { 
                    transform: 'scale(1) rotate(180deg)', 
                    opacity: 0.8,
                    top: `${(parseFloat(particle.style.top) + finalY) / 2}%`,
                    left: `${(parseFloat(particle.style.left) + finalX) / 2}%`,
                    offset: 0.5 
                },
                { 
                    transform: 'scale(0) rotate(360deg)', 
                    opacity: 0,
                    top: `${finalY}%`,
                    left: `${finalX}%` 
                }
            ], {
                duration: duration,
                easing: 'ease-in-out'
            }).onfinish = () => {
                if (document.body.contains(particle)) {
                    document.body.removeChild(particle);
                }
            };
        }, i * 100);
    }
}

// å½©è›‹3: é»‘å®¢å¸å›½æ•ˆæœ
// ä¿®æ”¹ Matrix æ•ˆæœå‡½æ•°ç¡®ä¿å¯è§åº¦
function createMatrixEffect() {
    // åˆ›å»ºåŠé€æ˜é»‘è‰²èƒŒæ™¯ï¼Œä½¿ç”¨VisibilityControllerç¡®ä¿å¯è§åº¦
    const matrix = document.createElement('div');
    matrix.style.position = 'fixed';
    matrix.style.top = '0';
    matrix.style.left = '0';
    matrix.style.width = '100%';
    matrix.style.height = '100%';
    matrix.style.backgroundColor = 'rgba(0, 0, 0, 0.7)'; // åˆå§‹é€æ˜åº¦è®¾ç½®ä¸º0.7
    matrix.style.opacity = '0';
    matrix.style.transition = 'opacity 1s';
    matrix.style.zIndex = '100';
    matrix.style.pointerEvents = 'none';
    
    document.body.appendChild(matrix);
    
    // ä½¿ç”¨VisibilityControlleræ§åˆ¶æ˜¾ç¤º
    setTimeout(() => {
        // åº”ç”¨å¯è§åº¦æ§åˆ¶ï¼Œé™åˆ¶æœ€å¤§ä¸é€æ˜åº¦
        VisibilityController.applyVisibilityControl(matrix, 1);
        
        // åˆ›å»ºæ‰è½æ–‡å­—
        if (!isLowPerformanceDevice) {
            createMatrixText(matrix);
        }
        
        // 5ç§’åæ·¡å‡º
        setTimeout(() => {
            matrix.style.opacity = '0';
            
            setTimeout(() => {
                if (document.body.contains(matrix)) {
                    document.body.removeChild(matrix);
                }
            }, 1000);
        }, 5000);
    }, 10);
}

// é»‘å®¢å¸å›½æ–‡å­—
function createMatrixText(container) {
    const columns = isLowPerformanceDevice ? 10 : Math.floor(window.innerWidth / 20);
    
    for (let i = 0; i < columns; i++) {
        const column = document.createElement('div');
        column.style.position = 'absolute';
        column.style.top = '0';
        column.style.left = `${(i / columns) * 100}%`;
        column.style.width = `${100 / columns}%`;
        column.style.textAlign = 'center';
        column.style.color = '#0f0';
        column.style.fontSize = '14px';
        column.style.fontFamily = 'monospace';
        column.style.whiteSpace = 'nowrap';
        
        container.appendChild(column);
        
        // åˆå§‹å»¶è¿Ÿ
        const delay = Math.random() * 2000;
        
        setTimeout(() => {
            let position = -Math.floor(Math.random() * 5);
            const speed = 50 + Math.random() * 100;
            
            // æ·»åŠ å­—ç¬¦
            function addChar() {
                if (!document.body.contains(container) || !document.body.contains(column)) return;
                
                if (position >= 0) {
                    if (position >= 30) {
                        // å¼€å§‹æ·¡å‡ºé¡¶éƒ¨å­—ç¬¦
                        const chars = column.querySelectorAll('span');
                        if (chars.length > 0) {
                            chars[0].style.opacity = '0';
                            setTimeout(() => {
                                if (column.contains(chars[0])) {
                                    column.removeChild(chars[0]);
                                }
                            }, 500);
                        }
                    }
                    
                    const char = document.createElement('span');
                    char.textContent = getRandomMatrixChar();
                    char.style.display = 'block';
                    char.style.opacity = '0';
                    char.style.transition = 'opacity 0.3s';
                    
                    column.appendChild(char);
                    
                    setTimeout(() => {
                        if (document.body.contains(char)) {
                            char.style.opacity = '1';
                        }
                    }, 10);
                }
                
                position++;
                setTimeout(addChar, speed);
            }
            
            addChar();
        }, delay);
    }
}

// éšæœºé»‘å®¢å¸å›½å­—ç¬¦
function getRandomMatrixChar() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789$#%*+=-@";
    return chars.charAt(Math.floor(Math.random() * chars.length));
}

// å½©è›‹4: å¿ƒå½¢çˆ†ç‚¸
function createHeartExplosion() {
    const hearts = isLowPerformanceDevice ? 20 : 50;
    const colors = ['#ff6b6b', '#ff8787', '#fa5252', '#f03e3e', '#e03131'];
    
    // åˆ›å»ºçˆ†ç‚¸ä¸­å¿ƒç‚¹
    const center = {
        x: window.innerWidth / 2,
        y: window.innerHeight / 2
    };
    
    for (let i = 0; i < hearts; i++) {
        setTimeout(() => {
            const heart = document.createElement('div');
            heart.innerHTML = 'â¤ï¸';
            heart.style.position = 'fixed';
            heart.style.fontSize = `${12 + Math.random() * 20}px`;
            heart.style.top = `${center.y}px`;
            heart.style.left = `${center.x}px`;
            heart.style.transform = 'translate(-50%, -50%)';
            heart.style.zIndex = '50';
            heart.style.opacity = '0';
            heart.style.pointerEvents = 'none';
            
            document.body.appendChild(heart);
            
            // éšæœºæ–¹å‘å’Œè·ç¦»
            const angle = Math.random() * Math.PI * 2;
            const distance = 50 + Math.random() * 200;
            const endX = center.x + Math.cos(angle) * distance;
            const endY = center.y + Math.sin(angle) * distance;
            
            // åŠ¨ç”»
            const duration = 1000 + Math.random() * 2000;
            
            heart.animate([
                { 
                    top: `${center.y}px`, 
                    left: `${center.x}px`, 
                    transform: 'translate(-50%, -50%) scale(0.5) rotate(0deg)', 
                    opacity: 0 
                },
                { 
                    top: `${center.y + (endY - center.y) * 0.5}px`, 
                    left: `${center.x + (endX - center.x) * 0.5}px`, 
                    transform: 'translate(-50%, -50%) scale(1.5) rotate(180deg)', 
                    opacity: 1,
                    offset: 0.5 
                },
                { 
                    top: `${endY}px`, 
                    left: `${endX}px`, 
                    transform: 'translate(-50%, -50%) scale(0.5) rotate(360deg)', 
                    opacity: 0 
                }
            ], {
                duration: duration,
                easing: 'cubic-bezier(0.175, 0.885, 0.32, 1.275)'
            }).onfinish = () => {
                if (document.body.contains(heart)) {
                    document.body.removeChild(heart);
                }
            };
        }, i * (isLowPerformanceDevice ? 50 : 30));
    }
    
    // ä¸å†æ˜¾ç¤ºå½©è›‹æ ‡é¢˜
    // showEasterEggTitle('çˆ±çš„çˆ†å‘', 'ğŸ’–'); - å·²ç§»é™¤
}


// æ˜¾ç¤ºå½©è›‹æ ‡é¢˜
function showEasterEggTitle(title, emoji) {
    const titleContainer = document.createElement('div');
    titleContainer.style.position = 'fixed';
    titleContainer.style.top = '20%';
    titleContainer.style.left = '50%';
    titleContainer.style.transform = 'translate(-50%, -50%) scale(0.5)';
    titleContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
    titleContainer.style.color = 'white';
    titleContainer.style.padding = '10px 20px';
    titleContainer.style.borderRadius = '10px';
    titleContainer.style.fontSize = '24px';
    titleContainer.style.fontWeight = 'bold';
    titleContainer.style.zIndex = '200';
    titleContainer.style.opacity = '0';
    titleContainer.style.transition = 'all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
    titleContainer.style.textAlign = 'center';
    titleContainer.style.pointerEvents = 'none';
    
    titleContainer.innerHTML = `
        <div style="font-size: 30px; margin-bottom: 5px;">${emoji}</div>
        <div>å½©è›‹è§¦å‘: ${title}</div>
    `;
    
    document.body.appendChild(titleContainer);
    
    // åŠ¨ç”»æ˜¾ç¤º
    setTimeout(() => {
        titleContainer.style.opacity = '1';
        titleContainer.style.transform = 'translate(-50%, -50%) scale(1)';
        
        setTimeout(() => {
            titleContainer.style.opacity = '0';
            titleContainer.style.transform = 'translate(-50%, -50%) scale(1.5)';
            
            setTimeout(() => {
                if (document.body.contains(titleContainer)) {
                    document.body.removeChild(titleContainer);
                }
            }, 500);
        }, 2500);
    }, 10);
}

/**
 * 4. æ ¸å¿ƒå‡½æ•° - éœ€è¦ä¸ç°æœ‰ç³»ç»Ÿé›†æˆçš„å…³é”®å‡½æ•°
 */

// åˆå§‹åŒ–æ‰€æœ‰æ–°åŠŸèƒ½
function initEnhancedFeatures() {
    // åˆ›å»ºæ‰“å¡æŒ‰é’®
    createCheckInButton();
    
    // åˆ›å»ºæƒ…ç»ªç“¶æŒ‰é’®
    createEmotionBottleButton();
    
    // æ·»åŠ æ–°æˆå°±
    addNewAchievements();
}

// æ·»åŠ æ–°æˆå°±
function addNewAchievements() {
    const newAchievements = [
        { id: 'seven-day-streak', name: 'åšæŒä¸€å‘¨', description: 'è¿ç»­7å¤©è¿›è¡Œå°–å«æ‰“å¡' },
        { id: 'bottle-collector', name: 'æƒ…ç»ªæ”¶è—å®¶', description: 'ä¿å­˜10ä¸ªæƒ…ç»ªç“¶' },
        { id: 'easter-egg-finder', name: 'å½©è›‹å‘ç°è€…', description: 'è§¦å‘äº†ä¸€ä¸ªéšè—çš„ç‰¹æ®Šæ•ˆæœ' },
        { id: 'text-explosion', name: 'æ–‡å­—çˆ†å‘', description: 'è§¦å‘äº†å…¨å±æ–‡å­—åŠ¨ç”»æ•ˆæœ' }
    ];
    
    // æ£€æŸ¥ç°æœ‰æˆå°±åˆ—è¡¨ï¼Œå¹¶æ·»åŠ æ–°æˆå°±
    newAchievements.forEach(achievement => {
        const exists = achievements.some(a => a.id === achievement.id);
        if (!exists) {
            achievements.push(achievement);
        }
    });
    
    // åˆ·æ–°æˆå°±åˆ—è¡¨UI
    initAchievements();
}

// æ›´æ–°å‡½æ•° - ä¸ç°æœ‰intensityæ›´æ–°å‡½æ•°é›†æˆ
function updateIntensityWithVisuals(intensity) {
    // æ ¹æ®å¼ºåº¦å†³å®šè§¦å‘ä¸åŒçš„è§†è§‰æ•ˆæœ
    if (intensity >= 70) {
        // é«˜å¼ºåº¦ - æ–‡å­—çˆ†å‘
        createFullscreenTextAnimation(intensity);
        
        // æ£€æŸ¥æ–‡å­—çˆ†å‘æˆå°±
        if (intensity >= 90) {
            const textExplosionAchievement = achievements.find(a => a.id === 'text-explosion');
            if (textExplosionAchievement) {
                const unlockedAchievements = JSON.parse(localStorage.getItem('unlockedAchievements') || '[]');
                if (!unlockedAchievements.includes(textExplosionAchievement.id)) {
                    unlockAchievement(textExplosionAchievement);
                }
            }
        }
        
        // éšæœºå½©è›‹
        createRandomEasterEgg(intensity);
    } else if (intensity >= 20 && intensity < 70) {
        // ä¸­ä½å¼ºåº¦ - å¼¹è·³æ–‡å­—
        if (Math.random() > 0.7) {
            createBouncingText(intensity);
        }
    }
    
    // è‡ªåŠ¨æ‰“å¡
    autoCheckIn(intensity);
    
    // æ£€æŸ¥æƒ…ç»ªç“¶æ”¶è—æˆå°±
    checkBottleCollectorAchievement();
}

// ç»§ç»­ä¸Šä¸€éƒ¨åˆ†ä»£ç  - ä»checkBottleCollectorAchievementå‡½æ•°ç»§ç»­

// æ£€æŸ¥æƒ…ç»ªç“¶æ”¶è—æˆå°±
function checkBottleCollectorAchievement() {
    const bottleData = JSON.parse(localStorage.getItem('emotionBottles') || '[]');
    const bottleCollectorAchievement = achievements.find(a => a.id === 'bottle-collector');
    
    if (bottleCollectorAchievement && bottleData.length >= 10) {
        const unlockedAchievements = JSON.parse(localStorage.getItem('unlockedAchievements') || '[]');
        if (!unlockedAchievements.includes(bottleCollectorAchievement.id)) {
            unlockAchievement(bottleCollectorAchievement);
        }
    }
}

/**
 * 5. é›†æˆå‡½æ•° - å°†æ–°åŠŸèƒ½ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ
 */

// ä¸»è¦é›†æˆå‡½æ•° - ä¿®æ”¹ç°æœ‰çš„updateIntensityDisplayå‡½æ•°
function enhancedUpdateIntensityDisplay() {
    // è°ƒç”¨åŸå§‹å‡½æ•°
    updateIntensityDisplay();
    
    // æ·»åŠ è§†è§‰æ•ˆæœå¢å¼º
    updateIntensityWithVisuals(intensity);
}

// ä¿®æ”¹ç°æœ‰çš„startScreamå‡½æ•°
function enhancedStartScream() {
    // è°ƒç”¨åŸå§‹å‡½æ•°
    startScream();
    
    // å¯èƒ½è§¦å‘éšæœºçš„ç‰¹æ®Šæ•ˆæœ
    if (fxMode && Math.random() > 0.9) {
        setTimeout(() => {
            createFullscreenTextAnimation(intensity);
        }, 500);
    }
}

// ä¿®æ”¹ç°æœ‰çš„stopScreamå‡½æ•°
function enhancedStopScream() {
    // è°ƒç”¨åŸå§‹å‡½æ•°
    stopScream();
    
    // å¦‚æœå¼ºåº¦å¤Ÿé«˜ï¼Œå¯èƒ½å‡ºç°æƒ…ç»ªç“¶æç¤º
    if (intensity >= 80) {
        setTimeout(() => {
            suggestEmotionBottle();
        }, 1000);
    }
}

// ä¿®æ”¹ç°æœ‰çš„checkAchievementså‡½æ•°
function enhancedCheckAchievements() {
    // è°ƒç”¨åŸå§‹å‡½æ•°
    checkAchievements();
    
    // æ£€æŸ¥æ–°æˆå°±
    checkBottleCollectorAchievement();
}

// å»ºè®®ä¿å­˜æƒ…ç»ªç“¶
function suggestEmotionBottle() {
    const suggestion = document.createElement('div');
    suggestion.style.position = 'fixed';
    suggestion.style.bottom = '100px';
    suggestion.style.left = '50%';
    suggestion.style.transform = 'translateX(-50%) scale(0.8)';
    suggestion.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
    suggestion.style.color = '#333';
    suggestion.style.padding = '10px 20px';
    suggestion.style.borderRadius = '5px';
    suggestion.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.2)';
    suggestion.style.zIndex = '100';
    suggestion.style.textAlign = 'center';
    suggestion.style.opacity = '0';
    suggestion.style.transition = 'all 0.3s';
    suggestion.style.cursor = 'pointer';
    
    suggestion.innerHTML = `
        <div style="font-size: 16px; margin-bottom: 5px;">æƒ…ç»ªå¼ºçƒˆï¼Œè¦ä¿å­˜åˆ°æƒ…ç»ªç“¶å—ï¼Ÿ</div>
        <div style="font-size: 12px; color: #666;">ä¿å­˜åå¯ä»¥åœ¨æƒ…ç»ªç“¶ä¸­å›é¡¾</div>
    `;
    
    // ç‚¹å‡»äº‹ä»¶
    suggestion.addEventListener('click', () => {
        // éšè—æç¤º
        suggestion.style.opacity = '0';
        suggestion.style.transform = 'translateX(-50%) scale(0.7)';
        
        setTimeout(() => {
            if (document.body.contains(suggestion)) {
                document.body.removeChild(suggestion);
            }
            
            // æ˜¾ç¤ºæƒ…ç»ªç“¶ä¿å­˜ç•Œé¢
            createEmotionBottle(intensity, currentMode);
        }, 300);
    });
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(suggestion);
    
    // åŠ¨ç”»æ˜¾ç¤º
    setTimeout(() => {
        suggestion.style.opacity = '1';
        suggestion.style.transform = 'translateX(-50%) scale(1)';
        
        // è‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            if (document.body.contains(suggestion)) {
                suggestion.style.opacity = '0';
                suggestion.style.transform = 'translateX(-50%) scale(0.7)';
                
                setTimeout(() => {
                    if (document.body.contains(suggestion)) {
                        document.body.removeChild(suggestion);
                    }
                }, 300);
            }
        }, 5000);
    }, 10);
}

/**
 * 6. é¢å¤–åŠŸèƒ½ - è§†é¢‘çº§åˆ«çš„å°–å«ç‰¹æ•ˆ
 */

// åˆ›å»ºçƒŸé›¾äº‘å åŠ æ•ˆæœ - é«˜çº§è§†è§‰æ•ˆæœ
function createSmokeOverlay(intensity) {
    // ä½æ€§èƒ½è®¾å¤‡è·³è¿‡
    if (isLowPerformanceDevice) return;
    
    // å¼ºåº¦ä¸è¶³åˆ™ä¸æ˜¾ç¤º
    if (intensity < 70) return;
    
    // åˆ›å»ºçƒŸé›¾å®¹å™¨
    const smokeContainer = document.createElement('div');
    smokeContainer.style.position = 'fixed';
    smokeContainer.style.top = '0';
    smokeContainer.style.left = '0';
    smokeContainer.style.width = '100%';
    smokeContainer.style.height = '100%';
    smokeContainer.style.pointerEvents = 'none';
    smokeContainer.style.zIndex = '5';
    smokeContainer.style.opacity = '0';
    smokeContainer.style.transition = 'opacity 1s';
    
    document.body.appendChild(smokeContainer);
    
    // çƒŸé›¾é‡åŸºäºå¼ºåº¦
    const smokeCount = Math.floor((intensity - 60) / 10);
    
    // åˆ›å»ºå¤šä¸ªçƒŸé›¾å…ƒç´ 
    for (let i = 0; i < smokeCount; i++) {
        setTimeout(() => {
            createSmokeElement(smokeContainer);
        }, i * 200);
    }
    
    // æ˜¾ç¤ºçƒŸé›¾
    setTimeout(() => {
        smokeContainer.style.opacity = '1';
        
        // æŒç»­æ—¶é—´åŸºäºå¼ºåº¦
        const duration = 2000 + (intensity * 30);
        
        setTimeout(() => {
            smokeContainer.style.opacity = '0';
            
            setTimeout(() => {
                if (document.body.contains(smokeContainer)) {
                    document.body.removeChild(smokeContainer);
                }
            }, 1000);
        }, duration);
    }, 10);
}

// åˆ›å»ºå•ä¸ªçƒŸé›¾å…ƒç´ 
function createSmokeElement(container) {
    const smoke = document.createElement('div');
    
    // éšæœºå¤§å°å’Œä½ç½®
    const size = 100 + Math.random() * 200;
    const posX = Math.random() * 100;
    const posY = Math.random() * 100;
    
    smoke.style.position = 'absolute';
    smoke.style.width = `${size}px`;
    smoke.style.height = `${size}px`;
    smoke.style.borderRadius = '50%';
    smoke.style.background = 'radial-gradient(circle, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 70%)';
    smoke.style.top = `${posY}%`;
    smoke.style.left = `${posX}%`;
    smoke.style.transform = 'translate(-50%, -50%) scale(0)';
    smoke.style.opacity = '0';
    
    container.appendChild(smoke);
    
    // åŠ¨ç”»
    const duration = 3000 + Math.random() * 2000;
    const delay = Math.random() * 500;
    
    setTimeout(() => {
        smoke.animate([
            { transform: 'translate(-50%, -50%) scale(0)', opacity: 0 },
            { transform: 'translate(-50%, -50%) scale(0.8)', opacity: 0.8, offset: 0.3 },
            { transform: 'translate(-50%, -50%) scale(1.5)', opacity: 0 }
        ], {
            duration: duration,
            easing: 'ease-out'
        }).onfinish = () => {
            if (container.contains(smoke)) {
                container.removeChild(smoke);
            }
        };
    }, delay);
}

// åˆ›å»ºçˆ†ç‚¸ç‰¹æ•ˆ - æé«˜å¼ºåº¦é‡Šæ”¾
function createExplosionEffect(intensity) {
    if (intensity < 95) return; // åªåœ¨å‡ ä¹æ»¡å¼ºåº¦æ—¶è§¦å‘
    
    // åˆ›å»ºçˆ†ç‚¸å®¹å™¨ï¼Œä½¿ç”¨å¯è§åº¦æ§åˆ¶
    const explosionContainer = document.createElement('div');
    explosionContainer.style.position = 'fixed';
    explosionContainer.style.top = '0';
    explosionContainer.style.left = '0';
    explosionContainer.style.width = '100%';
    explosionContainer.style.height = '100%';
    explosionContainer.style.backgroundColor = 'rgba(255, 255, 255, 0)';
    explosionContainer.style.transition = 'background-color 0.1s';
    explosionContainer.style.zIndex = '200';
    explosionContainer.style.pointerEvents = 'none';
    
    document.body.appendChild(explosionContainer);
    
    // é—ªå…‰æ•ˆæœï¼Œä½¿ç”¨å¯è§åº¦æ§åˆ¶
    setTimeout(() => {
        // è®¾ç½®èƒŒæ™¯é¢œè‰²ï¼Œé€šè¿‡VisibilityControlleræ§åˆ¶é€æ˜åº¦
        explosionContainer.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
        VisibilityController.applyVisibilityControl(explosionContainer, 0.7);
        
        // éœ‡åŠ¨å±å¹•
        shakeScreen(8);
        
        // éœ‡åŠ¨åé¦ˆ
        try {
            if (navigator.vibrate) {
                navigator.vibrate([50, 20, 100, 20, 50]);
            }
        } catch (e) {}
        
        setTimeout(() => {
            explosionContainer.style.backgroundColor = 'rgba(255, 255, 255, 0)';
            
            // åˆ›å»ºç¢ç‰‡
            if (!isLowPerformanceDevice) {
                createExplosionDebris();
            }
            
            // åˆ›å»ºå†²å‡»æ³¢
            createShockwaveRings();
            
            setTimeout(() => {
                if (document.body.contains(explosionContainer)) {
                    document.body.removeChild(explosionContainer);
                }
            }, 3000);
        }, 100);
    }, 10);
    
    // æ˜¾ç¤ºçˆ†å‘æ–‡å­—
    showBigScreenText();
}

// å®‰å…¨åœ°åˆ›å»ºè’™å±‚çš„æ–°å‡½æ•°
function createSafeOverlay(color, zIndex, duration = 500) {
    // ä½¿ç”¨å¯è§åº¦æ§åˆ¶å™¨åˆ›å»ºå®‰å…¨çš„è’™å±‚
    const overlay = VisibilityController.createSafeOverlay(color, zIndex);
    document.body.appendChild(overlay);
    
    // è®¾ç½®åˆå§‹çŠ¶æ€
    overlay.style.opacity = '0';
    
    // æ·¡å…¥æ˜¾ç¤º
    setTimeout(() => {
        VisibilityController.fadeInSafely(overlay, duration);
    }, 10);
    
    return overlay;
}

function integrateVisibilityController() {
    console.log('æ­£åœ¨é›†æˆå¯è§åº¦æ§åˆ¶å™¨...');
    
    // æ›¿æ¢åŸæœ‰çš„ç‰¹æ•ˆå‡½æ•°
    if (typeof window.createMatrixEffect === 'function') {
        console.log('è¦†ç›– Matrix æ•ˆæœå‡½æ•°');
        window.originalCreateMatrixEffect = window.createMatrixEffect;
        window.createMatrixEffect = createMatrixEffect;
    }
    
    if (typeof window.createRainbowMode === 'function') {
        console.log('è¦†ç›–å½©è™¹æ¨¡å¼å‡½æ•°');
        window.originalCreateRainbowMode = window.createRainbowMode;
        window.createRainbowMode = createRainbowMode;
    }
    
    if (typeof window.showBigScreenText === 'function') {
        console.log('è¦†ç›–å…¨å±æ–‡å­—å‡½æ•°');
        window.originalShowBigScreenText = window.showBigScreenText;
        window.showBigScreenText = showBigScreenText;
    }
    
    if (typeof window.createExplosionEffect === 'function') {
        console.log('è¦†ç›–çˆ†ç‚¸æ•ˆæœå‡½æ•°');
        window.originalCreateExplosionEffect = window.createExplosionEffect;
        window.createExplosionEffect = createExplosionEffect;
    }
    
    if (typeof window.createFullscreenTextAnimation === 'function') {
        console.log('å¢å¼ºå…¨å±æ–‡å­—åŠ¨ç”»å‡½æ•°');
        // ä¿å­˜å¯¹åŸå§‹å‡½æ•°çš„å¼•ç”¨
        window.originalCreateFullscreenTextAnimation = window.createFullscreenTextAnimation;
        
        // æ›¿æ¢ä¸ºå¢å¼ºç‰ˆæœ¬ï¼Œç¡®ä¿ä½¿ç”¨åŸå§‹å¼•ç”¨é¿å…é€’å½’
        window.createFullscreenTextAnimation = function(intensity) {
            return enhancedCreateFullscreenTextAnimation(intensity);
        };
    }
    
    // ä¿®æ”¹ä»»ä½•ä½¿ç”¨ä¸é€æ˜åº¦çš„å‡½æ•°
    patchOpacityProperties();
    
    console.log('å¯è§åº¦æ§åˆ¶å™¨é›†æˆå®Œæˆ');
}
        
// åˆ›å»ºçˆ†ç‚¸ç¢ç‰‡
function createExplosionDebris() {
    const debrisCount = isLowPerformanceDevice ? 20 : 50;
    const center = {
        x: window.innerWidth / 2,
        y: window.innerHeight / 2
    };
    
    for (let i = 0; i < debrisCount; i++) {
        const debris = document.createElement('div');
        debris.style.position = 'fixed';
        debris.style.width = `${3 + Math.random() * 8}px`;
        debris.style.height = `${3 + Math.random() * 8}px`;
        debris.style.backgroundColor = getRandomEmotionColor(100);
        debris.style.borderRadius = '50%';
        debris.style.top = `${center.y}px`;
        debris.style.left = `${center.x}px`;
        debris.style.zIndex = '50';
        debris.style.pointerEvents = 'none';
        
        document.body.appendChild(debris);
        
        // éšæœºè§’åº¦å’Œé€Ÿåº¦
        const angle = Math.random() * Math.PI * 2;
        const speed = 5 + Math.random() * 15;
        const distance = speed * (10 + Math.random() * 20);
        
        // ç»ˆç‚¹ä½ç½®
        const endX = center.x + Math.cos(angle) * distance;
        const endY = center.y + Math.sin(angle) * distance;
        
        // åŠ¨ç”»
        debris.animate([
            { top: `${center.y}px`, left: `${center.x}px`, opacity: 1, transform: 'scale(1)' },
            { 
                top: `${endY}px`, 
                left: `${endX}px`, 
                opacity: 0, 
                transform: 'scale(0)'
            }
        ], {
            duration: 1000 + Math.random() * 1000,
            easing: 'cubic-bezier(0.215, 0.610, 0.355, 1.000)'
        }).onfinish = () => {
            if (document.body.contains(debris)) {
                document.body.removeChild(debris);
            }
        };
    }
}

// åˆ›å»ºå†²å‡»æ³¢ç¯
function createShockwaveRings() {
    const ringsCount = 3;
    const center = {
        x: window.innerWidth / 2,
        y: window.innerHeight / 2
    };
    
    for (let i = 0; i < ringsCount; i++) {
        setTimeout(() => {
            const ring = document.createElement('div');
            ring.style.position = 'fixed';
            ring.style.top = `${center.y}px`;
            ring.style.left = `${center.x}px`;
            ring.style.width = '10px';
            ring.style.height = '10px';
            ring.style.borderRadius = '50%';
            ring.style.border = '3px solid white';
            ring.style.boxShadow = '0 0 10px white';
            ring.style.transform = 'translate(-50%, -50%) scale(0)';
            ring.style.zIndex = '100';
            ring.style.pointerEvents = 'none';
            
            document.body.appendChild(ring);
            
            // åŠ¨ç”»
            ring.animate([
                { transform: 'translate(-50%, -50%) scale(0)', opacity: 0.8, borderWidth: '3px' },
                { transform: 'translate(-50%, -50%) scale(40)', opacity: 0, borderWidth: '1px' }
            ], {
                duration: 1500,
                easing: 'cubic-bezier(0.215, 0.610, 0.355, 1.000)'
            }).onfinish = () => {
                if (document.body.contains(ring)) {
                    document.body.removeChild(ring);
                }
            };
        }, i * 300);
    }
}

/**
 * 7. è¾…åŠ©åŠŸèƒ½å¢å¼º - å¸®åŠ©æç¤ºå’Œå¼•å¯¼åŠŸèƒ½
 */

// åˆ›å»ºéšæœºæç¤º
function createRandomTip() {
    const tips = [
        "é•¿æŒ‰æŒ‰é’®æŒç»­å°–å«ï¼Œæˆ–è€…å¿«é€Ÿç‚¹å‡»å°–å«æŒ‰é’®ï¼",
        "å½“å¼ºåº¦è¾¾åˆ°50%æ—¶ä¼šè‡ªåŠ¨æ‰“å¡ï¼Œè®°å½•ä½ çš„æƒ…ç»ªçŠ¶æ€ã€‚",
        "å°è¯•åˆ‡æ¢ä¸åŒçš„å°–å«æ¨¡å¼ï¼Œä½“éªŒä¸åŒçš„è§†è§‰æ•ˆæœã€‚",
        "å¼ºåº¦è¶Šé«˜ï¼Œæƒ…ç»ªè¡¨ç°è¶Šä¸°å¯Œï¼Œæœ‰å¯èƒ½è§¦å‘ç‰¹æ®Šæ•ˆæœå“¦ï¼",
        "è¾¾åˆ°90%ä»¥ä¸Šçš„å¼ºåº¦å¯èƒ½è§¦å‘çˆ†å‘æ•ˆæœï¼Œè¶…è¿‡95%ä¼šæœ‰æƒŠå–œï¼",
        "æƒ…ç»ªç“¶å¯ä»¥ä¿å­˜ä½ çš„æƒ…ç»ªçŠ¶æ€ï¼Œæœªæ¥å¯ä»¥å›é¡¾å½“æ—¶çš„å¿ƒæƒ…ã€‚",
        "è¿ç»­æ‰“å¡7å¤©å¯ä»¥è§£é”ç‰¹æ®Šæˆå°±ï¼",
        "åˆ‡æ¢æƒ…ç»ªå¤©æ°”å¯ä»¥æ”¹å˜è§†è§‰æ°›å›´ï¼Œå°è¯•æ‰€æœ‰å¤©æ°”å¯ä»¥è§£é”æˆå°±ã€‚",
        "ç‰¹æ•ˆæ¨¡å¼ä¸‹å°–å«æ•ˆæœæ›´åŠ ä¸°å¯Œå¤šå½©ï¼",
        "æ¯ç§å°–å«æ¨¡å¼éƒ½æœ‰ç‹¬ç‰¹çš„è§†è§‰æ•ˆæœï¼Œå…¨éƒ¨ä½“éªŒå¯ä»¥è§£é”æ¨¡å¼æŒæ§è€…æˆå°±ã€‚"
    ];
    
    const randomTip = tips[Math.floor(Math.random() * tips.length)];
    
    // åˆ›å»ºæç¤ºå…ƒç´ 
    const tipContainer = document.createElement('div');
    tipContainer.style.position = 'fixed';
    tipContainer.style.bottom = '80px';
    tipContainer.style.left = '50%';
    tipContainer.style.transform = 'translateX(-50%) scale(0.9)';
    tipContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
    tipContainer.style.color = 'white';
    tipContainer.style.padding = '10px 15px';
    tipContainer.style.borderRadius = '5px';
    tipContainer.style.fontSize = '14px';
    tipContainer.style.maxWidth = '280px';
    tipContainer.style.textAlign = 'center';
    tipContainer.style.zIndex = '100';
    tipContainer.style.opacity = '0';
    tipContainer.style.transition = 'all 0.3s';
    
    // æ·»åŠ æç¤ºå›¾æ ‡å’Œæ–‡å­—
    tipContainer.innerHTML = `
        <div style="margin-bottom: 5px; font-size: 16px;">ğŸ’¡ å°æç¤º</div>
        <div>${randomTip}</div>
    `;
    
    document.body.appendChild(tipContainer);
    
    // åŠ¨ç”»æ˜¾ç¤º
    setTimeout(() => {
        tipContainer.style.opacity = '1';
        tipContainer.style.transform = 'translateX(-50%) scale(1)';
        
        // è‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            tipContainer.style.opacity = '0';
            tipContainer.style.transform = 'translateX(-50%) scale(0.9)';
            
            setTimeout(() => {
                if (document.body.contains(tipContainer)) {
                    document.body.removeChild(tipContainer);
                }
            }, 300);
        }, 6000);
    }, 10);
}

// åˆ›å»ºæƒ…ç»ªåˆ†ææŠ¥å‘Š
function createEmotionAnalysisReport() {
    // ä»å†å²æ•°æ®ä¸­è·å–åˆ†æ
    const emotionData = JSON.parse(localStorage.getItem('emotionHistory') || '[]');
    const bottleData = JSON.parse(localStorage.getItem('emotionBottles') || '[]');
    const checkInData = CheckInSystem.getCheckInData();
    
    // å¦‚æœæ²¡æœ‰è¶³å¤Ÿæ•°æ®ï¼Œåˆ™ä¸æ˜¾ç¤º
    if (emotionData.length < 3 && Object.keys(checkInData).length < 3) {
        return showNoDataMessage();
    }
    
    // åˆ›å»ºæŠ¥å‘Šå®¹å™¨
    const reportContainer = document.createElement('div');
    reportContainer.style.position = 'fixed';
    reportContainer.style.top = '50%';
    reportContainer.style.left = '50%';
    reportContainer.style.transform = 'translate(-50%, -50%)';
    reportContainer.style.width = '90%';
    reportContainer.style.maxWidth = '500px';
    reportContainer.style.maxHeight = '80vh';
    reportContainer.style.backgroundColor = 'rgba(255, 255, 255, 0.95)';
    reportContainer.style.borderRadius = '10px';
    reportContainer.style.boxShadow = '0 5px 20px rgba(0, 0, 0, 0.3)';
    reportContainer.style.padding = '20px';
    reportContainer.style.zIndex = '1000';
    reportContainer.style.overflowY = 'scroll';
    reportContainer.style.opacity = '0';
    reportContainer.style.transition = 'opacity 0.3s, transform 0.3s';
    
    // æ ‡é¢˜
    const title = document.createElement('h3');
    title.textContent = 'æƒ…ç»ªåˆ†ææŠ¥å‘Š';
    title.style.marginBottom = '15px';
    title.style.textAlign = 'center';
    reportContainer.appendChild(title);
    
    // åˆ†ææ‘˜è¦
    const summary = document.createElement('div');
    summary.style.backgroundColor = '#f5f5f5';
    summary.style.padding = '15px';
    summary.style.borderRadius = '5px';
    summary.style.marginBottom = '20px';
    
    // è®¡ç®—åŸºæœ¬ç»Ÿè®¡æ•°æ®
    const checkInCount = Object.keys(checkInData).length;
    const bottleCount = bottleData.length;
    
    // è®¡ç®—å¹³å‡å¼ºåº¦
    let totalIntensity = 0;
    let intensityCount = 0;
    
    // ä»æ‰“å¡å’Œæƒ…ç»ªç“¶æ•°æ®è®¡ç®—å¼ºåº¦
    for (const date in checkInData) {
        totalIntensity += checkInData[date].intensity;
        intensityCount++;
    }
    
    bottleData.forEach(bottle => {
        totalIntensity += bottle.intensity;
        intensityCount++;
    });
    
    const avgIntensity = intensityCount > 0 ? Math.round(totalIntensity / intensityCount) : 0;
    
    // æŸ¥æ‰¾æœ€é«˜å¼ºåº¦
    let maxIntensity = 0;
    
    for (const date in checkInData) {
        if (checkInData[date].intensity > maxIntensity) {
            maxIntensity = checkInData[date].intensity;
        }
    }
    
    bottleData.forEach(bottle => {
        if (bottle.intensity > maxIntensity) {
            maxIntensity = bottle.intensity;
        }
    });
    
    // è®¡ç®—æƒ…ç»ªæ¨¡å¼åˆ†å¸ƒ
    const modeDistribution = {
        calm: 0,
        release: 0,
        fury: 0
    };
    
    for (const date in checkInData) {
        modeDistribution[checkInData[date].mode]++;
    }
    
    bottleData.forEach(bottle => {
        modeDistribution[bottle.mode]++;
    });
    
    // è®¡ç®—æ¨¡å¼ç™¾åˆ†æ¯”
    const modeTotal = modeDistribution.calm + modeDistribution.release + modeDistribution.fury;
    const modePercentages = {
        calm: modeTotal > 0 ? Math.round((modeDistribution.calm / modeTotal) * 100) : 0,
        release: modeTotal > 0 ? Math.round((modeDistribution.release / modeTotal) * 100) : 0,
        fury: modeTotal > 0 ? Math.round((modeDistribution.fury / modeTotal) * 100) : 0
    };
    
    // æ‹¼æ¥æ‘˜è¦HTML
    summary.innerHTML = `
        <div style="margin-bottom: 10px; font-weight: bold;">æ•°æ®æ‘˜è¦</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>æ€»æ‰“å¡æ¬¡æ•°: <strong>${checkInCount}æ¬¡</strong></div>
            <div>æƒ…ç»ªç“¶æ”¶è—: <strong>${bottleCount}ä¸ª</strong></div>
            <div>å¹³å‡æƒ…ç»ªå¼ºåº¦: <strong style="color: ${getIntensityColor(avgIntensity)};">${avgIntensity}%</strong></div>
            <div>æœ€é«˜æƒ…ç»ªå¼ºåº¦: <strong style="color: ${getIntensityColor(maxIntensity)};">${Math.round(maxIntensity)}%</strong></div>
        </div>
        
        <div style="margin-top: 15px; margin-bottom: 10px; font-weight: bold;">æƒ…ç»ªæ¨¡å¼åˆ†æ</div>
        <div style="display: flex; height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 5px;">
            <div style="width: ${modePercentages.calm}%; background-color: #4CAF50;"></div>
            <div style="width: ${modePercentages.release}%; background-color: #FF9800;"></div>
            <div style="width: ${modePercentages.fury}%; background-color: #F44336;"></div>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 12px;">
            <div>å¹³é™æ¨¡å¼ ${modePercentages.calm}%</div>
            <div>é‡Šæ”¾æ¨¡å¼ ${modePercentages.release}%</div>
            <div>ç‹‚æ€’æ¨¡å¼ ${modePercentages.fury}%</div>
        </div>
    `;
    
    reportContainer.appendChild(summary);
    
    // æƒ…ç»ªè¶‹åŠ¿å›¾è¡¨
    if (emotionData.length >= 3) {
        const trendContainer = document.createElement('div');
        trendContainer.style.marginBottom = '20px';
        
        const trendTitle = document.createElement('div');
        trendTitle.textContent = 'æƒ…ç»ªå¼ºåº¦è¶‹åŠ¿';
        trendTitle.style.fontWeight = 'bold';
        trendTitle.style.marginBottom = '10px';
        
        const trendChart = document.createElement('div');
        trendChart.style.height = '150px';
        trendChart.style.backgroundColor = '#f9f9f9';
        trendChart.style.borderRadius = '5px';
        trendChart.style.position = 'relative';
        trendChart.style.marginBottom = '20px';
        
        trendContainer.appendChild(trendTitle);
        trendContainer.appendChild(trendChart);
        
        // åˆ›å»ºè¶‹åŠ¿çº¿å›¾
        createTrendLineChart(trendChart, emotionData.slice(0, 10));
        
        reportContainer.appendChild(trendContainer);
    }
    
    // æƒ…ç»ªåˆ†æå’Œå»ºè®®
    const analysisContainer = document.createElement('div');
    analysisContainer.style.backgroundColor = '#e8f5e9';
    analysisContainer.style.padding = '15px';
    analysisContainer.style.borderRadius = '5px';
    analysisContainer.style.marginBottom = '20px';
    
    // æ ¹æ®æ•°æ®ç”Ÿæˆåˆ†æå’Œå»ºè®®
    const analysis = generateEmotionAnalysis(avgIntensity, maxIntensity, modePercentages);
    
    analysisContainer.innerHTML = `
        <div style="margin-bottom: 10px; font-weight: bold;">æƒ…ç»ªåˆ†æ</div>
        <div style="margin-bottom: 15px;">${analysis.analysis}</div>
        <div style="margin-bottom: 10px; font-weight: bold;">å»ºè®®</div>
        <div>${analysis.suggestions}</div>
    `;
    
    reportContainer.appendChild(analysisContainer);
    
    // å…³é—­æŒ‰é’®
    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'å…³é—­';
    closeBtn.style.display = 'block';
    closeBtn.style.width = '100%';
    closeBtn.style.padding = '10px';
    closeBtn.style.border = 'none';
    closeBtn.style.borderRadius = '5px';
    closeBtn.style.backgroundColor = '#f0f0f0';
    closeBtn.style.cursor = 'pointer';
    closeBtn.style.marginTop = '10px';
    
    closeBtn.addEventListener('click', () => {
        reportContainer.style.opacity = '0';
        reportContainer.style.transform = 'translate(-50%, -50%) scale(0.9)';
        
        setTimeout(() => {
            if (document.body.contains(reportContainer)) {
                document.body.removeChild(reportContainer);
            }
        }, 300);
    });
    
    reportContainer.appendChild(closeBtn);
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(reportContainer);
    
    // åŠ¨ç”»æ˜¾ç¤º
    setTimeout(() => {
        reportContainer.style.opacity = '1';
        reportContainer.style.transform = 'translate(-50%, -50%) scale(1)';
    }, 10);
}

/**
 * æ ¹æ®æƒ…ç»ªå¼ºåº¦è¿”å›å¯¹åº”çš„é¢œè‰²ä»£ç 
 * @param {number} intensity æƒ…ç»ªå¼ºåº¦å€¼ï¼ˆ0-100ï¼‰
 * @returns {string} é¢œè‰²ä»£ç 
 */
function getIntensityColor(intensity) {
    if (intensity >= 90) return '#FF5722'; // æ·±æ©™è‰² - æé«˜å¼ºåº¦
    if (intensity >= 75) return '#FF9800'; // æ©™è‰² - é«˜å¼ºåº¦
    if (intensity >= 50) return '#FFC107'; // ç¥ç€è‰² - ä¸­é«˜å¼ºåº¦
    if (intensity >= 30) return '#CDDC39'; // é…¸æ©™è‰² - ä¸­ç­‰å¼ºåº¦
    if (intensity >= 10) return '#8BC34A'; // æµ…ç»¿è‰² - ä½å¼ºåº¦
    return '#4CAF50'; // ç»¿è‰² - å¾ˆä½å¼ºåº¦
}

// ç¡®ä¿æ­¤å‡½æ•°åœ¨å…¨å±€èŒƒå›´å†…å¯ç”¨
window.getIntensityColor = getIntensityColor;
        
// åˆ›å»ºè¶‹åŠ¿çº¿å›¾
function createTrendLineChart(container, data) {
    // åè½¬æ•°æ®ï¼Œæœ€æ–°çš„åœ¨å³ä¾§
    const chartData = data.slice().reverse();
    
    // è·å–æœ€å¤§å¼ºåº¦ç”¨äºç¼©æ”¾
    let maxIntensity = 0;
    chartData.forEach(record => {
        if (record.intensity > maxIntensity) {
            maxIntensity = record.intensity;
        }
    });
    
    // ç¡®ä¿æœ€å¤§å€¼è‡³å°‘ä¸º100ï¼Œä¸ºå›¾è¡¨ç•™å‡ºè¶³å¤Ÿç©ºé—´
    maxIntensity = Math.max(100, maxIntensity);
    
    // åˆ›å»ºçº¿å›¾
    const chartWidth = container.offsetWidth;
    const chartHeight = container.offsetHeight;
    const padding = 20;
    const availableWidth = chartWidth - (padding * 2);
    const availableHeight = chartHeight - (padding * 2);
    
    // åˆ›å»ºç‚¹å’Œè¿æ¥çº¿
    const pointRadius = 4;
    let pathD = '';
    
    chartData.forEach((record, index) => {
        const x = padding + (index / (chartData.length - 1)) * availableWidth;
        const y = chartHeight - (padding + (record.intensity / maxIntensity) * availableHeight);
        
        // åˆ›å»ºç‚¹
        const point = document.createElement('div');
        point.style.position = 'absolute';
        point.style.width = `${pointRadius * 2}px`;
        point.style.height = `${pointRadius * 2}px`;
        point.style.backgroundColor = getIntensityColor(record.intensity);
        point.style.borderRadius = '50%';
        point.style.left = `${x - pointRadius}px`;
        point.style.top = `${y - pointRadius}px`;
        point.style.zIndex = '2';
        
        // æ·»åŠ æç¤º
        const date = new Date(record.date);
        const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
        point.title = `${dateStr}: ${Math.round(record.intensity)}%`;
        
        container.appendChild(point);
        
        // æ„å»ºè·¯å¾„
        if (index === 0) {
            pathD = `M ${x} ${y}`;
        } else {
            pathD += ` L ${x} ${y}`;
        }
    });
    
    // åˆ›å»ºSVGçº¿å›¾
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', '100%');
    svg.setAttribute('height', '100%');
    svg.style.position = 'absolute';
    svg.style.top = '0';
    svg.style.left = '0';
    svg.style.zIndex = '1';
    
    // åˆ›å»ºè·¯å¾„
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', pathD);
    path.setAttribute('stroke', '#2196F3');
    path.setAttribute('stroke-width', '2');
    path.setAttribute('fill', 'none');
    
    svg.appendChild(path);
    container.appendChild(svg);
    
    // æ·»åŠ ç½‘æ ¼çº¿
    const gridLines = 4;
    for (let i = 0; i <= gridLines; i++) {
        const y = padding + (i / gridLines) * availableHeight;
        const gridLine = document.createElement('div');
        gridLine.style.position = 'absolute';
        gridLine.style.width = `${availableWidth}px`;
        gridLine.style.height = '1px';
        gridLine.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
        gridLine.style.left = `${padding}px`;
        gridLine.style.top = `${y}px`;
        
        container.appendChild(gridLine);
        
        // æ·»åŠ æ ‡ç­¾
        const label = document.createElement('div');
        label.textContent = `${Math.round(maxIntensity - (i / gridLines) * maxIntensity)}%`;
        label.style.position = 'absolute';
        label.style.fontSize = '10px';
        label.style.color = '#666';
        label.style.right = '5px';
        label.style.top = `${y - 5}px`;
        
        container.appendChild(label);
    }
}

// ç”Ÿæˆæƒ…ç»ªåˆ†æå’Œå»ºè®®
function generateEmotionAnalysis(avgIntensity, maxIntensity, modePercentages) {
    // æ ¹æ®æ•°æ®ç”Ÿæˆä¸ªæ€§åŒ–åˆ†æ
    let analysis = '';
    let suggestions = '';
    
    // åŸºäºå¹³å‡å¼ºåº¦çš„åˆ†æ
    if (avgIntensity < 30) {
        analysis = "ä½ çš„æ•´ä½“æƒ…ç»ªå¼ºåº¦è¾ƒä½ï¼Œè¡¨æ˜ä½ å¯èƒ½è¾ƒä¸ºå¹³é™æˆ–æœªå……åˆ†é‡Šæ”¾æƒ…ç»ªã€‚";
        suggestions = "å°è¯•æ›´é¢‘ç¹åœ°ä½¿ç”¨å°–å«ä»ªï¼Œæˆ–è€…åœ¨ä½¿ç”¨æ—¶å®Œå…¨æŠ•å…¥ï¼Œè®©è‡ªå·±çš„æƒ…ç»ªå¾—åˆ°æ›´å……åˆ†çš„é‡Šæ”¾ã€‚";
    } else if (avgIntensity < 60) {
        analysis = "ä½ çš„æ•´ä½“æƒ…ç»ªå¼ºåº¦é€‚ä¸­ï¼Œè¡¨æ˜ä½ èƒ½å¤Ÿé€‚åº¦åœ°é‡Šæ”¾æƒ…ç»ªï¼Œä¸ä¼šè¿‡åº¦å‹æŠ‘ä¹Ÿä¸ä¼šæƒ…ç»ªæ¿€çƒˆã€‚";
        suggestions = "ç»§ç»­ä¿æŒè¿™ç§å¹³è¡¡ï¼ŒåŒæ—¶å¯ä»¥å°è¯•ä¸åŒçš„å°–å«æ¨¡å¼ï¼Œæ¢ç´¢æ›´ä¸°å¯Œçš„æƒ…ç»ªè¡¨è¾¾æ–¹å¼ã€‚";
    } else if (avgIntensity < 80) {
        analysis = "ä½ çš„æ•´ä½“æƒ…ç»ªå¼ºåº¦è¾ƒé«˜ï¼Œè¡¨æ˜ä½ èƒ½å¤Ÿå……åˆ†é‡Šæ”¾æƒ…ç»ªï¼Œæƒ…æ„Ÿè¡¨è¾¾è¾ƒä¸ºä¸°å¯Œã€‚";
        suggestions = "å¤šå°è¯•å¹³é™æ¨¡å¼ï¼Œå­¦ä¹ åœ¨é«˜å¼ºåº¦é‡Šæ”¾åæ‰¾å›å¹³è¡¡ï¼Œå½¢æˆé‡Šæ”¾-å¹³é™çš„è‰¯æ€§å¾ªç¯ã€‚";
    } else {
        analysis = "ä½ çš„æ•´ä½“æƒ…ç»ªå¼ºåº¦éå¸¸é«˜ï¼Œè¡¨æ˜ä½ çš„æƒ…ç»ªè¡¨è¾¾éå¸¸å¼ºçƒˆï¼Œèƒ½å¤Ÿé‡Šæ”¾å†…å¿ƒçš„å¼ºçƒˆæ„Ÿå—ã€‚";
        suggestions = "é€‚å½“å…³æ³¨æƒ…ç»ªé«˜æ¶¨åçš„è‡ªæˆ‘è°ƒèŠ‚ï¼Œè®°å½•é«˜å¼ºåº¦æƒ…ç»ªçš„è§¦å‘åŸå› ï¼Œå¸®åŠ©ç†è§£è‡ªå·±çš„æƒ…ç»ªæ¨¡å¼ã€‚";
    }
    
    // åŸºäºæœ€é«˜å¼ºåº¦çš„åˆ†æ
    if (maxIntensity >= 95) {
        analysis += " ä½ çš„æœ€é«˜æƒ…ç»ªå¼ºåº¦è¾¾åˆ°äº†é¡¶å³°ï¼Œè¯´æ˜ä½ æœ‰èƒ½åŠ›å®Œå…¨é‡Šæ”¾è‡ªå·±çš„æƒ…ç»ªã€‚";
        suggestions += " åœ¨è¾¾åˆ°é«˜å¼ºåº¦åï¼Œä¸è¦å¿˜è®°ä½¿ç”¨æƒ…ç»ªç“¶è®°å½•ï¼Œå¸®åŠ©å›é¡¾å’Œç†è§£è¿™äº›å¼ºçƒˆçš„æƒ…ç»ªæ—¶åˆ»ã€‚";
    }
    
    // åŸºäºæ¨¡å¼åˆ†å¸ƒçš„åˆ†æ
    const dominantMode = getDominantMode(modePercentages);
    
    if (dominantMode === 'calm') {
        analysis += " ä½ å€¾å‘äºä½¿ç”¨å¹³é™æ¨¡å¼ï¼Œè¡¨æ˜ä½ æ›´å–œæ¬¢æ¸©å’Œåœ°è¡¨è¾¾æƒ…ç»ªã€‚";
        suggestions += " å¶å°”ä¹Ÿå¯ä»¥å°è¯•é‡Šæ”¾æ¨¡å¼æˆ–ç‹‚æ€’æ¨¡å¼ï¼Œä½“éªŒä¸åŒçš„æƒ…ç»ªé‡Šæ”¾æ–¹å¼ï¼Œå¯èƒ½ä¼šå‘ç°æ–°çš„æƒ…ç»ªå®£æ³„è·¯å¾„ã€‚";
    } else if (dominantMode === 'release') {
        analysis += " ä½ å€¾å‘äºä½¿ç”¨é‡Šæ”¾æ¨¡å¼ï¼Œè¡¨æ˜ä½ æ³¨é‡æƒ…ç»ªçš„ç§¯æé‡Šæ”¾å’Œè½¬åŒ–ã€‚";
        suggestions += " è¿™ç§æ¨¡å¼å¾ˆå¥½åœ°å¹³è¡¡äº†æƒ…ç»ªé‡Šæ”¾å’Œæ§åˆ¶ï¼Œç»§ç»­ä¿æŒï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥è®°å½•å“ªäº›é‡Šæ”¾æ–¹å¼å¯¹ä½ æœ€æœ‰æ•ˆã€‚";
    } else if (dominantMode === 'fury') {
        analysis += " ä½ å€¾å‘äºä½¿ç”¨ç‹‚æ€’æ¨¡å¼ï¼Œè¡¨æ˜ä½ éœ€è¦å¼ºçƒˆåœ°å®£æ³„å†…å¿ƒçš„æ¿€çƒˆæƒ…ç»ªã€‚";
        suggestions += " åœ¨ä½¿ç”¨ç‹‚æ€’æ¨¡å¼åï¼Œç»™è‡ªå·±ä¸€äº›æ—¶é—´å†·é™ä¸‹æ¥ï¼Œå¯ä»¥è¾…ä»¥æ·±å‘¼å¸æˆ–å…¶ä»–æ”¾æ¾æŠ€å·§ï¼Œå¸®åŠ©æƒ…ç»ªç¨³å®šã€‚";
    }
    
    return {
        analysis: analysis,
        suggestions: suggestions
    };
}

// è·å–ä¸»å¯¼æ¨¡å¼
function getDominantMode(modePercentages) {
    const modes = ['calm', 'release', 'fury'];
    let highestPercentage = 0;
    let dominantMode = 'calm';
    
    modes.forEach(mode => {
        if (modePercentages[mode] > highestPercentage) {
            highestPercentage = modePercentages[mode];
            dominantMode = mode;
        }
    });
    
    return dominantMode;
}

// æ˜¾ç¤ºæ— æ•°æ®æ¶ˆæ¯
function showNoDataMessage() {
    const messageContainer = document.createElement('div');
    messageContainer.style.position = 'fixed';
    messageContainer.style.top = '50%';
    messageContainer.style.left = '50%';
    messageContainer.style.transform = 'translate(-50%, -50%)';
    messageContainer.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
    messageContainer.style.padding = '20px';
    messageContainer.style.borderRadius = '10px';
    messageContainer.style.boxShadow = '0 5px 20px rgba(0, 0, 0, 0.2)';
    messageContainer.style.zIndex = '1000';
    messageContainer.style.textAlign = 'center';
    messageContainer.style.opacity = '0';
    messageContainer.style.transition = 'opacity 0.3s, transform 0.3s';
    
    messageContainer.innerHTML = `
        <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“Š</div>
        <div style="font-weight: bold; margin-bottom: 10px;">æš‚æ— è¶³å¤Ÿçš„æ•°æ®</div>
        <div style="margin-bottom: 15px;">éœ€è¦è‡³å°‘3æ¡æƒ…ç»ªè®°å½•æ‰èƒ½ç”Ÿæˆåˆ†ææŠ¥å‘Š</div>
        <div>å¤šä½¿ç”¨å°–å«ä»ªå¹¶æ‰“å¡è®°å½•ï¼Œå¾ˆå¿«å°±èƒ½çœ‹åˆ°ä½ çš„æƒ…ç»ªåˆ†æï¼</div>
    `;
    
    // æ·»åŠ å…³é—­æŒ‰é’®
    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'çŸ¥é“äº†';
    closeBtn.style.marginTop = '15px';
    closeBtn.style.padding = '8px 15px';
    closeBtn.style.border = 'none';
    closeBtn.style.borderRadius = '5px';
    closeBtn.style.backgroundColor = '#f0f0f0';
    closeBtn.style.cursor = 'pointer';
    
    closeBtn.addEventListener('click', () => {
        messageContainer.style.opacity = '0';
        messageContainer.style.transform = 'translate(-50%, -50%) scale(0.9)';
        
        setTimeout(() => {
            if (document.body.contains(messageContainer)) {
                document.body.removeChild(messageContainer);
            }
        }, 300);
    });
    
    messageContainer.appendChild(closeBtn);
    
    document.body.appendChild(messageContainer);
    
    // åŠ¨ç”»æ˜¾ç¤º
    setTimeout(() => {
        messageContainer.style.opacity = '1';
        messageContainer.style.transform = 'translate(-50%, -50%) scale(1)';
    }, 10);
}

// åˆ›å»ºåˆ†ææŒ‰é’®
function createAnalysisButton() {
    const analysisBtn = document.createElement('div');
    analysisBtn.id = 'analysisButton';
    analysisBtn.style.position = 'absolute';
    analysisBtn.style.bottom = '20px';
    analysisBtn.style.right = '20px';
    analysisBtn.style.background = 'rgba(255, 255, 255, 0.8)';
    analysisBtn.style.borderRadius = '5px';
    analysisBtn.style.padding = '8px 12px';
    analysisBtn.style.fontSize = '14px';
    analysisBtn.style.cursor = 'pointer';
    analysisBtn.style.display = 'flex';
    analysisBtn.style.alignItems = 'center';
    analysisBtn.style.boxShadow = '0 2px 5px rgba(0, 0, 0, 0.1)';
    analysisBtn.style.zIndex = '10';
    analysisBtn.style.transition = 'transform 0.3s, box-shadow 0.3s';
    
    // å›¾æ ‡
    const icon = document.createElement('span');
    icon.textContent = 'ğŸ“Š';
    icon.style.marginRight = '5px';
    
    const text = document.createElement('span');
    text.textContent = 'æƒ…ç»ªåˆ†æ';
    
    analysisBtn.appendChild(icon);
    analysisBtn.appendChild(text);
    
    // æ‚¬åœæ•ˆæœ
    analysisBtn.addEventListener('mouseenter', () => {
        analysisBtn.style.transform = 'scale(1.05)';
        analysisBtn.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.15)';
    });
    
    analysisBtn.addEventListener('mouseleave', () => {
        analysisBtn.style.transform = 'scale(1)';
        analysisBtn.style.boxShadow = '0 2px 5px rgba(0, 0, 0, 0.1)';
    });
    
    // ç‚¹å‡»äº‹ä»¶
    analysisBtn.addEventListener('click', () => {
        createEmotionAnalysisReport();
        
        // è§¦å‘éœ‡åŠ¨åé¦ˆ
        try {
            if (navigator.vibrate) {
                navigator.vibrate(20);
            }
        } catch (e) {}
    });
    
    document.body.appendChild(analysisBtn);
    return analysisBtn;
}

/**
 * 8. ç³»ç»Ÿé›†æˆä»£ç  - å®‰è£…æ‰€æœ‰åŠŸèƒ½
 */

// å®Œæ•´å®‰è£…å‡½æ•° - åœ¨é¡µé¢åŠ è½½å®Œæˆåè°ƒç”¨æ­¤å‡½æ•°
function installCyberScreamEnhancements() {
    // åˆå§‹åŒ–æ‰€æœ‰æ–°åŠŸèƒ½
    initEnhancedFeatures();
    
    // åˆ›å»ºåˆ†ææŒ‰é’®
    createAnalysisButton();
    
    // æ›¿æ¢æ ¸å¿ƒå‡½æ•°
    // æ³¨æ„: åœ¨å®é™…æ•´åˆä¸­ï¼Œä½ å¯èƒ½éœ€è¦ä¿®æ”¹åŸå§‹å‡½æ•°è€Œä¸æ˜¯æ›¿æ¢å®ƒä»¬
    // è¿™é‡Œæä¾›äº†ä¸¤ç§æ–¹æ³•ï¼šæ›¿æ¢æˆ–å¢å¼º
    
    // æ–¹æ³•1: ç›´æ¥æ›¿æ¢å‡½æ•°ï¼ˆå¦‚æœå¯è¡Œï¼‰
    // window.updateIntensityDisplay = enhancedUpdateIntensityDisplay;
    // window.startScream = enhancedStartScream;
    // window.stopScream = enhancedStopScream;
    // window.checkAchievements = enhancedCheckAchievements;
    
    // æ–¹æ³•2: æ‰©å±•ç°æœ‰å‡½æ•°ï¼ˆæ¨èï¼‰
    // ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œä¿ç•™åŸå§‹åŠŸèƒ½å¹¶æ·»åŠ æ–°åŠŸèƒ½
    const originalUpdateIntensityDisplay = window.updateIntensityDisplay;
    window.updateIntensityDisplay = function() {
        originalUpdateIntensityDisplay.apply(this, arguments);
        updateIntensityWithVisuals(intensity);
    };
    
    const originalStartScream = window.startScream;
    window.startScream = function() {
        originalStartScream.apply(this, arguments);
        if (fxMode && Math.random() > 0.9) {
            setTimeout(() => {
                createFullscreenTextAnimation(intensity);
            }, 500);
        }
    };
    
    const originalStopScream = window.stopScream;
    window.stopScream = function() {
        originalStopScream.apply(this, arguments);
        if (intensity >= 80) {
            setTimeout(() => {
                suggestEmotionBottle();
            }, 1000);
        }
    };
    
    const originalCheckAchievements = window.checkAchievements;
    window.checkAchievements = function() {
        originalCheckAchievements.apply(this, arguments);
        checkBottleCollectorAchievement();
    };
    
    // æ·»åŠ å®šæ—¶æç¤º
    setTimeout(() => {
        createRandomTip();
        
        // æ¯3-5åˆ†é’Ÿæ˜¾ç¤ºä¸€ä¸ªéšæœºæç¤º
        setInterval(() => {
            if (Math.random() > 0.7) { // 70%çš„æ¦‚ç‡æ˜¾ç¤ºæç¤º
                createRandomTip();
            }
        }, 3 * 60 * 1000 + Math.random() * 2 * 60 * 1000);
    }, 30 * 1000); // 30ç§’åæ˜¾ç¤ºç¬¬ä¸€ä¸ªæç¤º
    
    // æ‰“å°å®‰è£…æˆåŠŸæ¶ˆæ¯
    console.log('èµ›åšå°–å«ä»ªå¢å¼ºåŠŸèƒ½å·²å®‰è£… ğŸ‰');
}

// å¯¼å‡ºæ‰€æœ‰å‡½æ•°ä¾›å¤–éƒ¨ä½¿ç”¨
window.CyberScreamEnhanced = {
    install: installCyberScreamEnhancements,
    createCheckInUI: createCheckInUI,
    createEmotionBottle: createEmotionBottle,
    showEmotionBottleCollection: showEmotionBottleCollection,
    createFullscreenTextAnimation: createFullscreenTextAnimation,
    createEmotionAnalysisReport: createEmotionAnalysisReport,
    createRandomEasterEgg: createRandomEasterEgg
};

// è‡ªåŠ¨å®‰è£…ï¼ˆå¯é€‰ - å–æ¶ˆæ³¨é‡Šä»¥å¯ç”¨ï¼‰
document.addEventListener('DOMContentLoaded', installCyberScreamEnhancements);
        
        // éšè—åœ°å€æ  - ç§»åŠ¨ç«¯çš„æŠ€å·§
        window.addEventListener('load', function() {
            setTimeout(function() {
                window.scrollTo(0, 1);
            }, 0);
        });
        
        // ä¼˜åŒ–æ»šåŠ¨è¡Œä¸º
        document.addEventListener('touchmove', function(e) {
            if (e.target.closest('.achievement-container') || e.target.closest('.emotion-history-container')) {
                // å…è®¸æˆå°±å®¹å™¨å’Œæƒ…ç»ªå†å²å®¹å™¨å†…éƒ¨æ»šåŠ¨
                e.stopPropagation();
            } else {
                // é˜²æ­¢é¡µé¢æ»šåŠ¨
                e.preventDefault();
            }
        }, { passive: false });
        
        // å¤„ç†æµè§ˆå™¨å¯è§æ€§å˜åŒ– - èŠ‚çœç”µæ± 
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // é¡µé¢ä¸å¯è§æ—¶åœæ­¢æ¸¸æˆå¾ªç¯å’ŒåŠ¨ç”»
                if (isPressed) {
                    stopScream();
                }
            }
        });
        
        // å¤„ç†çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', function() {
            // æ›´æ–°æƒ…ç»ªå›¾è¡¨
            if (emotionHistoryContainer.classList.contains('active')) {
                updateEmotionChart();
            }
        });
        
        // å¤„ç†æ–¹å‘å˜åŒ– - ç§»åŠ¨è®¾å¤‡
        window.addEventListener('orientationchange', function() {
            // çŸ­æš‚å»¶è¿Ÿåæ›´æ–°å›¾è¡¨ï¼Œç­‰å¾…æ–¹å‘å˜åŒ–å®Œæˆ
            setTimeout(function() {
                if (emotionHistoryContainer.classList.contains('active')) {
                    updateEmotionChart();
                }
            }, 300);
        });
        
        // å¤„ç†ç½‘é¡µå…³é—­æ—¶ä¿å­˜æ•°æ®
        window.addEventListener('beforeunload', function() {
            localStorage.setItem('totalRelease', totalRelease.toString());
        });

// ç‰¹æ•ˆå¯è§åº¦æ§åˆ¶å™¨ - ç¡®ä¿ä¸»ç•Œé¢è‡³å°‘æœ‰50%å¯è§åº¦
const VisibilityController = {
    // æœ€å¤§å…è®¸çš„ä¸é€æ˜åº¦ï¼ˆç¡®ä¿ä¸»ç•Œé¢è‡³å°‘50%å¯è§åº¦ï¼‰
    MAX_OPACITY: 0.5,
    
    // åº”ç”¨é€æ˜åº¦æ§åˆ¶åˆ°å…ƒç´ 
    applyVisibilityControl: function(element, desiredOpacity = 1.0) {
        // å°†æœŸæœ›çš„ä¸é€æ˜åº¦é™åˆ¶åœ¨å®‰å…¨èŒƒå›´å†…
        const safeOpacity = Math.min(desiredOpacity, this.MAX_OPACITY);
        
        // åº”ç”¨å®‰å…¨ä¸é€æ˜åº¦
        if (element && element.style) {
            element.style.opacity = safeOpacity.toString();
            
            // ä¸ºç‰¹å®šç±»å‹çš„æ•ˆæœè°ƒæ•´èƒŒæ™¯é¢œè‰²çš„alphaé€šé“
            if (element.style.backgroundColor && element.style.backgroundColor.includes('rgba')) {
                const bgColor = element.style.backgroundColor;
                const parts = bgColor.match(/rgba\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*([\d.]+)\s*\)/);
                
                if (parts && parts.length >= 5) {
                    const r = parseInt(parts[1]);
                    const g = parseInt(parts[2]);
                    const b = parseInt(parts[3]);
                    // æ›¿æ¢alphaå€¼ï¼Œç¡®ä¿ä¸è¶…è¿‡æœ€å¤§å€¼
                    const newAlpha = Math.min(parseFloat(parts[4]), this.MAX_OPACITY);
                    element.style.backgroundColor = `rgba(${r}, ${g}, ${b}, ${newAlpha})`;
                }
            }
        }
        
        return safeOpacity;
    },
    
    // åˆ›å»ºå®‰å…¨çš„è¦†ç›–å±‚
    createSafeOverlay: function(color = 'rgba(0, 0, 0, 0.5)', zIndex = 100) {
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.pointerEvents = 'none';
        overlay.style.zIndex = zIndex.toString();
        
        // ç¡®ä¿è¦†ç›–å±‚ä¸ä¼šå®Œå…¨é®æŒ¡ç•Œé¢
        if (color.includes('rgba')) {
            const parts = color.match(/rgba\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*([\d.]+)\s*\)/);
            if (parts && parts.length >= 5) {
                const r = parseInt(parts[1]);
                const g = parseInt(parts[2]);
                const b = parseInt(parts[3]);
                // åº”ç”¨å®‰å…¨çš„é€æ˜åº¦
                const safeAlpha = Math.min(parseFloat(parts[4]), this.MAX_OPACITY);
                overlay.style.backgroundColor = `rgba(${r}, ${g}, ${b}, ${safeAlpha})`;
            } else {
                overlay.style.backgroundColor = color;
            }
        } else {
            // å¯¹äºérgbaé¢œè‰²ï¼Œåº”ç”¨æœ€å¤§ä¸é€æ˜åº¦
            overlay.style.backgroundColor = color;
            overlay.style.opacity = this.MAX_OPACITY.toString();
        }
        
        return overlay;
    },
    
    // é€æ¸æ˜¾ç¤ºå…ƒç´ ï¼Œç¡®ä¿ä¸è¶…è¿‡æœ€å¤§é€æ˜åº¦
    fadeInSafely: function(element, duration = 1000, targetOpacity = 1.0) {
        if (!element || !element.style) return;
        
        // è®¡ç®—å®‰å…¨çš„ç›®æ ‡ä¸é€æ˜åº¦
        const safeTargetOpacity = Math.min(targetOpacity, this.MAX_OPACITY);
        
        // è®¾ç½®åˆå§‹çŠ¶æ€
        element.style.opacity = '0';
        
        // åº”ç”¨è¿‡æ¸¡æ•ˆæœ
        element.style.transition = `opacity ${duration}ms`;
        
        // å»¶è¿Ÿä¸€å¸§ï¼Œç¡®ä¿åˆå§‹ä¸é€æ˜åº¦è¢«åº”ç”¨
        setTimeout(() => {
            element.style.opacity = safeTargetOpacity.toString();
        }, 10);
        
        // è¿”å›åº”ç”¨çš„å®‰å…¨ä¸é€æ˜åº¦å€¼
        return safeTargetOpacity;
    }
};

// é›†æˆå¯è§åº¦æ§åˆ¶å™¨åˆ°å°–å«ä»ªç³»ç»Ÿ
function integrateVisibilityController() {
    console.log('æ­£åœ¨é›†æˆå¯è§åº¦æ§åˆ¶å™¨...');
    
    // æ›¿æ¢åŸæœ‰çš„ç‰¹æ•ˆå‡½æ•°
    if (typeof window.createMatrixEffect === 'function') {
        console.log('è¦†ç›– Matrix æ•ˆæœå‡½æ•°');
        window.originalCreateMatrixEffect = window.createMatrixEffect;
        window.createMatrixEffect = createMatrixEffect;
    }
    
    if (typeof window.createRainbowMode === 'function') {
        console.log('è¦†ç›–å½©è™¹æ¨¡å¼å‡½æ•°');
        window.originalCreateRainbowMode = window.createRainbowMode;
        window.createRainbowMode = createRainbowMode;
    }
    
    if (typeof window.showBigScreenText === 'function') {
        console.log('è¦†ç›–å…¨å±æ–‡å­—å‡½æ•°');
        window.originalShowBigScreenText = window.showBigScreenText;
        window.showBigScreenText = showBigScreenText;
    }
    
    if (typeof window.createExplosionEffect === 'function') {
        console.log('è¦†ç›–çˆ†ç‚¸æ•ˆæœå‡½æ•°');
        window.originalCreateExplosionEffect = window.createExplosionEffect;
        window.createExplosionEffect = createExplosionEffect;
    }
    
    if (typeof window.createFullscreenTextAnimation === 'function') {
        console.log('å¢å¼ºå…¨å±æ–‡å­—åŠ¨ç”»å‡½æ•°');
        // ä¿å­˜å¯¹åŸå§‹å‡½æ•°çš„å¼•ç”¨
        window.originalCreateFullscreenTextAnimation = window.createFullscreenTextAnimation;
        
        // æ›¿æ¢ä¸ºå¢å¼ºç‰ˆæœ¬ï¼Œç¡®ä¿ä½¿ç”¨åŸå§‹å¼•ç”¨é¿å…é€’å½’
        window.createFullscreenTextAnimation = function(intensity) {
            return enhancedCreateFullscreenTextAnimation(intensity);
        };
    }
    
    // ä¿®æ”¹ä»»ä½•ä½¿ç”¨ä¸é€æ˜åº¦çš„å‡½æ•°
    patchOpacityProperties();
    
    console.log('å¯è§åº¦æ§åˆ¶å™¨é›†æˆå®Œæˆ');
}

// ä¿®è¡¥å…¨å±è¦†ç›–å‡½æ•°ä¸­çš„ä¸é€æ˜åº¦å±æ€§
function patchOpacityProperties() {
    // æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½å…¨å±è¦†ç›–çš„å‡½æ•°å¹¶æ‰“è¡¥ä¸
    const functionsToCheck = [
        'showEmotionBurst',
        'createShockwaveRings',
        'createSmokeOverlay'
    ];
    
    functionsToCheck.forEach(funcName => {
        if (typeof window[funcName] === 'function') {
            console.log(`æ­£åœ¨ä¿®è¡¥ ${funcName} å‡½æ•°`);
            const originalFunc = window[funcName];
            
            window[funcName] = function() {
                // è°ƒç”¨åŸå§‹å‡½æ•°
                const result = originalFunc.apply(this, arguments);
                
                // æ‰¾åˆ°æ–°æ·»åŠ çš„å…¨å±å…ƒç´ 
                setTimeout(() => {
                    // æ£€æŸ¥æœ€è¿‘æ·»åŠ çš„å…¨å±å…ƒç´ 
                    const fullscreenElements = document.querySelectorAll('div[style*="position: fixed"][style*="width: 100%"][style*="height: 100%"]');
                    
                    fullscreenElements.forEach(element => {
                        // åªå¤„ç†æœ€è¿‘æ·»åŠ çš„å…ƒç´ 
                        if (element.style.zIndex >= 50) {
                            VisibilityController.applyVisibilityControl(element, parseFloat(element.style.opacity) || 1);
                        }
                    });
                }, 50);
                
                return result;
            };
        }
    });
}

// é€šç”¨å‡½æ•°ï¼Œç”¨äºå®‰å…¨åœ°è®¾ç½®å…ƒç´ ä¸é€æ˜åº¦
function setSafeOpacity(element, opacity) {
    if (!element || !element.style) return;
    return VisibilityController.applyVisibilityControl(element, opacity);
}

// ä¿®å¤ä»»ä½•æ·»åŠ çš„é»‘è‰²èƒŒæ™¯
function fixDarkBackgrounds() {
    // æŸ¥æ‰¾é¡µé¢ä¸Šçš„é»‘è‰²èƒŒæ™¯å±‚
    const darkLayers = document.querySelectorAll('div[style*="background-color: rgba(0, 0, 0,"]');
    darkLayers.forEach(layer => {
        VisibilityController.applyVisibilityControl(layer, parseFloat(layer.style.opacity) || 1);
    });
    
    // è¿˜è¦æ£€æŸ¥çº¯é»‘è‰²èƒŒæ™¯
    const blackLayers = document.querySelectorAll('div[style*="background-color: rgb(0, 0, 0)"]');
    blackLayers.forEach(layer => {
        VisibilityController.applyVisibilityControl(layer, parseFloat(layer.style.opacity) || 1);
    });
}

// æ¯ç§’æ£€æŸ¥ä¸€æ¬¡é»‘è‰²èƒŒæ™¯ï¼Œå¹¶ä¿®å¤
function startBackgroundMonitor() {
    setInterval(fixDarkBackgrounds, 1000);
}

// å¯¼å‡ºåˆ°å…¨å±€
window.VisibilityUtils = {
    setSafeOpacity,
    fixDarkBackgrounds,
    startBackgroundMonitor,
    integrateVisibilityController,
    createSafeOverlay
};

// è‡ªåŠ¨é›†æˆ
document.addEventListener('DOMContentLoaded', function() {
    // ç­‰å¾…é¡µé¢å’ŒVisibilityControlleråŠ è½½å®Œæˆ
    setTimeout(() => {
        if (window.VisibilityController) {
            integrateVisibilityController();
            startBackgroundMonitor();
            console.log('å¯è§åº¦æ§åˆ¶ç³»ç»Ÿå·²å¯åŠ¨');
        } else {
            console.warn('å¯è§åº¦æ§åˆ¶å™¨æœªæ‰¾åˆ°ï¼Œæ— æ³•é›†æˆ');
        }
    }, 1000);
});
        
// å¯¼å‡ºåˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨
window.VisibilityController = VisibilityController;
    </script>
</body>
</html>
